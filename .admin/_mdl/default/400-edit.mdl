sub BaseModul
{
	my $ID=$form{ID} if ($form{ID});
	my $archive="";
	$archive="_arch" if ($form{archive} eq "1");

	$form{title}=~s|<.*?>||g;
	$form{tiny}=~s|<.*?>||g;
	$form{subtitle}=~s|<.*?>||g;

	my $indexes;
	if ($form{set})
	{
		######################################################
		# saving / updating article block                                                #
		######################################################

		$HTML_HEADER{BODY}{extract}="yes";
		$form{year1}-=1900;
		$form{year2}-=1900;
		$form{mom1}--;
		$form{mom2}--;
		my $starttime=Time::Local::timelocal(undef,$form{min1},$form{hour1},$form{day1},$form{mom1},$form{year1},undef,undef,undef);
		my $endtime=Time::Local::timelocal(undef,$form{min2},$form{hour2},$form{day2},$form{mom2},$form{year2},undef,undef,undef);

		$full=&convert_html($form{full});

		my @image;#=split(',',$form{image});
		my $images=-1;
		#<img src="mdia markizaasjldkajskldjasd/0000/sdfsdfsdf-format.jpg" alt="alt" align="left" border=1 />
		my $img_data0;

		my $xrelated;

		######################################################
		# parsing out images                                                                #
		######################################################

		while ($full=~s|<img (.*?)(/\|)>|<IMGTO>|i)
		{
			my $var=$1;
			#$var=~s/\/$//;
			$img_data0=$1." ";

			$img_data0=~s|src="(.*?)"||i;
			my $img_src=$1;

			$img_src=~s|.*\/(.*?)-(.*?).jpg||i;
			$img_src=$1;
			my $img_format=$2;

			$img_data0=~s|alt="(.*?)"||i;
			my $img_alt=$1;

			$img_data0=~s|=(.*?) |="\1" |gi;
			#my $img_src=$1;
			$img_data0=~s|""|"|gi;

			my $img_data_others=$img_data0;

			#my $img_data1;
			my $nullid;
			#$img_data0=~s|id="(.*?)"||i;
			#my $img_src=$1;
			#return $img_src;
			#return $1."x".$2;
			if ($img_src=~s|/d||) # ak ide o regulerny odkaz na webe
			{
				#return "asds".$1;
				#obraztok je bohvie pre keru picu v numerickom formate
			}
			else
			{
				#return "nejaky pojebany hash ". $img_src;
				$images++;
				#my $img_dom=$1;
				#my $img_id=$2;
				#my $img_size=$3;
				$img_id++;$img_id--;
				$image[$images]=$img_id;
				#$nullid=sprintf ('%07d', $img_id);
				$db_micro1 = $main::DB{main}->Query("
					SELECT
						ID
					FROM
						a500
					WHERE
						hash='$img_src'
					LIMIT 1");
				if (@db_micro1_line=$db_micro1->FetchRow()) { $nullid=$db_micro1_line[0]; }
				$img_data0=" id=\"$nullid\" format=\"$img_format\"";
			}
			if (not $img_data_others=~/align/i){$img_data0.=" align=\"left\""}
			$img_data0.=" alt=\"$img_alt\"";
			#else # ide o nejaky podivny obrazok :-O, ktory nieje z databazy
			#{
			# $img_data0.=" src=\"$img_src\""; # vratim spet informaciu o SRC
			#}
			while($img_data0=~s|  | |g){};
			$full=~s|<IMGTO>|<my_a500 $img_data0 $img_data_others />|i;

			$xrelated.="<VAR id=\"a500\" value=\"$nullid\" />\n";
		}
		while ($form{xrelated}=~s|<VAR id=(.*?) value=(.*?) />||i)
		{
			$xrelated.="<VAR id=\"$1\" value=\"$2\" />";
		}

		######################################################
		# parsing out tables                                                                 #
		######################################################

		#$image_f.=join ",",@image;
		while ($full=~s|<TABLE id=(.*?)>.*?</TABLE>|<TABLETO>|i)
		{
		my $data=$1;
		$full=~s|<TABLETO>|<myTABLE id=$data>|;
		}

		$form{title}=~s|\'|\\'|g;
		$form{subtitle}=~s|\'|\\'|g;
		$form{tiny}=~s|\'|\\'|g;
		$full=~s|\'|\\'|g;
		#return "SELECT ID FROM a120 WHERE nickname='$form{author}' LIMIT 1";
		$db_micro1 = $main::DB{main}->Query("
			SELECT
				ID
			FROM
				a120
			WHERE
				nickname='$form{author}'
			LIMIT 1");
		if (@db_micro1_line=$db_micro1->FetchRow()){$form{IDauthor}=$db_micro1_line[0];}
		#return $form{IDauthor};
		#$db_micro1 = $main::DB{main}->Query("SELECT ID FROM a120 WHERE nickname='$form{editor}' LIMIT 1");

		######################################################
		# checking editor ID                                                                 #
		######################################################

		if (exists $form{IDeditor})
		{ }
		elsif ($form{IDeditor} eq "")
		{
			$db_micro_line{editor}="none";
		}


  #return "!".$form{IDeditor}."!";

  #return "UPDATE a400 SET starttime='$starttime',endtime='$endtime',lasttime=time,title='$form{title}',subtitle='$form{subtitle}',IDauthor='$form{IDauthor}',IDeditor='$form{IDeditor}',IDcategory='$form{IDcategory}',tiny='$form{tiny}',full='".$full."',xrelated='$xrelated' WHERE ID='$ID' LIMIT 1";


		my $updating;

		if ($ID)
		{ $updating="1"; }
		else
		{
			$db_micro1 = $main::DB{main}->Query("
				(
					SELECT
						ID
					FROM
						a400
				)
				UNION ALL
				(
					SELECT
						ID
					FROM
						a400_arch
				)
				ORDER BY
					ID DESC
				LIMIT 1
			");
			if (@db_micro1_line=$db_micro1->FetchRow()) { $ID=$db_micro1_line[0]; }
			$ID++;
			$main::DB{main}->Query("
				INSERT INTO
					a400$archive
				(ID,IDattrs,starttime,endtime,changetime,title,subtitle,IDauthor,IDeditor,IDcategory,tiny,full,xrelated,lng,active)
				VALUES
				($ID,'','','','','','','','','','','','','','')
			");
		}

		######################################################
		# forum routines                                                                       #
		######################################################

		my $FORUM;
		if (exists $form{allow_forum})
		{
			my $bazmek;
			my $q1,$q2,$q3;
			if ($form{allow_forum} eq "x")
			{
				our @WCHAR=qw/0 1 2 3 4 5 6 7 8 9 A B C D E F G H I J K L M N O P Q R S T U V W X Y Z a b c d e f g h i j k l m n o p q r s t u v w x y z/;
				#article forum does not exist, probably adding a new article; inserting a new article forum, inserting into xrelated of the article
				$db_micro1 = $main::DB{main}->Query("
					SELECT
						DISTINCT ID
					FROM
						a820
					WHERE
						substring(ID,1,6)='00a400'
						AND type='F'
					GROUP BY
						ID
					ORDER BY
						ID ASC
				");
				if($db_micro1->NumRows())
				{
					while (@db_micro1_line=$db_micro1->FetchRow())
					{
						$FORUM=sprintf("00a400%1s%1s%1s",$WCHAR[$q1],$WCHAR[$q2],$WCHAR[$q3]);

						if ($FORUM ne $db_micro1_line[0]) {$bazmek=$FORUM; last; }

						$q3++;
						if ($q3>61)
						{
							$q3=0;
							$q2++;
							if ($q2>61)
							{
								$q2=0;
								$q1++;
							}
						}
					}
					if ($bazmek ne $FORUM)
					{
						$q3++;
						if ($q3>61)
						{
							$q3=0;
							$q2++;
							if ($q2>61)
							{
								$q2=0;
								$q1++;
							}
						}
						$FORUM=sprintf("00a400%1s%1s%1s",$WCHAR[$q1],$WCHAR[$q2],$WCHAR[$q3]);
					}
				}
				else{$FORUM=sprintf("00a400%1s%1s%1s",$WCHAR[$q1],$WCHAR[$q2],$WCHAR[$q3]);} #neexistuje ani jeden zaznam v db 820, vytvaram prvy zaznam s nulovym id

				$db_micro1 = $main::DB{main}->Query("
					SELECT
						IDattrs
					FROM
						a820_attrs
					ORDER BY
						IDattrs DESC
					LIMIT 1
				");

				if (@db_micro1_line=$db_micro1->FetchRow())
				{
					$cnt = $db_micro1_line[0];
					$cnt++;
				}
				else{$cnt=1;}

				if (!$form{allow_forum_val})
				{
					$main::DB{main}->Query("
						INSERT INTO
							a820
						(ID,IDattrs,name,about,type,messages,xrelated,xdata,lng,active,inserttime,lasttime,createtime)
						VALUES
							('$FORUM','$cnt','$form{title}','$form{tiny}','F','0','<VAR id=\"a400\" value=\"$ID\" />','','sk','Y','".time."','".time."','".time."')
					");
					$main::DB{main}->Query("
						INSERT INTO
							a820_attrs
						(IDattrs)
						VALUES
							('$cnt')
					");
					$FORUM="<VAR id=\"a820\" value=\"$FORUM\" />";
				}
				else
				{
					$FORUM="<VAR id=\"a820\" value=\"$form{allow_forum_val}\" />";
				}
			}
			else
			{
				if (($form{allow_forum} ne $form{allow_forum_val}) && ($form{allow_forum_val})) { $form{allow_forum} = $form{allow_forum_val}; }

				$FORUM="<VAR id=\"a820\" value=\"$form{allow_forum}\" />";
				#article forum does exist, reinserting into xrelated of the article
			}
		}
		else
		{
			if ($form{allow_forum_val} ne "")
			{
				$db_micro1 = $main::DB{main}->Query("SELECT xrelated FROM a820 WHERE ID='$form{allow_forum_val}' LIMIT 1");
				if (@db_micro1_line=$db_micro1->FetchRow())
				{
					$db_micro1_line[0]=~s|<VAR id=\"a400\" value=\"$ID\" />||s;
					$main::DB{main}->Query("UPDATE a820 SET xrelated='$db_micro1_line[0]' WHERE ID='$form{allow_forum_val}' LIMIT 1");
				}
			}
		}



		######################################################
		# sutaz form implementation                                                      #
		######################################################

		if(($form{allow_sutaz_val} ne "")&&($form{allow_sutaz} eq "1"))
		{
			$xrelated=~s|<VAR id="_append_form" value="(.*?)" />||ig;
			$xrelated=~s|<VAR id="_append_form_email" value="(.*?)" />||ig;
			$xrelated.="<VAR id=\"_append_form\" value=\"1\" />";
			$xrelated.="<VAR id=\"_append_form_email\" value=\"$form{allow_sutaz_val}\" />";
		}
		else
		{
			$xrelated=~s|<VAR id="_append_form" value="(.*?)" />||ig;
			$xrelated=~s|<VAR id="_append_form_email" value="(.*?)" />||ig;
		}


		#exchanging internal links
		#  while ($full=~s|<A href="article_view=(.*?)">(.*?)</A>|<my_a400 id="$1" value="$2" />|i)
		#  {
		#   if (not $xrelated=~/<VAR id="a400" value="$1"/) { $xrelated.="<VAR id=\"a400\" value=\"$1\" />"; }
		#  }

		######################################################
		# parsing out internal article links                                               #
		######################################################

		while ($full=~s/<A href="http:\/\/article_view=(.*?)(\/|)">(.*?)<\/A>/<my_a400 id="$1" value="$3" \/>/i)
		{
			if (not $xrelated=~/<VAR id="a400" value="$1"/) { $xrelated.="<VAR id=\"a400\" value=\"$1\" />"; }
		}

		######################################################
		# saving / updating article                                                        #
		######################################################

		if ($updating eq "1")
		{
			#return "UPDATE a400$archive SET $endtime starttime='$starttime',changetime='".time."',title='$form{title}',subtitle='$form{subtitle}',IDauthor='$form{IDauthor}',IDeditor='$form{IDeditor}',IDcategory='$form{IDcategory}',tiny='$form{tiny}',full='".$full."',xrelated='$FORUM$xrelated' WHERE ID='$ID' LIMIT 1"

			&save_log(1,"Updating story id=$ID $form{title}");
			if (exists $form{allow_endtime}) {$endtime="endtime='$endtime',";} else {$endtime="endtime='0',";}
			#return "UPDATE a400$archive SET $endtime starttime='$starttime',changetime='".time."',title='$form{title}',subtitle='$form{subtitle}',IDauthor='$form{IDauthor}',IDeditor='$form{IDeditor}',IDcategory='$form{IDcategory}',tiny='$form{tiny}',full='".$full."',xrelated='$FORUM$xrelated' WHERE ID='$ID' LIMIT 1";
			$main::DB{main}->Query("UPDATE a400$archive SET $endtime starttime='$starttime',changetime='".time."',title='$form{title}',subtitle='$form{subtitle}',IDauthor='$form{IDauthor}',IDeditor='$form{IDeditor}',IDcategory='$form{IDcategory}',tiny='$form{tiny}',full='".$full."',xrelated='$FORUM$xrelated' WHERE ID='$ID' LIMIT 1");

			if (exists $form{allow_forum})
			{
				if ($form{allow_forum} ne "x") { $main::DB{main}->Query("UPDATE a820 (name,about) SET ('$form{title}','$form{tiny}') WHERE ID='$form{allow_forum}'"); }
			}
			$main::DB{main}->Query("INSERT INTO a400_attrs$archive (IDattrs,visits_index7day) VALUES ('$ID','0')");
		}
		else
		{
			#return "Inserting story id=$ID $form{title}";
			#return "INSERT INTO a400
			#(ID,IDattrs, starttime,endtime,lasttime,title,subtitle,IDauthor,IDeditor,IDcategory,tiny,full,xrelated,lng,active) VALUES
			#('$ID','$ID','$starttime','$endtime', '".time."','$form{title}','$form{subtitle}','$form{IDauthor}','$form{IDeditor}','$form{IDcategory}','$form{tiny}','".$full."','$xrelated','sk','N')";
			if (exists $form{allow_endtime}) { } else {$endtime="0";}
			#&save_log(1,"Inserting story $form{title}");

			$main::DB{main}->Query("UPDATE a400$archive SET   IDattrs='$ID',starttime='$starttime',endtime='$endtime',changetime='".time."',title='$form{title}',subtitle='$form{subtitle}',IDauthor='$form{IDauthor}',IDeditor='$form{IDeditor}',IDcategory='$form{IDcategory}',tiny='$form{tiny}',full='".$full."',xrelated='$FORUM$xrelated',lng='sk',active='N' WHERE ID='$ID' LIMIT 1");
			$main::DB{main}->Query("INSERT INTO a400_attrs$archive (IDattrs,visits_index7day) VALUES ('$ID','0')");
		}

		return "\n<script>\nparent.document.frames['frm_base'].location.reload();\n</script>";

		#----- end of saving / updating article block
	}
	else
	{
		######################################################
		# creating article box                                                                #
		######################################################

		$HTML_HEADER{BODY}{extract}="yes";
		#$HTML_HEADER{BODY}{onunload}="parent.box_loading.style.display='block';";


		if (defined $ID)
		{
			$db_micro = $main::DB{main}->Query("SELECT ID,starttime,endtime,title,subtitle,IDauthor,IDeditor,IDcategory,tiny,full,xrelated,xdata FROM a400$archive WHERE ID='$ID' LIMIT 1");
			%db_micro_line=$db_micro->FetchHash();
			#return $db_micro_line{title};
			&save_log(1,"Editing article id=$ID $db_micro_line{title}");
			@image=split(',',$db_micro_line{xrelated});
			(undef,$minR1,$hourR1,$mdayR1,$momR1,$yearR1,undef,undef,undef) = localtime($db_micro_line{starttime});
			(undef,$minR2,$hourR2,$mdayR2,$momR2,$yearR2,undef,undef,undef) = localtime($db_micro_line{endtime});
		}
		else
		{
			&save_log(1,"Editing new article");
			#(undef,$minR1,$hourR1,$mdayR1,$momR1,$yearR1,undef,undef,undef) = localtime($current_time+(3600));
			(undef,$minR1,$hourR1,$mdayR1,$momR1,$yearR1,undef,undef,undef) = localtime($current_time);
			(undef,$minR2,$hourR2,$mdayR2,$momR2,$yearR2,undef,undef,undef) = localtime($current_time+(3600));
		}

		$momR1++;$yearR1=$yearR1+1900;
		$momR2++;$yearR2=$yearR2+1900;


		#action="core.pl?type=$form{type}&id=$ID&set=yes&image=$db_micro_line{xrelated}" method="POST"  target="frm_micro">
		my $archive="";
		$archive="&archive=1" if ($form{archive} eq "1");

		my $mdl_temp=<<"HEADER";
  <form name="articleEdit\_$ID" action="core.pl?type=$form{type}$archive&ID=$ID&set=yes" method="POST" enctype="multipart/x-form-data" target="frm_micro">
HEADER

		$archive="_arch" if ($form{archive} eq "&archive=1");

#  my $mdl_temp=<<"HEADER";
#  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td>
#  <form name="articleEdit\_$ID" action="core.pl?type=$form{type}&id=$ID&set=yes" method="POST" enctype="multipart/x-form-data" target="frm_micro">
#  </td><td width=100% style="FONT:10px Verdana;COLOR:white;">
#HEADER

#  <form name="$form{type}\_$ID" action="core.pl?type=$form{type}&id=$ID&set=yes&image=$db_micro_line{xrelated}" method="POST" enctype="multipart/x-form-data" target="frm_micro">




#&nbsp;Definition:<BR>
#my $mdl_micro_test.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$db_micro_line[3]';\">&nbsp;$db_micro_line[3]</div>\n";
#my   $mdl_micro_test.=&select_add('value'=>"task",'html'=>"task");
#   $mdl_micro_test.=&select_add('value'=>"report",'html'=>"report");
#   $mdl_micro_test.=&select_add('value'=>"query",'html'=>"query");
#   $mdl_micro_test.=&select_add('value'=>"meeting",'html'=>"meeting");
#   $mdl_micro_test.=&select_add('value'=>"phonecall",'html'=>"phonecall");
#   $mdl_micro_test.=&select_add('value'=>"email",'html'=>"email");
#
# $mdl_temp.=&select_create(
#	'name'		=>	"title",
#	'value'		=>	$db_micro_line[3],
#	'maxlength'	=>	30,
#	'width'		=>	250,
#	'height'	=>	150,
#	'drag_resizeX'	=>	'-150',
#	'select'	=>	$mdl_micro_test
# );

		$mdl_temp.=<<"HEADER";
  &nbsp;Titul:<BR>
  <input type=text name="title" class="long" value="$db_micro_line{title}" maxlength=160 drag_resizeX='0'><BR>
  &nbsp;Podtitul:<BR>
  <input type=text name="subtitle" class="long" value="$db_micro_line{subtitle}" maxlength=160 drag_resizeX='0'><BR>
  <table cellspacing=0 cellpadding=0 border=0 width=100% class="in-box">
   <tr>
    <td>
     &nbsp;Autor:<BR>
    </td>
    <td>
     &nbsp;Editor:<BR>
    </td>
   </tr>
   <tr>
    <td>
HEADER

		my $mdl_micro;
		$db_micro1 = $main::DB{main}->Query("SELECT nickname FROM a120 ORDER BY nickname");
		while (@db_micro1_line=$db_micro1->FetchRow())
		{
			#$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[0]';\">&nbsp;$db_micro1_line[0]</div>\n";
			$mdl_micro.=&select_add('value'=>$db_micro1_line[0],'html'=>$db_micro1_line[0]);
		}
		$db_micro1 = $main::DB{main}->Query("SELECT nickname FROM a120 WHERE ID='$db_micro_line{IDauthor}'");
		if (@db_micro1_line=$db_micro1->FetchRow()){$db_micro_line{IDauthor}=$db_micro1_line[0];}
		$mdl_temp.=&select_create(
			'name'		=>	"author",
			'value'		=>	$db_micro_line{IDauthor},
			'maxlength'	=>	30,
			'width'		=>	250,
			'height'	=>	200,
			'drag_resizeX'	=>	'-150',
			'select'	=>	$mdl_micro
		);

	#return "SELECT nickname FROM a120 WHERE ID='$db_micro_line{IDeditor}'";

	#$db_micro1 = $main::DB{main}->Query("SELECT nickname FROM a120 WHERE ID='$db_micro_line{IDeditor}'");
	#if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{editor}=$db_micro1_line[0]; }
	#elsif


		$mdl_temp.="</td><td>";

		$db_micro1 = $main::DB{main}->Query("SELECT ID FROM a120 WHERE nickname='$ENV{REMOTE_USER}' AND IDtype='1'");
		if (@db_micro1_line=$db_micro1->FetchRow())
		{ $db_micro_line{IDeditor}=$db_micro1_line[0]; }
		else
		{
			$db_micro1 = $main::DB{main}->Query("
				INSERT INTO a120
					(IDtype,nickname,fullname,active)
				VALUES
					('1','$ENV{REMOTE_USER}','$ENV{REMOTE_USER}','Y')
			");
			$db_micro1 = $main::DB{main}->Query("
				SELECT
					ID
				FROM
					a120
				WHERE
					nickname='$ENV{REMOTE_USER}'
					AND IDtype='1'
			");
			if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{IDeditor}=$db_micro1_line[0]; }
		}


		if ($db_micro_line{IDeditor}){$mdl_temp.="<input name=\"IDeditor\" type=text value=\"$db_micro_line{IDeditor}\" readonly class=input0 style=\"width:90%;\" drag_resizeX='0'><br>";}
		else {$mdl_temp.="<input name=\"IDeditor\" type=text value=\"$form{editor}\" readonly class=input0 style=\"width:90%;\" drag_resizeX='0'><br>";}

		$mdl_temp.="</td></tr></table>&nbsp;Keywords:<BR>";
		$mdl_temp.="<input type=text value=\"\" name=\"keywords\" readonly drag_resizeX='0'><br>";
=head1
  $db_micro1 = $main::DB{main}->Query("SELECT nickname FROM a120 ORDER BY nickname");
  while (@db_micro1_line=$db_micro1->FetchRow())
  {
   #$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[0]';\">&nbsp;$db_micro1_line[0]</div>\n";
   $mdl_micro.=&select_add('value'=>$db_micro1_line[0],'html'=>$db_micro1_line[0]);
  }
  $db_micro1 = $main::DB{main}->Query("SELECT nickname FROM a120 WHERE ID='$db_micro_line{IDeditor}'");
  if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{IDeditor}=$db_micro1_line[0]; }
  $mdl_temp.=&select_create(
 	'name'		=>	"editor",
	'value'		=>	$db_micro_line{IDeditor},
	'maxlength'	=>	30,
	'width'		=>	250,
	'height'	=>	200,
	'drag_resizeX'	=>	'-150',
	'select'	=>	$mdl_micro
  );
=cut
		######################################################
		# creating category dropdown                                                    #
		######################################################

		$mdl_temp.="&nbsp;Kategória:";


		my $mdl_micro;
		my $selected;
		my $selected2;
		my $index_counter=0;
		#return "SELECT ID,name FROM a400_category ORDER BY ID";
		$db_micro1 = $main::DB{main}->Query("
			SELECT
				ID,
				name
			FROM
				a400_category
			ORDER BY ID
		");
		while (@db_micro1_line=$db_micro1->FetchRow())
		{
			$indexes.="<option value=\"<VAR id=0 value=4864 description=haluza, aksjd aksj skldfj lskdf />\" onDblClick=\"relate_item('a020','$ID;0')\">";
			for (my $i=1; $i< length($db_micro1_line[0])/2; $i++)
			{ $indexes.="-"; }
			$indexes.="$db_micro1_line[1]</option>\n";
			$index_counter++;
			#my $from;
			#for (my $i=1;$i<length($db_micro1_line[0]);$i++){$from.="&nbsp;&nbsp;";}
			#if ($db_micro_line{IDcategory} eq $db_micro1_line[0]){$selected=$db_micro1_line[1];$selected2=$db_micro1_line[0];}
			#$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE2'].value='$db_micro1_line[0]';this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[1]';\">&nbsp;$from$db_micro1_line[2]</div>\n";

			#$mdl_micro.=&select_add('value'=>$db_micro1_line[1],'html'=>$from.$db_micro1_line[2],'plus'=>"this.parentElement.parentElement.all['VALUE2'].value='$db_micro1_line[0]';");
		}
		# $mdl_temp.=&select_create(
		# 	'name'		=>	"IDcathegory_",
		#	'plus'		=>	"<input id=VALUE2 value=\"$selected2\" name=IDcathegory2 type=hidden>",
		#	'value'		=>	$selected,
		#	'maxlength'	=>	30,
		#	'width'		=>	445-13,
		#	'select'	=>	$mdl_micro
		# );


		my $tree_temp;
=head1
  my $tree_temp_line=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0>
    <tr>
     <%OD%>
     <td><img src=t.gif width=3 height=1 border=0><BR></td>
     <td nowrap style="FONT:bold 11px Verdana;"></td>
	 <td width=100% style="FONT:9px Verdana;"
	 	onmouseover="this.style.background='blue';this.style.color='white';"
		onmouseout="this.style.background='';this.style.color='';"
		<%PLUS%>
	 ><%NAME%></td>
 	</tr>
  </table>
HEADER
=cut
		my $tree_temp_od="-";
		my $selected;
		my $selected2;
		my $db_micro1 = $main::DB{main}->Query("
			SELECT
				ID,
				name,
				xdata
			FROM a400_category
			ORDER BY ID
		");
		while (@db_micro1_line=$db_micro1->FetchRow())
		{
			$od="";
			for (my $i=1; $i< length($db_micro1_line[0])/2; $i++)
			{
				if ($i+1<length($db_micro1_line[0])/2) {$od.="&nbsp;&nbsp;&nbsp;";} else {$od.="&nbsp;'-";}
			}
			$od.="<img src=\"$tom::H_media/grf/admin/tree_0.gif\" border=0>&nbsp;";
			#$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[0]';\">&nbsp;$db_micro1_line[0]</div>\n";
			#$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE2'].value='$db_micro1_line[0]';this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[1]';\">&nbsp;$from$db_micro1_line[2]</div>\n";
			$mdl_micro.=&select_add('value'=>$db_micro1_line[1],'html'=>$od.$db_micro1_line[1],'plus'=>"this.parentElement.parentElement.all['VALUE2'].value='$db_micro1_line[0]';this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[1]';");
		}
		$db_micro1 = $main::DB{main}->Query("SELECT name FROM a400_category WHERE ID='$db_micro_line{IDcategory}'");
		if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{category_name}=$db_micro1_line[0]; }
		$mdl_temp.=&select_create(
			'name'		=>	"category",
			'value'		=>	$db_micro_line{category_name},
			'plus'             =>   "<input id=VALUE2 value=\"$db_micro_line{IDcategory}\" name=IDcategory type=hidden>",
			'maxlength'	=>	30,
			'width'		=>	250,
			'height'	=>	200,
			'drag_resizeX'	=>	'-150',
			'select'	=>	$mdl_micro
		);

		# $mdl_temp.="a<BR>".$tree_temp."a<BR>";

		# POCET TD JE 16

		$mdl_temp.="<table width=100% cellspacing=0 cellpadding=0 border=0><tr><td colspan=\"3\">";


		######################################################
		# creating forum dropdown                                                        #
		######################################################

		my $allow_forum;
		my $forum_id;


		if ($db_micro_line{xrelated}=~s|<VAR id="a820" value="(.*?)" />||i)
		{
			$allow_forum="checked";
			$forum_ID=$1;
		}
		elsif (not $ID)
		{
			$allow_forum="checked";
		}

		if (not $forum_id) { $forum_ID="x"; }

		my $forum_id_val;
		if ($forum_id ne "x") { $forum_id_val = $forum_id; } else { $forum_id_val = ""; }

		#$mdl_temp.="</tr></table></td><td style=\"FONT:10px Verdana;COLOR:white;\" width=\"50%\">Forum:<br>";
		#$mdl_temp.="<input type=\"checkbox\" name=\"allow_forum\" value=\"$forum_id\" $allow_forum onclick=\"if (this.checked) {document.getElementById('allow_forum_val').style.display='inline';} else {document.getElementById('allow_forum_val').style.display='none'; }\"> Priradiť fórum <input type=\"text\" name=\"allow_forum_val\" id=\"allow_forum_val\" size=\"10\" value=\"$forum_id_val\" style=\"border: 1px black solid;\">";

		$mdl_temp.="<input type=\"checkbox\" class=\"chkbox\" name=\"allow_forum\" value=\"$forum_id\" $allow_forum onclick=\"if (this.checked) {document.getElementById('allow_forum_val').style.display='inline';} else {document.getElementById('allow_forum_val').style.display='none'; }\"> Priradiť fórum <div id=\"allow_forum_val\">";

		my $mdl_micro;
		$db_micro1 = $main::DB{main}->Query("SELECT ID,name FROM a820 WHERE ID LIKE '00a002%' AND type='F' ORDER BY ID DESC LIMIT 10");
  	if($db_micro1)
		{
			while (@db_micro1_line=$db_micro1->FetchRow())
			{
				#$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[0]';\">&nbsp;$db_micro1_line[0]</div>\n";
				$mdl_micro.=&select_add('value'=>$db_micro1_line[0],'html'=>$db_micro1_line[1]);
			}
			#$db_micro1 = $main::DB{main}->Query("SELECT nickname FROM a120 WHERE ID='$db_micro_line{IDauthor}'");
			if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{IDauthor}=$db_micro1_line[0]; }
			$mdl_temp.=&select_create(
				'name'		=>	"allow_forum_val",
				'value'		=>	$forum_id_val,
				'maxlength'	=>	30,
				'width'		=>	250,
				'height'	=>	200,
				'drag_resizeX'	=>	'-150',
				'select'	=>	$mdl_micro
			);
		}

		######################################################
		# creating starttime dropdown                                                    #
		######################################################

		$mdl_temp.="<table cellspacing=2 cellpadding=0 border=0><tr><td width=\"50%\">&nbsp;Zverejniť od:<br></td><td>Do:</td><td width=\"50%\">&nbsp;</td></tr><tr>";
		$mdl_temp.="<td valign=\"top\"><table cellspacing=2 cellpadding=0 border=0><tr>";

		my $width0=30-12;
		my $width1=50-12;

		my $mdl_micro;
		for (my $i=1;$i<=31;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"day1",
			'value'		=>	$mdayR1,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		my $mdl_micro;
		@mesiac=("january","february","march","april","may","june","july","august","september","october","november","december");
		for (my $i=1;$i<=12;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i-$mesiac[$i-1]</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"mom1",
			'value'		=>	$momR1,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	90,
			'select'	=>	$mdl_micro
		)."</td>";

		my $mdl_micro;
		for (my $i=2000;$i<=2050;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"year1",
			'value'		=>	$yearR1,
			'maxlength'	=>	30,
			'width'		=>	$width1,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";


		$mdl_temp.="<td>&nbsp;</td>";


		my $mdl_micro;
		for (my $i=0;$i<=23;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"hour1",
			'value'		=>	$hourR1,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		$mdl_temp.="<td></td>";

		my $mdl_micro;
		for (my $i=0;$i<=55;$i=$i+5)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"min1",
			'value'		=>	$minR1,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		if (exists $form{ID})
		{
			if ($db_micro_line{endtime} eq "0") { $allow_endtime=""; $allow_endtime_show="none"; } else { $allow_endtime="checked"; $allow_endtime_show="normal"; }
		}
		else
		{
			$allow_endtime=""; $allow_endtime_show="none";
		}

		$mdl_temp.="</tr></table><td><input type=\"checkbox\" class=\"chkbox\" name=\"allow_endtime\" value=\"1\" onclick=\"if (this.checked) {document.getElementById('allow_endtime_div').style.display='block';} else {document.getElementById('allow_endtime_div').style.display='none'; }\" $allow_endtime></td>";
		$mdl_temp.="<td valign=\"top\"><div id=\"allow_endtime_div\" style=\"display: $allow_endtime_show\"><table cellspacing=2 cellpadding=0 border=0><tr>";

		######################################################
		# creating starttime dropdown                                                    #
		######################################################

		my $mdl_micro;
		for (my $i=1;$i<=31;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"day2",
			'value'		=>	$mdayR2,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		my $mdl_micro;
		@mesiac=("january","february","march","april","may","june","july","august","september","october","november","december");
		for (my $i=1;$i<=12;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i-$mesiac[$i-1]</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"mom2",
			'value'		=>	$momR2,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	90,
			'select'	=>	$mdl_micro
		)."</td>";

		my $mdl_micro;
		for (my $i=2000;$i<=2050;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"year2",
			'value'		=>	$yearR2,
			'maxlength'	=>	30,
			'width'		=>	$width1,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		$mdl_temp.="<td>&nbsp;</td>";

		my $mdl_micro;
		for (my $i=0;$i<=23;$i++)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"hour2",
			'value'		=>	$hourR2,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		$mdl_temp.="<td></td>";

		my $mdl_micro;
		for (my $i=0;$i<=55;$i=$i+5)
		{
			$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
		}
		$mdl_temp.="<td>".&select_create(
			'name'		=>	"min2",
			'value'		=>	$minR2,
			'maxlength'	=>	30,
			'width'		=>	$width0,
			'width1'	=>	50,
			'select'	=>	$mdl_micro
		)."</td>";

		$mdl_temp.="</tr></table></div></td></table>";

		$full=$db_micro_line{full};
		$full=~s|<myNEWPAGE>|<hr paging='1' style='height:6px;background:blue;'>|gi;

# if (($image[0])&&(not $full=~/^<myIMG/i))
# {
#  $full="<myIMG src=\"$tom::H_500/$image[0]-t.jpg\">".$full;
# }

		$full=~s|\n|<BR>|g;
		$full=~s|<DIV>||gi;
		$full=~s|</DIV>||gi;
		if (not $full=~/^<DIV>/i){$full="<DIV>".$full."</DIV>";}


		######################################################
		# converting image placeholders                                                 #
		######################################################

		my $images=-1;
		while ($full=~s|<my_a500(.*?)/>|<myIMGTO>|i)
		{
			my $img_data1=$1;
			my $nullid;

			$img_data1=~s|id="(.*?)"||i;
			my $img_src=$1;

			my $img_format;

			if ($img_data1=~s|format="(.*?)"||i)
			{ $img_format=$1; } else { $img_format="t"; }

			my $img_vselico=$img_data1;

			#if ($img_data0=~s|id="(.*?)"||i){$img_src=$1}
			if (!$img_src)
			{
				$images++;
				$img_id=$image[$images];
				$nullid=sprintf('%07d',$img_src);
				$img_data1="src=\"$tom::H_500/$nullid-$img_format.jpg\"";
			}
			elsif ($img_src=~s|(\d+)||) # ak ide o regulerny odkaz na webe
			{
				$images++;
				my $img_dom=$1;
				my $img_id=$2;
				#my $img_size=$3;
				$img_format="t" unless $img_format;
				$img_id++;$img_id--;
				if ($image[$images])
				{
					$img_id=$image[$images];
				}
				else
				{
					$image[$images]=$img_id;
				}
				$nullid=sprintf('%07d',$1);

				$nullid=~/^(....)/i;
				my $var=$1;

				#return "SELECT hash FROM a500 WHERE ID='$nullid' AND format='$img_size' LIMIT 1";
				$db_micro1 = $main::DB{main}->Query("SELECT hash FROM a500 WHERE ID='$nullid' AND format='$img_format' LIMIT 1");
				if (@db_micro1_line=$db_micro1->FetchRow()) { $nullid=$db_micro1_line[0]; }

				#return "SELECT hash FROM a500 WHERE ID='$nullid' AND format='$img_size' LIMIT 1";

				$img_data1="src=\"$tom::H_500/$var/$nullid-$img_format.jpg\"";
			}
			else # ide o nejaky podivny obrazok :-O, ktory nieje z databazy
			{
				$img_data1=$img_data0." src=\"$img_format\"";

				$db_micro1 = $main::DB{main}->Query("
					SELECT
						hash
					FROM a500
					WHERE
						ID='$nullid'
						AND format='$img_format'
				");
				if (@db_micro1_line=$db_micro1->FetchRow())
				{
					$img_data1=~s|$nullid|$db_micro1_line[0]|i;
				}
			}
			if (not $img_data0=~/align/i){$img_data0.="align=left"}
			$img_format="t" unless $img_format;

		$full=~s|<myIMGTO>|<img $img_data1 $img_vselico/>|i;
	}
	$image_f.=join ",",@image;

	$db_micro_line{xrelated}=~s|<VAR id="a500" value="(.*?)" />||gi;

	$db_micro_line{xrelated}=~s|"||gi;


		######################################################
		# converting table placeholders                                                 #
		######################################################

	while ($full=~s|<myTABLE(.*?)>|<thisTABLE>|i)
	{
		my $tag=$1;
		$tag=~s|id=(.*?) ||;
		my $ID=$1;

		my $align="left";
		if ($tag=~s|align=(.*?) ||)
		{
			$align=$1;
		}
			my $db0 = $main::DB{main}->Query("
				SELECT
					ID,
					title,
					variables
				FROM
					tabulky
				WHERE
					ID='$ID'
				LIMIT 1
			");
			if (my @db0_line=$db0->FetchRow())
			{
				my $mdl0_temp="<table id=$ID align=$align cellspacing=1 cellpadding=1 border=0 bgcolor=black><%LINE0%><%LINES%></table>";
				my $mdl0_temp_line0="<tr><td colspan=<%TD%> bgcolor=\"#4B5398\" style=\"FONT:bold 12px Arial;\"><font color=white><%NAME%></font></td></tr><tr><%TD%></tr>";

				$db0_line[2]=~s|^(.*?)\n||;
				my $line=$1;
				my @ref=split(';',$line);
				my $td=@ref;
				$mdl0_temp=~s|<%LINE0%>|$mdl0_temp_line0|;
				$mdl0_temp=~s|<%TD%>|$td|;
				$mdl0_temp=~s|<%NAME%>|$db0_line[1]|;
				for (0..$td-1)
				{
					$mdl0_temp=~s|<%TD%>|<td bgcolor="#A0A0C0" style="FONT:bold 11px Verdana;">$ref[$_]</td><%TD%>|;
				}
				$mdl0_temp=~s|<%TD%>||;

				for my $line(split('\n',$db0_line[2]))
				{
					$mdl0_temp=~s|<%LINES%>|<tr><%TD%></tr><%LINES%>|;
					my $td;
					for (split(';',$line))
					{
						my $plus="bgcolor=\"#E0E0E0\"";
						$plus="bgcolor=\"#A0A0C0\"" if (!$td);
						$td++;
						$mdl0_temp=~s|<%TD%>|<td $plus style="FONT:10px Verdana;">$_</td><%TD%>|;
					}
					$mdl0_temp=~s|<%TD%>||;
				}
				$mdl0_temp=~s|<%LINES%>||;
				$mdl0_temp=~s|<%.*?%>||g;
				$full=~s|<thisTABLE>|$mdl0_temp|;
			}
			$full=~s|<thisTABLE>||;
		}


		######################################################
		# converting internal links                                                          #
		######################################################

		while ($full=~s|<my_a400 id="(.*?)" value="(.*?)" />|<A href="http://article_view=$1">$2</A>|i)
		{
			#$xrelated.="<VAR id=\"a400\" value=\"$1\" />";
		}

		$mdl_temp.=<<"HEADER";
  <textarea drag_resizeX='0' name="tiny">$db_micro_line{tiny}</textarea><BR>
 	<div class="btn-bar" style="background: url($tom::H_media/grf/admin/win_top_0_back.gif);">
		<img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0>
		<input type=button value="skopíruj z Editora+" class="btn" onclick="document.articleEdit\_$ID.full.value=edit.innerHTML;">
		<input type=button value="skopíruj do Editora+" class="btn" onclick="edit.innerHTML=document.articleEdit_$ID.full.value">
		<img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0>
	</div>
  <textarea drag_resizeX='0' drag_resizeY='-300' name="full">$full</textarea><BR>
  Súvisiace články, video, audio:<br/>
  <input type=text name="xrelated" id="a400_xrelated_$db_micro_line{ID}" style="width:445px;" drag_resizeX='0' value="$db_micro_line{xrelated}"><br>
  <table cellspacing="0" cellpadding="0" border="0" width="100%">
  	<tr>
  		<td>
  			Dostupné kategórie:<br>
  			<select name="links_choice" border="0" size="5" onDblClick="link_article($ID);" style="width: 100%; padding-top: 3px; border: 1px black solid;">$indexes</select>
  		</td>
  		<td>
  			Vytvoriť linky v týchto kategóriách:<br>
  			<select name="links" border="0" size="5" onDblClick="unlink_article($ID);" style="width: 100%; padding-top: 3px; border: 1px black solid;"></select>
  		</td>
  	</tr>
  </table>
  Interný link:<br />
	<input type=text class="long" readonly value="http://article_view=$ID" drag_resizeX='0'>
	<div class="btn-bar" style="background: url($tom::H_media/grf/admin/win_top_0_back.gif);"><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><input type=submit drag_here value="Uložiť!" class="btn" onclick="box_erase2();"><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0></div>
HEADER
#<!-- <input type=hidden name=image value="$image_f"> /-->

		$mdl_temp.="</td><td></form>";
		$mdl_temp.="<script>var lastOpenedArticleId=\"$db_micro_line{ID}\";</script>";
		my $box=&article_box_create("Vloženie/úprava článku",
			'color_base0'	=>	"#0B63F1",
			'width'			=>	200,
			'height'		=>	50,
			'close'			=>	"yes",
			'html'			=>	$mdl_temp,
			'article_id'			=>	$ID
		);
		return $box;

		return undef;
	}
}


1;
