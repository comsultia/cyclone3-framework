sub BaseModul
{
 require "grabber_fnc.m";

 my $id=$form{ID} if ($form{ID});
 if ($form{set})
 {
  $HTML_HEADER{BODY}{extract}="yes";

  $indexes=&convert_html($form{indexes});
  my $temp;
  while ($indexes=~s|<id=(.*?) value=(.*?) desc=(.*?)>|<INDEXTO>|i)
  {
   $temp.="<INDEX id=\"$1\" value=\"$2\" description=\"$3\" />\n";
  }
  $indexes=$temp;
  $indexes=~s|\'|\\'|g;

  my $update_success=1;

  if ($id)
  {
   if ($form{setup} eq "1")
   {
    $form{year1}-=1900;
    $form{year2}-=1900;
    $form{mom1}--;
    $form{mom2}--;
    my $starttime=timelocal(undef,$form{min1},$form{hour1},$form{day1},$form{mom1},$form{year1},undef,undef,undef);
    my $endtime=timelocal(undef,$form{min2},$form{hour2},$form{day2},$form{mom2},$form{year2},undef,undef,undef);
    #return "UPDATE markiza_sk.a020_archiv SET description='$form{description}' WHERE ID='$id' LIMIT 1";

     #calling GRABBER !!!!!!!!!!!!!!

     #SetGrab($id);

	#calling GRABBER !!!!!!!!!!!!!!

    $after_midnight="N";
    $after_midnight="Y" if $form{after_midnight} eq "Y";


    my $db_select_videofile;

    $db_micro1 = $dbh->Query("SELECT video_file, ID_cat FROM markiza_sk.a020_archiv WHERE ID='$id'");
    if (@db_micro1_line=$db_micro1->FetchRow())
    {
     #my $old_videofile="";
     #my $new_videofile;

     if ($db_micro1_line[0] ne "")
     {
      $db_microX = $dbh->Query("SELECT short FROM markiza_sk.a020_cat WHERE ID='$db_micro1_line[1]'");
      if (@db_microX_line=$db_microX->FetchRow())
      {

	  my @TIME;
       if ($after_midnight eq "Y") { @TIME = localtime($starttime-86400); } else { @TIME = localtime($starttime); }
       my $Time=sprintf("_%02d_%02d_%04d.asf",$TIME[3],$TIME[4]+1,$TIME[5]+1900);

	  $Time=$db_microX_line[0].$Time;

	  if ($db_micro1_line[0] ne $Time) { $db_select_videofile=",video_file='$Time'"; }

	 }
	}
    }

=head1
  my $box;

  $box=&box_create2("Akoze reset",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	"UPDATE markiza_sk.a020_archiv SET time_from='$starttime',time_to='$endtime',midnight='$after_midnight',description='$form{description}'$db_select_videofile WHERE ID='$id' LIMIT 1");

  return $box;
=cut

    $dbh->Query("UPDATE markiza_sk.a020_archiv SET time_from='$starttime',time_to='$endtime',midnight='$after_midnight',description='$form{description}'$db_select_videofile WHERE ID='$id' LIMIT 1");
    &SetGrab($id);
   }
   else
   {
    $form{year1}-=1900;
    $form{year2}-=1900;
    $form{mom1}--;
    $form{mom2}--;
    my $starttime=timelocal(undef,$form{min1},$form{hour1},$form{day1},$form{mom1},$form{year1},undef,undef,undef);
    my $endtime=timelocal(undef,$form{min2},$form{hour2},$form{day2},$form{mom2},$form{year2},undef,undef,undef);

    $dbh->Query("UPDATE markiza_sk.a020_archiv SET ind='$indexes',video_file='$form{vfile}',time_from='$starttime', time_to='$endtime',description='$form{description}' WHERE ID='$id' LIMIT 1");
    #$dbh->Query("UPDATE markiza_sk.a020_archiv SET ind='$indexes',description='$form{description}',time_from='$form{time_from}',time_to='$form{time_to}' WHERE ID='$id' LIMIT 1");
   }


   #-----------------updating EXTERNAL event && tv_archiv tables for grabber !!!!!!!!!!!
=head1
	$T_SRV="192.168.1.20";
     $T_DB="markiza";
     $T_USR="webcom";
     $T_PWD="plaque";

     # CONNECT TARGET
     $T_DBase=Mysql->Connect($T_SRV,$T_DB,$T_USR,$T_PWD);
     $T_DBase->SelectDB($T_DB);
     print "Connected to T\n";

	if ($db_micro = $dbh->Query("SELECT * FROM markiza_sk.a020_archiv WHERE ID='$id' LIMIT 1"))
	{
	 if (%db_micro1_line=$db_micro1->FetchHash())
	 {
      # FAKE tv_archiv v starej DB
		$T_DBase->Query('REPLACE INTO tv_archiv (id_event,id_category,id_relacie,file_asf,datetime_from,datetime_to) VALUES
     			("'.$id.'","1","1","'.$db_micro1_line{video_file}.'","'.$db_micro1_line{time_from}.'","'.($db_micro1_line{time_to}+60*5).'")') or $update_success="0";

      # FAKE event v starej DB
     	$T_DBase->Query('REPLACE INTO event (id_event, id_type_event, id_org,  name,date_from,date_to,time_from,time_to,description,archiv) VALUES
     			("'.$id.'","1","1","WebCom Grab","'.sprintf("%04d-%02d-%02d",$TIME[5]+1900,$TIME[4],$TIME[3]).'","'.sprintf("%04d-%02d-%02d",$TIME_TO[5]+1900,$TIME_TO[4],$TIME_TO[3]).'","'.sprintf("%02d:%02d:00",$TIME[2],$TIME[1]).'","'.sprintf("%02d:%02d:00",$TIME_TO[2],$TIME_TO[1]).'","","1")') or $update_success="0";
	 }
	}
=cut
   #-----------------end of updating EXTERNAL event && tv_archiv tables for grabber


  }

  return "\n<script>\nparent.document.frames['frm_base'].location.reload();\n</script>";
 }
 else #tu je ten predel!!!------------------------------------------------------------------------------------------------------
 {
  $HTML_HEADER{BODY}{extract}="yes";

  #$HTML_HEADER{BODY}{onunload}="parent.box_loading.style.display='block';";
  $db_micro = $dbh->Query("SELECT * FROM markiza_sk.a020_archiv WHERE ID='$id' LIMIT 1");
  %db_micro_line=$db_micro->FetchHash();

   (undef,$minR1,$hourR1,$mdayR1,$momR1,$yearR1,undef,undef,undef) = localtime($db_micro_line{time_from});
   (undef,$minR2,$hourR2,$mdayR2,$momR2,$yearR2,undef,undef,undef) = localtime($db_micro_line{time_to});

  $momR1++;$yearR1=$yearR1+1900;
  $momR2++;$yearR2=$yearR2+1900;

  #return $db_micro_line{title};
  $db_micro1 = $dbh->Query("SELECT name FROM markiza_sk.a020_cat WHERE ID='$db_micro_line{ID_cat}'");
  if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{cat_name}=$db_micro1_line[0]; }

  #action="core.pl?type=$form{type}&id=$id&set=yes&image=$db_micro_line{xrelated}" method="POST">

=head1
  my $after_midnight;
  $db_micro1 = $dbh->Query("SELECT midnight FROM markiza_sk.a021_program WHERE ID_cat='$db_micro_line{ID_cat}' AND name='$db_micro_line{description}'");
  if (@db_micro1_line=$db_micro1->FetchRow()) { if ($db_micro1_line[0] eq "Y") { $after_midnight = "checked"; } }




  <table cellpadding="0" cellspacing="0" border="0" width="100%" style="FONT:10px Verdana;COLOR:white;">
   <tr>
    <td align="left" nowrap width="50%">
     <span style="FONT:10px Verdana; font-weight: bold; width:445px;">&nbsp;&nbsp;&nbsp;$db_micro_line{cat_name}</span><BR>
    </td>
    <td align="right" nowrap width="50%">
     <input type=\"checkbox\" name=\"after_midnight\" value=\"$db_micro_line{midnight}\" $after_midnight>&nbsp;po polnoci&nbsp;&nbsp;&nbsp;&nbsp;<br>
    </td>
   </tr>
  </table>


=cut


  my $after_midnight;
  $db_micro1 = $dbh->Query("SELECT midnight FROM markiza_sk.a021_program WHERE ID_cat='$db_micro_line{ID_cat}' AND name='$db_micro_line{description}'");
  if (@db_micro1_line=$db_micro1->FetchRow()) { if ($db_micro1_line[0] eq "Y") { $after_midnight = "checked"; } }

########for testing purposes .. targeting into the same frame
  my $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td>
  <form name="indexesEdit_$id" action="core.pl?type=020-edit&setup=$form{setup}&ID=$id&set=yes" method="POST" enctype="multipart/x-form-data" target="frm_micro">
  </td><td width=100% style="FONT:10px Verdana;COLOR:white;">
  &nbsp;Relácia:<BR>
  <input type=hidden name="IDcategory" value="$db_micro_line{ID_cat}">
 <span style="FONT:10px Verdana; font-weight: bold; width:445px;">&nbsp;&nbsp;&nbsp;$db_micro_line{cat_name}</span>
 <input type="checkbox" name="after_midnight" value="Y" $after_midnight>&nbsp;po polnoci<BR>
  <input type=hidden value="$db_micro_line{time_from}" name="time_from">
  <input type=hidden value="$db_micro_line{time_to}" name="time_to">

HEADER

 my $temp;

  while ($db_micro_line{ind}=~s|<INDEX id="(.*?)" value="(.*?)" description="(.*?)" />|<INDEXTO>|i)
  {
   $temp.="<id=$1 value=$2 desc=$3>\n";
  }
  $indexes=$temp;

=head1
  <table height=16 width=100% cellspacing=0 cellpadding=0 border=0 background="$tom::H_media/grf/admin/win_top_0_back.gif"><tr><td width=50% align=right><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td><td><center><input type=button drag_here value="vložiť 'kostru'" class=btn0 onclick="document.forms['indexesEdit_$id'].indexes.text=document.forms['indexesEdit_$id'].indexes.text + '<id= value= desc=>' ;"></center></td><td align=left width=50%><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td></tr></table><br>
=cut

if ($form{setup} eq "1")
{
  $mdl_temp.="<table width=100% cellspacing=0 cellpadding=0 border=0><tr><td style=\"FONT:10px Verdana;COLOR:white;\"  width=\"50%\">&nbsp;Nahrávať od/do:<br>";
}
else
{
  $mdl_temp.="<table width=100% cellspacing=0 cellpadding=0 border=0><tr><td style=\"FONT:10px Verdana;COLOR:white;\"  width=\"50%\">&nbsp;Zaznamenané od/do:<br>";
}
  $mdl_temp.="<table cellspacing=2 cellpadding=0 border=0><tr><td colspan=16></td></tr><tr>";

  my $width0=30-12;
  my $width1=50-12;

  my $mdl_micro;
  for (my $i=1;$i<=31;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"day1",
	'value'		=>	$mdayR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  my $mdl_micro;
  @mesiac=("january","february","march","april","may","june","july","august","september","october","november","december");
  for (my $i=1;$i<=12;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i-$mesiac[$i-1]</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"mom1",
	'value'		=>	$momR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	90,
	'select'	=>	$mdl_micro
  )."</td>";



  my $mdl_micro;
  for (my $i=2000;$i<=2050;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"year1",
	'value'		=>	$yearR1,
	'maxlength'	=>	30,
	'width'		=>	$width1,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  $mdl_temp.="<td>&nbsp;</td>";


  my $mdl_micro;
  for (my $i=0;$i<=23;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"hour1",
	'value'		=>	$hourR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";

  $mdl_temp.="<td></td>";

  my $mdl_micro;
  for (my $i=0;$i<=55;$i=$i+5)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"min1",
	'value'		=>	$minR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  #$mdl_temp.="</table>";

  $mdl_temp.="</tr></table></td><td style=\"FONT:10px Verdana;COLOR:white;\">";
  $mdl_temp.="</td><td style=\"FONT:10px Verdana;COLOR:white;\" width=\"50%\" valign=\"bottom\">";

  #$mdl_temp.="<td nowrap>-</td>";

  $mdl_temp.="<table cellspacing=2 cellpadding=0 border=0><tr><td colspan=16 valign=\"top\"></td></tr><tr>";

  my $mdl_micro;
  for (my $i=1;$i<=31;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"day2",
	'value'		=>	$mdayR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  my $mdl_micro;
  @mesiac=("january","february","march","april","may","june","july","august","september","october","november","december");
  for (my $i=1;$i<=12;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i-$mesiac[$i-1]</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"mom2",
	'value'		=>	$momR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	90,
	'select'	=>	$mdl_micro
  )."</td>";



  my $mdl_micro;
  for (my $i=2000;$i<=2050;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"year2",
	'value'		=>	$yearR2,
	'maxlength'	=>	30,
	'width'		=>	$width1,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  $mdl_temp.="<td>&nbsp;</td>";


  my $mdl_micro;
  for (my $i=0;$i<=23;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"hour2",
	'value'		=>	$hourR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
 )."</td>";

  $mdl_temp.="<td></td>";

  my $mdl_micro;
  for (my $i=0;$i<=55;$i=$i+5)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"min2",
	'value'		=>	$minR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";

  $mdl_temp.="</tr></table></td></table>";

  $mdl_temp.=<<"HEADER";
  &nbsp;Popis:<br>
 <input type=text name="description" id="description" value="$db_micro_line{description}" class=input0 maxlength=260 style="FONT:9px Verdana;width:445px;" drag_resizeX='0'><BR>
HEADER

if ($form{setup} eq "1")
{

}
else
{
  $mdl_temp.=<<"HEADER";
  &nbsp;Video:<br>
 <input type=text name="vfile" id="vfile" value="$db_micro_line{video_file}" class=input0 maxlength=260 style="FONT:9px Verdana;width:445px;" drag_resizeX='0'><BR>
  &nbsp;Indexácia: &lt;id=1-... value=mm:ss desc=text&gt;<br>
  <textarea name="indexes" style="width: 100%; font-size: 11px" rows="6">$indexes</textarea>
HEADER
}

  $mdl_temp.=<<"HEADER";
  <table height=16 width=100% cellspacing=0 cellpadding=0 border=0 background="$tom::H_media/grf/admin/win_top_0_back.gif"><tr><td width=50% align=right><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td><td><center><input type=submit drag_here value="Uložiť!" class=btn0 onclick="box_erase2();"></center></td><td align=left width=50%><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td></tr></table><br>
HEADER



=head1



  <TEXTAREA
	drag_resizeX='0'
	drag_resizeY='-300'
	name="indexes"
	id="indexes_all"
	class=input0
	style="width:445px;height:50px;FONT:12px Verdana;">$indexes</TEXTAREA><BR>
=cut



#<!-- <input type=hidden name=image value="$image_f"> /-->

  $mdl_temp.="</td><td></form></td></tr></table>";
  #$mdl_temp.="<script>lastOpenedArticleId=\"$db_micro_line{ID}\"; alert(lastOpenedArticleId);</script>";

my $box;

if ($form{setup} eq "1")
{
  $box=&box_create2("Nastavenie grabovania relácie",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp);
}
else
{
  $box=&box_create2("Indexácia archívneho videa",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp);
}

  return $box;

  return undef;
 }
}


1;
