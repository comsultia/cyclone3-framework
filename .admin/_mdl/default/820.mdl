sub BaseModul
{

 require "_table.m";
 require "_info.m";

 my $page_limit=20;
 my $page_from=$page_limit*$form{page};
 $form{page}="0" unless $form{page};

 my $info=&info_create(
	'icon'	=>	"style=\"cursor:hand;\" onclick=\"load_box('core.pl?type=400-search');\"",
	'new'	=>	True,
	'title'	=>	"Zoznam fÃ³r",
	'next'	=>	$form{page},
	'prev'	=>	$form{page}
 );
 my $select;

 for (my $i=0;$i<=55;$i=$i+5)
 {
  $select.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
 }
 my $select_author=&select_create(
	'name'		=>	"min2",
	'value'		=>	$minR2,
	'maxlength'	=>	30,
	'width'		=>	1,
	'width1'	=>	50,
	'select'	=>	$select
 );


 my $db_micro2=$dbh->Query("SELECT ID FROM markiza_sk.a400_category ORDER BY length(ID) DESC LIMIT 1");
 my @db_micro_line2=$db_micro2->FetchRow();
 $priority_depth=length($db_micro_line2[0])/2;

 #return $db_micro_line2[0]." ".$priority_depth;

 my %plus;
 my $i;

 for ($i=0;$i<=2;$i++)
 {
  $plus{'8.'.$i}{'id'}=$i;
  $plus{'8.'.$i}{'code'}="<a href=\"core.pl?type=priorize&priority_depth=".$i."&ID=<!--ID-->\" target=\"frm_micro\"><img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0></a>";
  $plus{'8.'.$i}{'class'}="td_act";
  $plus{'8.'.$i}{'select'}="orderby=priority DESC,starttime";
  $plus{'8.'.$i}{'td_class'}="td_act";
  $plus{'8.'.$i}{'td_plus'}="nowrap";
 }
 my $listingArchive;
 if ($form{archive} eq "1") { $listingArchive="archive=1&"; }

 #-------------------ordering by az/za-----------------------------

 #my $orderbyShort="short";
 #my $orderbyShortCol="short_A_Z";
 #if ($form{'orderby'}=~/shortD/)
 #  { $form{'orderby'}=~s|shortD|short DESC|; }
 #else
 #  { if ($form{'orderby'}=~/short/) { $orderbyShort="shortD"; $orderbyShortCol="short_Z_A" } }

 #-------------------ordering by az/za-----------------------------

 my $table=HP_TABLE->new(
 'title'			=>	"taky maly popis",
 'cellspacing'	=>	1,
 'cellpadding'	=>	1,
 #'color_active'	=>	"#F0F080",
 'color_active'	=>	"#F0F0C0",
 'link_core'		=>	"core.pl?type=$form{type}&$listingArchive",
 'define'		=>
 {
 '1'	=>
	{
	'id'		=>	"A",
	'code'		=>	"<img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0 onclick=\"this.src='core.pl?type=set_active&table=a820&id=<!--ID-->';\">",
	'select'	=>	"orderby=active,starttime",
	'class'		=>	"td_act",
	#'td_class'	=>	"td_act"
	},
 '2'	=>
	{
	'id'		=>	"start",
	'code'		=>	"<%1%>",
	'select'	=>	"orderby=starttime",
	'class'		=>	"td_act",
	'td_plus'	=>	"nowrap"
	},
 '2.1'	=>
	{
	'id'		=>	"end",
	'code'		=>	"<%1%>",
	'select'	=>	"orderby=endtime",
	'class'		=>	"td_act",
	'td_plus'	=>	"nowrap"
	},
 '2.1'	=>
	{
	'id'		=>	"id",
	'code'		=>	"&nbsp;<%1%>&nbsp;",
	'select'	=>	"orderby=starttime DESC",
	'class'		=>	"td_act",
	'td_plus'	=>	"nowrap"
	},
 '4'	=>
	{
	'id'		=>	"title",
	'code'		=>	"&nbsp;<B><a href=\"javascript:load_box('core.pl?type=<%1%>-edit&id=<%2%>')\"><%3%></a></B>",
	'select'	=>	"orderby=title,starttime",
	'class'		=>	"td_act",
	'td_class'	=>	"td0",
	'td_plus'	=>	"nowrap"
	},
 #'5'	=>
#	{
#	'id'		=>	"author",
 #	'id_plus'	=>	$select_author,
#	'code'		=>	"&nbsp;<%1%>&nbsp;",
#	'select'	=>	"orderby=IDauthor,starttime",
#	'plus'		=>	"nowrap",
#	'class'		=>	"td_act",
#	'td_plus'	=>	"nowrap"
#	},

# '6.1'	=>
#	{
#	'id'		=>	"editor",
 #	'id_plus'	=>	$select_author,
#	'code'		=>	"&nbsp;<%1%>&nbsp;",
#	'select'	=>	"orderby=IDauthor,starttime",
#	'plus'		=>	"nowrap",
#	'class'		=>	"td_act",
#	'td_plus'	=>	"nowrap"
#	},
  '9'	=>
	{
	'id'		=>	"messages",
	'code'		=>	"&nbsp;<%1%>&nbsp;",
	'select'	=>	"orderby=visits",
	'class'		=>	"td_act",
	'td_plus'	=>	"nowrap align=\"center\""
	},
'9.1'	=>
	{
	'id'		=>	"associate",
	'code'		=>	"&nbsp;<%1%>&nbsp;",
	#'select'	=>	"orderby=visits",
	'class'		=>	"td_inact",
	'td_plus'	=>	"nowrap"
	},
#'9.2'	=>
#	{
#	'id'		=>	"arch_index",
#	'code'		=>	"&nbsp;-<%1%>-&nbsp;",
#	'class'		=>	"td_act",
#	'td_plus'	=>	"nowrap align=\"center\""
#	},
# '9.2'	=>
	{
#	'id'		=>	"archive",
#	'code'		=>	"<img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0 onclick=\"this.src='core.pl?type=set_archive&table=a400&id=<!--ID-->';\">",

#	'code'		=>	"<a href=\"core.pl?type=set_archive&id=<%3%>&archive=<%2%>\" target=\"frm_micro\"><img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0></a>",
# 'td_plus'	=>	"align=center"
	},
'9.3'	=>
	{
	'id'		=>	"forum_index",
	'code'		=>	"&nbsp;-<%1%>-&nbsp;",
	#'select'	=>	"orderby=visits",
	'class'		=>	"td_act",
	'td_plus'	=>	"nowrap align=\"center\""
	},
 }
 );

 my $where;
 if ($form{search} eq "1")
 {
  if (not $form{'title'} eq "")
  { if ($where eq "") { $where.="WHERE title LIKE '%$form{title}%' " } else { $where.="title='%$form{title}%' " } }
  if ($form{'subtitle'})
  { if ($where eq "") { $where.="WHERE title LIKE '%$form{subtitle}%' " } else { $where.="subtitle LIKE '%$form{subtitle}%' " } }
  if ($form{'IDauthor'})
  { if ($where eq "") { $where.="WHERE IDauthor='$form{IDauthor}' " } else { $where.="AND IDauthor='$form{IDauthor}' " } }
  if ($form{'IDeditor'})
  { if ($where eq "") { $where.="WHERE IDeditor='$form{IDeditor}' " } else { $where.="AND IDeditor='$form{IDeditor}' " } }
  if ($form{'IDcategory'})
  {
   my $varr;
   if ($form{'cat_allow_subs'} eq "1") { $varr="LIKE \'".$form{IDcategory}."%\'"; } else { $varr="=\'".$form{IDcategory}."\'"; }
   if ($where eq "") { $where.="WHERE IDcategory ".$varr." "; } else { $where.="AND IDcategory ".$varr." "; }
   undef $varr;
  }
  if ($form{'full'})
  { if ($where eq "") { $where.="WHERE full LIKE '%$form{full}%'" } else { $where.="AND full LIKE '%$form{full}%' " } }
  #while ($form{wherestring}=~s|(.*?)=(.*?)&||)
  #{
  # $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$sele{$_}';\" style=\"FONT:12px Verdana;\">&nbsp;$_</div>\n";
  #}
  #$where="WHERE

  if ($form{'archive'} eq '1') { $where.=" AND arch='Y'"; } else { $where.=" AND arch='N'"; }
 }
 else
 {
  $where="WHERE type='F' AND ID LIKE '00a002%'";
  $where="WHERE $form{whereby}='$form{where}'" if ($form{'whereby'});
  if ($form{'wherelike'})
  { $where="WHERE $form{wherelike} LIKE '$form{where}%'" if ($form{'wherelike'} eq "IDcategory"); }
  else
  { $where="WHERE $form{wherelike} LIKE '$form{where}%'" if ($form{'wherelike'}); }
  if ($form{'archive'} eq '1')
  { if (($form{'whereby'}) || ($form{'wherelike'})) { $where.=" AND arch='Y'"; } else { $where.=" WHERE arch='Y'"; } }
  #else
  #{ if (($form{'whereby'}) || ($form{'wherelike'})) { $where.=" AND arch='N'"; } else { $where.=" WHERE arch='N'"; } }
 }

 my $orderby;
 if ($form{'orderby'}) { $orderby=$form{'orderby'}; } else { $orderby="ID"; }

 #my $db_micro = $dbh->Query("SELECT ID, priority, starttime, endtime, updated, title, IDcathegory, typeview, visits_index, visits, absvisits_index, visits_index, votes, vote_full, vote_index, votes, image, data_plus, active  FROM clanky_trash $where $orderby LIMIT $page_from,$page_limit");

 #return "SELECT ID, active, priority, starttime, endtime, changetime, IDcategory, title, subtitle, IDauthor, xrelated, visits FROM markiza_sk.a400 $where ORDER BY $orderby DESC LIMIT $page_from,$page_limit";

 #my $db_micro = $dbh->Query("SELECT ID, active, priority, starttime, endtime, changetime, IDcategory, title, subtitle, IDauthor, IDeditor, xrelated, visits FROM markiza_sk.a400 $where ORDER BY $orderby DESC LIMIT $page_from,$page_limit");

 #unioned siligd :o)

 #return "SELECT * FROM forum_markiza_sk.a820 $where ORDER BY $orderby DESC LIMIT $page_from,$page_limit";

 my $db_micro = $dbh->Query("SELECT * FROM forum_markiza_sk.a820 $where ORDER BY $orderby DESC LIMIT $page_from,$page_limit");


 if ($db_micro)
 {

 while (my %db_micro_line=$db_micro->FetchHash())
 {

#=head1
  #active
  my $cl_active="r";
  if ($db_micro_line{'active'} eq "Y"){$cl_active="g"}
  #today, yesterday, older line color
  my $cl_color="#8FADF9";
  if ($db_micro_line{starttime}>(time-86400)){$cl_color="#B0CFFF"}
  if ($db_micro_line{starttime}>time){$cl_color="#E0EFFF"}

  my $cl_class="tr1";
  my %article_times;

  $article_times{'starttime'}={Utils::datetime::ctodatetime($db_micro_line{'starttime'},format=>1)};
  $article_times{'endtime'}={Utils::datetime::ctodatetime($db_micro_line{'endtime'},format=>1)};
  $article_times{'changetime'}={Utils::datetime::ctodatetime($db_micro_line{'changetime'},format=>1)};
  #my $article_times{'lasttime'}=Tomahawk::utils::datetime::ctodatetime($db_micro_line{'lasttime'},format=>1);

  my $db_micro2=$dbh->Query("SELECT id, nickname FROM markiza_sk.a120 WHERE ID='$db_micro_line{'IDauthor'}' LIMIT 1");
  my @db_micro_line2=$db_micro2->FetchRow();
  $db_micro_line{'author_name'}=$db_micro_line2[1];

  my $db_micro2=$dbh->Query("SELECT id, nickname FROM markiza_sk.a120 WHERE ID='$db_micro_line{'IDeditor'}' LIMIT 1");
  my @db_micro_line2=$db_micro2->FetchRow();
  $db_micro_line{'editor_name'}=$db_micro_line2[1];

  my $parent_cat;

  if (length($db_micro_line{IDcategory})>2)
  {
   my $where2="";
   $parent_cat=$db_micro_line{IDcategory};
   $parent_cat=~s|(^.*)..$||;
   $parent_cat=$1;
   $where2="OR ID='$parent_cat'";

   #return "SELECT ID, name FROM markiza_sk.a400_category WHERE ID='$db_micro_line{IDcategory}' $where2 LIMIT 1";
   my $db_micro2=$dbh->Query("SELECT ID, name FROM markiza_sk.a400_category WHERE ID='$db_micro_line{'IDcategory'}' $where2 LIMIT 2");
   while (@db_micro_line2=$db_micro2->FetchRow())
   {
    $db_micro_line{'cat_name'}=$db_micro_line2[1] if ($db_micro_line2[0] eq $db_micro_line{'IDcategory'});
    $db_micro_line{'parent_cat_name'}=$db_micro_line2[1] if ($db_micro_line2[0] eq $parent_cat);
   }
  }
  else
  {
   my $db_micro2=$dbh->Query("SELECT ID, name FROM markiza_sk.a400_category WHERE ID='$db_micro_line{'IDcategory'}' LIMIT 1");
   if (@db_micro_line2=$db_micro2->FetchRow())
   {
    $db_micro_line{'cat_name'}=$db_micro_line2[1];
   }
  }

  undef @db_micro2;
  undef @db_micro_line2;

  $db_micro_line{'photo_count'}="0";
  $db_micro_line{'video_count'}="0";
  $db_micro_line{'audio_count'}="0";
  $db_micro_line{'archive_index_count'}="0";

  if ($db_micro_line{'xrelated'}=~s|<VAR id="a820" value="(.*?)" />||si)
  {
   $db_micro_line{'forum_id'}=$1;
  }
  else
  {
   $db_micro_line{'forum_id'}="XXX";
  }
  while ($db_micro_line{'xrelated'}=~s|<VAR id="a500" value="(.*?)" />||si)
  {
   $db_micro_line{'photo_count'}++;
  }
  while ($db_micro_line{'xrelated'}=~s|<VAR id="a510" value="(.*?)" />||si)
  {
   $db_micro_line{'video_count'}++;
  }
  while ($db_micro_line{'xrelated'}=~s|<VAR id="a510" value="(.*?)" />||si)
  {
   $db_micro_line{'audio_count'}++;
  }
  while ($db_micro_line{'xrelated'}=~s|<VAR id="a020" value="(.*?)" />||si)
  {
   $db_micro_line{'archive_index_count'}++;
  }

#=cut

 %plus={};
 my %priority_vals;

 $i=0;

 while ($db_micro_line{priority}=~s|(.)||)
 {
  if ($1 eq "2"){$priority_vals{$i}="g";}
  if ($1 eq "1"){$priority_vals{$i}="y";}
  if ($1 eq "0"){$priority_vals{$i}="r";}
  $i++;
 }

 for (my $i=0;$i<=$priority_depth;$i++)
 {
  if (exists $priority_vals{$i}){$plus{$i}{'1'}=$priority_vals{$i};}else{$plus{$i}{'1'}='r';}
 }

 my $isFromArchive = "g";
 if ($db_micro_line{'arch'} eq "Y") { $isFromArchive = "g"; } else { $isFromArchive = "r"; }



  $table->add(
   'class'		=>	$cl_class,
   'color'		=>	$cl_color,
   'define'	=>{

    'A'	=>
    {	'1'	=>	$cl_active},

    'start'	=>
    {'1'=>"$article_times{'starttime'}{mday}/$article_times{'starttime'}{mom}/$article_times{'starttime'}{year} $article_times{'starttime'}{hour}:$article_times{'starttime'}{min}"},

    'end'	=>
    {'1'=>"$article_times{'endtime'}{mday}/$article_times{'endtime'}{mom}/$article_times{'endtime'}{year} $article_times{'endtime'}{hour}:$article_times{'endtime'}{min}"},

    'id'	=>
    {'1'=>"$db_micro_line{'ID'}"},

    'title'	=>
    {
    '1'=>"$form{type}",
    '2'=>"$db_micro_line{ID}",
    '3'=>"$db_micro_line{'name'}"
    },

#    'subtitle'	=>
#    {'1'=>$db_micro_line{'subtitle'}},

#    'author'	=>
#    {'1'=>"<a href=\"core.pl?type=400&".$listingArchive."whereby=IDauthor&where=$db_micro_line{'IDauthor'}\" target=\"frm_base\">".$db_micro_line{'author_name'}."</a>"},

#    'editor'	=>
#    {'1'=>"<a href=\"core.pl?type=400&".$listingArchive."whereby=IDauthor&where=$db_micro_line{'IDeditor'}\" target=\"frm_base\">".$db_micro_line{'editor_name'}."</a>"},

    'img'	=>
    {'1'=>"$db_micro_line{'photo_count'}"},

    %plus,

    'messages'	=>
    #{'1'=>"$db_micro_line{'visits'}"},
    #{'1'=>"<a href=\"core.pl?type=400&".$listingArchive."orderby=visits\" target=\"frm_base\">".$db_micro_line{'messages'}."</a>"},
    {'1'=>"$db_micro_line{'messages'}"},

    'associate'	=>
    {'1'=>"$db_micro_line{'ID'}"},

    'archive'	=>
    {	'1'	=>	$isFromArchive,
          '2'  =>   $db_micro_line{'arch'},
		'3'  =>   $db_micro_line{'ID'}
    },


    #'arch_index'	=>
    #{'1'=>"<a href=\"core.pl?type=400-indexize&ID=$db_micro_line{'ID'}\" target=\"frm_micro\">".$db_micro_line{'archive_index_count'}."</a>"},

    'forum_index'	=>
    {'1'=>"$db_micro_line{'forum_id'}"},

#    'Y'	=>
#    {'1'=>"<a href=\"core.pl?type=clanok_undele&id=<!--ID-->\" target=\"frm_micro\"><img src=$tom::H_media/grf/admin/close3.gif border=0 width=12 height=12></a>"},

#    'X'	=>
#    {'1'=>"<a href=\"core.pl?type=clanok_trashdel&id=<!--ID-->\" target=\"frm_micro\"><img src=$tom::H_media/grf/admin/close1.gif border=0 width=12 height=12></a>"},

   },'replace'	=>{'ID'	=>	$db_micro_line{ID}}
  );

 }
}
 return $info.$table->HTML;
}

1;
