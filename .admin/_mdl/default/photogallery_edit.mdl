sub BaseModul
{
my $id=$form{id};
if ($form{set})
{
 $HTML_HEADER{BODY}{extract}="yes";

 my $mdl_temp=<<"HEADER";
$form{multipart}<BR>
id:$form{id}<BR>
IDcathegory:$form{IDcathegory}<BR>
popis:$form{about}<BR>
#img_t:$form{imga_t}<BR>
#img_s:$form{imga_s}<BR>
#img_o:$form{imga_o}<BR>
HEADER

 if ($id)
 {
  &save_log(1,"update obrazku id=$id $form{about}");
  $db_micro = $dbh->Query("SELECT ID,IDcathegory,format_t,format_s,format_o,starttime,about FROM photogallery WHERE ID='$id' LIMIT 1");
  if (@db_micro_line=$db_micro->FetchRow())
  {
   $f_t=$db_micro_line[2];
   $f_s=$db_micro_line[3];
   $f_o=$db_micro_line[4];
  }
 }
 else
 {
  $dbh->Query("INSERT INTO photogallery(about) VALUES ('!ABSOLUTENEW!')");
  $db_micro = $dbh->Query("SELECT ID FROM photogallery WHERE about='!ABSOLUTENEW!' ORDER BY ID DESC LIMIT 1");
  if (@db_micro_line=$db_micro->FetchRow()){$id=$db_micro_line[0];}
  &save_log(1,"vlozenie obrazku id=$id $form{about}");
 }
# my $nullid=$id;

 my $nullid=sprintf ('%07d', $id);

# if ($nullid<10){$nullid="0$nullid"};
# if ($nullid<100){$nullid="0$nullid"};
# if ($nullid<1000){$nullid="0$nullid"};
# if ($nullid<10000){$nullid="0$nullid"};
# if ($nullid<100000){$nullid="0$nullid"};
# if ($nullid<1000000){$nullid="0$nullid"};
 
 if (-e "../media/img/$nullid-t.jpg"){$f_t="Y";}else{$f_t="";}
 if (-e "../media/img/$nullid-s.jpg"){$f_s=$form{image2_size};}else{$f_s="";}
# if (-e "../media/img/$nullid-o.jpg"){$f_o=$form{image3_size};}else{$f_o="";}
 if (-e "../media/img/$nullid-o.jpg"){$f_o=$form{image3_size};}else{$f_o="";}

 if ($form{img_t})
 {
  binmode HND;
  open (HND,">../media/img/$nullid-t.jpg");
  print HND $form{img_t};
  close HND;
  $f_t="Y";
 }
 
 if ($form{img_s})
 {
  binmode HND;
  open (HND,">../media/img/$nullid-s.jpg");
  print HND $form{img_s};
  close HND;
  $f_s=$form{image2_size};
 }

 if ($form{img_o})
 {
  binmode HND;
  open (HND,">../media/img/$nullid-o.jpg");
  print HND $form{img_o};
  close HND;
  $f_o=$form{image3_size};
 }

 my $box=&box_create2("vstupn�data",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	700,
	'height'		=>	50,	
	'close'			=>	"yes",
	'html'			=>	"$id $form{img_o}!$f_o!$form{image3_size}");
# return $box; 
 
 if ($id)
 {
  $dbh->Query("UPDATE photogallery SET IDcathegory='$form{IDcathegory}',cathegory='$form{IDcathegory_}',about='$form{about}',about2='$form{about2}',format_t='$f_t',format_s='$f_s',format_o='$f_o',starttime='$current_time' WHERE ID='$id' LIMIT 1");
 }
# else
# {
#  $dbh->Query("INSERT INTO photogallery(IDcathegory,cathegory,format_t,format_s,format_o,starttime,about) VALUES ('$form{IDcathegory}','$form{IDcathegory_}','$f_t','$f_s','$f_o','$current_time','$form{about}')");
# }
 
# return $box; 
 
 return "\n<script>\nparent.document.frames['frm_base'].location.reload();\n</script>";
}
else
{
 $HTML_HEADER{BODY}{extract}="yes";

 $db_micro = $dbh->Query("SELECT ID,IDcathegory,format_t,format_s,format_o,starttime,about,about2 FROM photogallery WHERE ID='$id' LIMIT 1");
 if (@db_micro_line=$db_micro->FetchRow())
 {
  &save_log(1,"editacia obrazku id=$id $db_micro_line[6]");
 }
 else
 {
  &save_log(1,"editacia noveho obrazku");
 }
 
 my $nullid=$db_micro_line[0];
 if ($nullid<10){$nullid="0$nullid"};
 if ($nullid<100){$nullid="0$nullid"};
 if ($nullid<1000){$nullid="0$nullid"};
 if ($nullid<10000){$nullid="0$nullid"};
 if ($nullid<100000){$nullid="0$nullid"};
 if ($nullid<1000000){$nullid="0$nullid"};   
 
 my $mdl_temp=<<"HEADER";
<table width=100% cellspacing=0 cellpadding=0 border=0><tr><td drag_here>
<form name="$form{type}\_$id"  
action="core.pl?type=$form{type}&id=$id&set=yes" target="frm_micro" method="POST" ENCTYPE="multipart/form-data">
</td><td width=100% style="FONT:10px Verdana;">
HEADER




 
 
 
 my $tree_temp;
 my $tree_temp_line=<<"HEADER";
 <table width=100% cellspacing=0 cellpadding=0>
    <tr>
     <%OD%>
     <td><img src=t.gif width=3 height=1 border=0><BR></td>
     <td nowrap style="FONT:bold 11px Verdana;"></td>
	 <td>
	 <td width=100% style="FONT:9px Verdana;"
	 	onmouseover="this.style.background='blue';this.style.color='white';"
		onmouseout="this.style.background='';this.style.color='';"
		<%PLUS%>
	 ><%NAME%></td>
 	</tr>
 </table>
HEADER


my $tree_temp_od="<td <%TBG%> align=middle <%VALIGN%>><%IMG%><img src=t.gif width=11 height=1 border=0><BR></td>";
my $selected;
my $selected2;
my $db_micro1 = $dbh->Query("
	SELECT ID,fullname,tinyname
	FROM photogallery_cathegory 
	ORDER BY ID");
while (my @db_micro1_line=$db_micro1->FetchRow())
{
  my $tr_uroven=my @tr_cesta=split('',$db_micro1_line[0]);
  $tree_temp.=$tree_temp_line;
  $width=$tr_uroven*10+5;
  $tree_temp =~s|<%NAME%>|$db_micro1_line[2]|g;
  $tree_temp =~s|<%ID%>|$db_micro1_line[0]|g;
  
  my $i0=-1;
  my $od;
  while ($i0<($tr_uroven))
  {
   $i0++;
   $od .= $tree_temp_od;
   $od =~s|<%TBG%>|<%TBG-$i0%>|g;
   
   if (($i0+1) == $tr_uroven)
   {
    $od=~s|<%IMG%>|<img src=t.gif width=1 height=3 border=0><BR><img src="$tom::H_media/grf/admin/forum_0_3.gif" border=0><BR>|g;
    $tree_temp =~s|<%TBG-$i0%>|background="$tom::H_media/grf/admin/forum_0_0.gif"|g;   
   }
      
   if ($i0 == $tr_uroven)
   {
    $od=~s|<%VALIGN%>|valign=middle|g;
    $od=~s|<%IMG%>|<img src="$tom::H_media/grf/admin/tree_0.gif" border=0><BR>|g;
    $od =~s|<%TBG-$i0%>||g;
    $tree_temp =~s|<%TBG-$i0%>||g;
   }
   else
   {
    $od=~s|<%IMG%>||g;
   }
   
   $od=~s|<%VALIGN%>|valign=top|g;
  }
  $tree_temp =~s|<%OD%>|$od|g;
  $tree_temp =~s|<%BG%>|#96B2C8|g;
  $tree_temp =~s|<%PLUS%>|onclick="parentElement.parentElement.parentElement.parentElement.parentElement.all['VALUE2'].value='$db_micro1_line[0]';parentElement.parentElement.parentElement.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[2]';"|g;
	if ($db_micro_line[1] eq $db_micro1_line[0])
	{$selected=$db_micro1_line[2];$selected2=$db_micro1_line[0];}
}





# my $mdl_micro;
# my $selected;
# my $selected2;
# $db_micro1 = $dbh->Query("SELECT ID,fullname,tinyname FROM photogallery_cathegory ORDER BY ID");
# while (@db_micro1_line=$db_micro1->FetchRow())
# {
#  my $from;
#  for (my $i=1;$i<length($db_micro1_line[0]);$i++){$from.="&nbsp;&nbsp;";}
#  if ($db_micro_line[1] eq $db_micro1_line[0])
#	{$selected=$db_micro1_line[2];$selected2=$db_micro1_line[0];}
#$mdl_micro.=&select_add('value'=>$db_micro1_line[2],'html'=>$from.$db_micro1_line[2],'plus'=>"this.parentElement.parentElement.all['VALUE2'].value='$db_micro1_line[0]';");
# }
 
 $mdl_temp.=&select_create(
 	'name'		=>	"IDcathegory_",
	'plus'		=>	"<input id=VALUE2 value=\"$selected2\" name=IDcathegory type=hidden>",
	'value'		=>	$selected,
	'maxlength'	=>	100,
	'width'		=>	350,
	'height'	=>	200,
	'select'	=>	$tree_temp
 );







#$mdl_temp.=$tree_temp;

$mdl_temp.=<<"HEADER";
<input type=text name="about" value="$db_micro_line[6]" maxlength=200
	class=input0 style="width:362px;"><BR>
<input type=text name="about2" value="$db_micro_line[7]" maxlength=150
	class=input0 style="width:362px;"><BR>
<table width=100% cellspacing=2 cellpadding=3 border=0>
<tr><td valign=top class=input0 width=85><input type=text name="image1_size" class=input0 style="width:82px;"><BR>
<img name="image" src="$h_img/$nullid-t.jpg" border=1 width=80 height=80 onload="parentElement.all['image1_size'].value=this.width+'x'+this.height;"><BR>
<input type=file name="img_t" class=input0 style="width:82px;" drag_here onchange="parentElement.all['image'].src=this.value;"><BR></td>
<td class=input0 width=100%><input type=text name="image2_size" class=input0 style="width:258px;"><BR><div class=input0 style="overflow:scroll;
			display:block;
			width: 258px;
			height: 150px; 
			border: solid #000000; 
			border-width: 1px 1px 1px 1px;">
<img name="image" src="$h_img/$nullid-s.jpg" border=0 onload="parentElement.parentElement.all['image2_size'].value=this.width+'x'+this.height;"><BR></div>
<input type=file name="img_s" class=input0 style="width:258px;" drag_here onchange="parentElement.all['image'].src=this.value;"><BR></td>
</tr>
</table>


<table width=100% cellspacing=2 cellpadding=3 border=0>
<tr><td valign=top class=input0><input type=text name="image3_size" class=input0 style="width:350px;"><BR>
<div class=input0 style="overflow:scroll;
			display:block;
			width: 350px;
			height: 200px; 
			border: solid #000000; 
			border-width: 1px 1px 1px 1px;">
<img name="image" src="$h_img/$nullid-o.jpg" border=0 onload="parentElement.parentElement.all['image3_size'].value=this.width+'x'+this.height;"><BR></div>
<input type=file name="img_o" class=input0 style="width:350px;" drag_here onchange="parentElement.all['image'].src=this.value;"><BR></td></tr>
</table>

<table height=16 width=100% cellspacing=0 cellpadding=0 border=0 baackground="$tom::H_media/grf/admin/win_top_0_back.gif"><tr><td width=50% align=right><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td><td><center><input type=submit drag_here value="Ulo!" class=btn0 onclick="box_erase2();"></center></td><td align=left width=50%><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td></tr></table>	
	
HEADER
 
 
 $mdl_temp.="</td><td></form></td></tr></table>";
 
 my $box=&box_create2("Edit�ia/nov�fotografia",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	362,
	'height'		=>	50,	
	'close'			=>	"yes",
	'html'			=>	$mdl_temp);

 return $box;
}
}













1;
