sub BaseModul
{
 require "grabber_fnc.m";

 my $id=$form{ID} if ($form{ID});
 if ($form{set})
 {
  $HTML_HEADER{BODY}{extract}="yes";

  $db_micro=$dbh->Query("SELECT ID FROM markiza_sk.a020_archiv ORDER BY ID DESC LIMIT 1");

  my $nextID;

  if (@db_micro_line=$db_micro->FetchRow())
  {
   $nextID=$db_micro_line[0];
   $nextID++;
  }

  $form{year1}-=1900;
  $form{year2}-=1900;
  $form{mom1}--;
  $form{mom2}--;
  my $starttime=timelocal(undef,$form{min1},$form{hour1},$form{day1},$form{mom1},$form{year1},undef,undef,undef);
  my $endtime=timelocal(undef,$form{min2},$form{hour2},$form{day2},$form{mom2},$form{year2},undef,undef,undef);

  $db_micro=$dbh->Query("SELECT ID,short FROM markiza_sk.a020_cat WHERE name='$form{arch_cat}' LIMIT 1");

  my $videofile;

  if (@db_micro_line=$db_micro->FetchRow())
  {
   $form{arch_cat}=$db_micro_line[0];
   $videofile=$db_micro_line[1];
   $form{mom1}++;
   $form{year1}+=1900;
   $videofile.="_".$form{day1}."_".$form{mom1}."_".$form{year1}.".asf";
  }
  else
  { $form{arch_cat}="NOT FOUND"; }

   $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
  <br>&nbsp;Trying to insert this data:<br>
  ID: $nextID<br>
  ID_cat: $form{arch_cat}<br>
  video_file: $videofile<br>
  audiofile: $audiofile<br>
  time_from: $starttime<br>
  time_to: $endtime<br>
  description: $form{description}.
  <BR><br><br><br><br>
  </td></tr></table>
HEADER

  if (($starttime > time) || ($starttime > $endtime) || ($form{arch_cat} eq "NOT FOUND"))
  {
   if ($starttime > time)
   {
     $mdl_temp=<<"HEADER";
     <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
     <br>&nbsp;Chyba! Bol zadany zaciatok relacie vyssi ako aktualny cas! Operacia zrusena!<br>
     </td></tr></table>
HEADER
   }
   elsif ($starttime > $endtime)
   {
     $mdl_temp=<<"HEADER";
     <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
     <br>&nbsp;Chyba! Bol zadany mensi cas ukoncenia relacie ako jej zaciatok! Operacia zrusena!<br>
     </td></tr></table>
HEADER
   }
   else
   {
     $mdl_temp=<<"HEADER";
     <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
     <br>&nbsp;Chyba! Bola zadana neexistujuca kategoria relacie! Operacia prerusena!<br>
     </td></tr></table>
HEADER
   }


   my $box;

   $box=&box_create2("Vloženie archívneho záznamu",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp);


   return $box;
  }

  $indexes=&convert_html($form{indexes});
  my $temp;
  while ($indexes=~s|<id=(.*?) value=(.*?) desc=(.*?)>|<INDEXTO>|i)
  {
   $temp.="<INDEX id=\"$1\" value=\"$2\" description=\"$3\" />\n";
  }
  $indexes=$temp;
  $indexes=~s|\'|\\'|g;


     $mdl_temp=<<"HEADER";
     <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
     <br>----<br>
	INSERT INTO markiza_sk.a020_archiv (ID,ID_cat,video_file,audio_file,time_from,time_to,ind,description) VALUES ('', '$form{arch_cat}', '$videofile', '$audiofile', '$starttime', '$endtime', '$indexes', '$form{description}')
     <br>----<br>
     </td></tr></table>
HEADER



  my $box;

  $box=&box_create2("Vloženie archívneho záznamu",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp);


  #return $box;


  $dbh->query("INSERT INTO markiza_sk.a020_archiv (ID,ID_cat,video_file,audio_file,time_from,time_to,ind,description) VALUES ('', '$form{arch_cat}', '$videofile', '$audiofile', '$starttime', '$endtime', '$indexes', '$form{description}')");

  return "\n<script>\nparent.document.frames['frm_base'].location.reload();\n</script>";
 }
 else #tu je ten predel!!!------------------------------------------------------------------------------------------------------
 {
  $HTML_HEADER{BODY}{extract}="yes";

  #$HTML_HEADER{BODY}{onunload}="parent.box_loading.style.display='block';";
  $db_micro = $dbh->Query("SELECT * FROM markiza_sk.a020_archiv WHERE ID='$id' LIMIT 1");
  %db_micro_line=$db_micro->FetchHash();

   (undef,$minR1,$hourR1,$mdayR1,$momR1,$yearR1,undef,undef,undef) = localtime(time);
   (undef,$minR2,$hourR2,$mdayR2,$momR2,$yearR2,undef,undef,undef) = localtime(time);

  $momR1++;$yearR1=$yearR1+1900;
  $momR2++;$yearR2=$yearR2+1900;

  #return $db_micro_line{title};
  $db_micro1 = $dbh->Query("SELECT name FROM markiza_sk.a020_cat WHERE ID='$db_micro_line{ID_cat}'");
  if (@db_micro1_line=$db_micro1->FetchRow()) { $db_micro_line{cat_name}=$db_micro1_line[0]; }

  #action="core.pl?type=$form{type}&id=$id&set=yes&image=$db_micro_line{xrelated}" method="POST">


########for testing purposes .. targeting into the same frame
  my $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td>
  <form name="indexesEdit_$id" action="core.pl?type=020-archiv-edit&ID=$id&set=yes" method="POST" enctype="multipart/x-form-data" target="frm_micro">
  </td><td width=100% style="FONT:10px Verdana;COLOR:white;">
  &nbsp;Relácia:<BR>
HEADER

  #<input type=hidden name="IDcategory" value="$db_micro_line{ID_cat}">

  $mdl_temp.=<<"HEADER";
  <span style="FONT:10px Verdana; font-weight: bold; width:445px;">&nbsp;&nbsp;&nbsp;$db_micro_line{cat_name}</span><BR>
  <input type=hidden value="$db_micro_line{time_from}" name="time_from">
  <input type=hidden value="$db_micro_line{time_to}" name="time_to">
HEADER

  my $mdl_micro;
  $db_micro1 = $dbh->Query("SELECT ID,name FROM markiza_sk.a020_cat ORDER BY name");
  while (@db_micro1_line=$db_micro1->FetchRow())
  {
   #$mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$db_micro1_line[0]';\">&nbsp;$db_micro1_line[0]</div>\n";
   $db_micro1_line[1]=~s|"||g;
   $db_micro1_line[1]=~s|'||g;
   $mdl_micro.=&select_add('value'=>$db_micro1_line[1],'html'=>$db_micro1_line[1]);
  }
  $mdl_temp.=&select_create(
 	'name'		=>	"arch_cat",
	'value'		=>	"vyberte kategoriu",
	'maxlength'	=>	30,
	'width'		=>	250,
	'height'	=>	200,
	'drag_resizeX'	=>	'-150',
	'select'	=>	$mdl_micro
  );

  $mdl_temp.="<table width=100% cellspacing=0 cellpadding=0 border=0><tr><td style=\"FONT:10px Verdana;COLOR:white;\"  width=\"50%\">&nbsp;Nahrávaný od/do:<br>";

  $mdl_temp.="<table cellspacing=2 cellpadding=0 border=0><tr><td colspan=16></td></tr><tr>";

  my $width0=30-12;
  my $width1=50-12;

  my $mdl_micro;
  for (my $i=1;$i<=31;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"day1",
	'value'		=>	$mdayR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  my $mdl_micro;
  @mesiac=("january","february","march","april","may","june","july","august","september","october","november","december");
  for (my $i=1;$i<=12;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i-$mesiac[$i-1]</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"mom1",
	'value'		=>	$momR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	90,
	'select'	=>	$mdl_micro
  )."</td>";



  my $mdl_micro;
  for (my $i=2000;$i<=2050;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"year1",
	'value'		=>	$yearR1,
	'maxlength'	=>	30,
	'width'		=>	$width1,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  $mdl_temp.="<td>&nbsp;</td>";


  my $mdl_micro;
  for (my $i=0;$i<=23;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"hour1",
	'value'		=>	$hourR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";

  $mdl_temp.="<td></td>";

  my $mdl_micro;
  for (my $i=0;$i<=55;$i=$i+5)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"min1",
	'value'		=>	$minR1,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  #$mdl_temp.="</table>";

  $mdl_temp.="</tr></table></td><td style=\"FONT:10px Verdana;COLOR:white;\">";
  $mdl_temp.="</td><td style=\"FONT:10px Verdana;COLOR:white;\" width=\"50%\" valign=\"bottom\">";

  #$mdl_temp.="<td nowrap>-</td>";

  $mdl_temp.="<table cellspacing=2 cellpadding=0 border=0><tr><td colspan=16 valign=\"top\"></td></tr><tr>";

  my $mdl_micro;
  for (my $i=1;$i<=31;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"day2",
	'value'		=>	$mdayR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  my $mdl_micro;
  @mesiac=("january","february","march","april","may","june","july","august","september","october","november","december");
  for (my $i=1;$i<=12;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i-$mesiac[$i-1]</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"mom2",
	'value'		=>	$momR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	90,
	'select'	=>	$mdl_micro
  )."</td>";



  my $mdl_micro;
  for (my $i=2000;$i<=2050;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"year2",
	'value'		=>	$yearR2,
	'maxlength'	=>	30,
	'width'		=>	$width1,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";


  $mdl_temp.="<td>&nbsp;</td>";


  my $mdl_micro;
  for (my $i=0;$i<=23;$i++)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"hour2",
	'value'		=>	$hourR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
 )."</td>";

  $mdl_temp.="<td></td>";

  my $mdl_micro;
  for (my $i=0;$i<=55;$i=$i+5)
  {
   $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
  }
  $mdl_temp.="<td>".&select_create(
 	'name'		=>	"min2",
	'value'		=>	$minR2,
	'maxlength'	=>	30,
	'width'		=>	$width0,
	'width1'	=>	50,
	'select'	=>	$mdl_micro
  )."</td>";

  $mdl_temp.="</tr></table></td></table>";


  $mdl_temp.=<<"HEADER";
  &nbsp;Popis:<br>
 <input type=text name="description" id="description" value="$db_micro_line{description}" class=input0 maxlength=260 style="FONT:9px Verdana;width:445px;" drag_resizeX='0'><BR>
  &nbsp;Indexácia: &lt;id=1-... value=mm:ss desc=text&gt;<br>
  <textarea name="indexes" style="width: 100%; font-size: 11px" rows="6"></textarea>
  <table height=16 width=100% cellspacing=0 cellpadding=0 border=0 background="$tom::H_media/grf/admin/win_top_0_back.gif"><tr><td width=50% align=right><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td><td><center><input type=submit drag_here value="Uložiť!" class=btn0 onclick="box_erase2();"></center></td><td align=left width=50%><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td></tr></table><br>
HEADER



=head1



  <TEXTAREA
	drag_resizeX='0'
	drag_resizeY='-300'
	name="indexes"
	id="indexes_all"
	class=input0
	style="width:445px;height:50px;FONT:12px Verdana;">$indexes</TEXTAREA><BR>
=cut



#<!-- <input type=hidden name=image value="$image_f"> /-->

  $mdl_temp.="</td><td></form></td></tr></table>";
  #$mdl_temp.="<script>lastOpenedArticleId=\"$db_micro_line{ID}\"; alert(lastOpenedArticleId);</script>";

my $box;

  $box=&box_create2("Vloženie archívneho záznamu",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp);


  return $box;

  return undef;
 }
}


1;
