sub BaseModul
{
	require "_table.m";
	require "_info.m";

	my $page_limit=20;
	my $page_from=$page_limit*$form{page};
	$form{page}="0" unless $form{page};

	######################################################
	# creating info panel                                                                #
	######################################################

	my $info=&info_create(
		'icon'	=>	"style=\"cursor:hand;\" onclick=\"load_box('core.pl?type=410-search');\"",
		'new'	=>	True,
		'title'	=>	"Zoznam článkov",
		'next'	=>	$form{page},
		'prev'	=>	$form{page}
	);
	my $select;

	for (my $i=0;$i<=55;$i=$i+5)
	{
		$select.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$i';\">&nbsp;$i</div>\n";
	}
	my $select_author=&select_create(
		'name'		=>	"min2",
		'value'		=>	$minR2,
		'maxlength'	=>	30,
		'width'		=>	1,
		'width1'	=>	50,
		'select'	=>	$select
	);

	my $db_micro2=$dbh->Query("SELECT ID FROM $MAIN_db_a410 ORDER BY length(ID) DESC LIMIT 1");
	if ($db_micro2) {my @db_micro_line2=$db_micro2->FetchRow(); $priority_depth=length($db_micro_line2[0])/2;}

	#return $db_micro_line2[0]." ".$priority_depth;

	######################################################
	# creating priority changers                                                       #
	######################################################

	my %plus;
 	my $i;

	for ($i=0;$i<=2;$i++)
	{
		$plus{'8.'.$i}{'id'}=$i;
		$plus{'8.'.$i}{'code'}="<a href=\"core.pl?type=priorize&priority_depth=".$i."&ID=<!--ID-->\" target=\"frm_micro\"><img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0></a>";
		$plus{'8.'.$i}{'class'}="td_inact";
		$plus{'8.'.$i}{'select'}="orderby=priority DESC,starttime";
		#$plus{'8.'.$i}{'td_class'}="td_act";
		$plus{'8.'.$i}{'td_plus'}="nowrap";
	}
	my $listingArchive;
	if ($form{archive} eq "1")
	{
		$listingArchive="archive=1&";
		#$plus2{'9.4'}{'id'}="forum_index";
		#$plus2{'9.4'}{'code'}="&nbsp;-<%1%>-&nbsp;";
		#$plus2{'9.4'}{'class'}="td_act";
		#$plus2{'9.4'}{'td_plus'}="nowrap align=\"center\"";
	}

 #-------------------ordering by az/za-----------------------------

 #my $orderbyShort="short";
 #my $orderbyShortCol="short_A_Z";
 #if ($form{'orderby'}=~/shortD/)
 #  { $form{'orderby'}=~s|shortD|short DESC|; }
 #else
 #  { if ($form{'orderby'}=~/short/) { $orderbyShort="shortD"; $orderbyShortCol="short_Z_A" } }

 #-------------------ordering by az/za-----------------------------

		######################################################
		# defining table layout                                                              #
		######################################################

	my $table=HP_TABLE->new(
		'title'			=>	"taky maly popis",
		#'cellspacing'	=>	1,
		#'cellpadding'	=>	1,
		#'color_active'	=>	"#F0F080",
		#'color_active'	=>	"#F0F0C0",
		'link_core'		=>	"core.pl?type=$form{type}&$listingArchive",
		'define'		=>
		{
			'1'	=>
			{
				'id'		=>	"A",
				'code'		=>	"<%1%>",
				#'code'		=>	"<img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0 onclick=\"this.src='core.pl?type=set_active&table=a410&ID=<!--ID-->';\">",
				'select'	=>	"orderby=active,starttime",
				'class'		=>	"td_act",
				#'td_class'	=>	"td_act"
			},
			'2'	=>
			{
				'id'		=>	"start",
				'code'		=>	"<%1%>",
				'select'	=>	"orderby=starttime",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'2.1'	=>
			{
				'id'		=>	"end",
				'code'		=>	"<%1%>",
				'select'	=>	"orderby=endtime",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'2.2'	=>
			{
				'id'		=>	"parent_cat",
				'code'		=>	"&nbsp;<a href=\"core.pl?type=41&<%1%>wherelike=IDcategory&where=<%2%>\" target=\"frm_base\"><%3%></a>",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'3'	=>
			{
				'id'		=>	"cF",
				'code'		=>	"<a href=\"core.pl?type=410&<%1%>wherelike=IDcategory&where=<%2%>\" target=\"frm_base\"><img src=\"$tom::H_media/grf/admin/tree_0.gif\" border=0></a>",
				'select'	=>	"orderby=IDcategory,starttime",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'3.1'	=>
			{
				'id'		=>	"cat",
				'code'		=>	"<a href=\"core.pl?type=410&<%1%>whereby=IDcategory&where=<%2%>\" target=\"frm_base\"><%3%></a>",
				'select'	=>	"orderby=IDcategory,starttime",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'4'	=>
			{
				'id'		=>	"title",
				'code'		=>	"&nbsp;<B><a href=\"javascript:load_box('core.pl?type=<%1%>-edit&<%2%>ID=<%3%>')\"><%4%></a></B>",
				'select'	=>	"orderby=title,starttime",
				'class'		=>	"td_act",
				'td_class'	=>	"td0",
				'td_plus'	=>	"nowrap"
			},
			'5'	=>
			{
				'id'		=>	"author",
			#	'id_plus'	=>	$select_author,
				'code'		=>	"&nbsp;<a href=\"core.pl?type=410&<%1%>whereby=IDauthor&where=<%2%>\" target=\"frm_base\"><%3%></a>&nbsp;",
				'select'	=>	"orderby=IDauthor,starttime",
				'plus'		=>	"nowrap",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'6.1'	=>
			{
				'id'		=>	"editor",
			#	'id_plus'	=>	$select_author,
				'code'		=>	"&nbsp;<a href=\"core.pl?type=410&<%1%>whereby=IDeditor&where=<%2%>\" target=\"frm_base\"><%3%></a>&nbsp;",
				'select'	=>	"orderby=IDeditor,starttime",
				'plus'		=>	"nowrap",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'7'	=>
			{
				'id'		=>	"img",
				'code'		=>	"&nbsp;<%1%>&nbsp;",
				'class'		=>	"td_inact",
				'td_plus'	=>	"nowrap"
			},
			'7.1'	=>
			{
				'id'		=>	"votes",
				'code'		=>	"&nbsp;<%1%>&nbsp;",
				'class'		=>	"td_inact",
				'td_plus'	=>	"nowrap"
			},
			%plus,
			'9'	=>
			{
				'id'		=>	"Vi",
				'code'		=>	"&nbsp;<a href=\"core.pl?type=410&".$listingArchive."orderby=visits\" target=\"frm_base\"><%1%></a>&nbsp;",
				'select'	=>	"orderby=visits",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap"
			},
			'9.1'	=>
			{
				'id'		=>	"relate",
				'code'		=>	"&nbsp;<a href=\"javascript:relate_item('a410','<%1%>');\">clanok</a><b style=\"font: 12px\">|</b><a href=\"javascript:relate_item('a410','<%1%>');\">relacia</a>&nbsp;",
				#'select'	=>	"orderby=visits",
				'class'		=>	"td_inact",
				'td_plus'	=>	"nowrap"
			},
			'9.2'	=>
			{
				'id'		=>	"archive",
			#	'code'		=>	"<img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0 onclick=\"this.src='core.pl?type=set_archive&table=a410&ID=<!--ID-->';\">",
				'code'		=>	"<a href=\"core.pl?type=set_archive&ID=<%3%>&archive=<%2%>\" target=\"frm_micro\"><img src=\"$tom::H_media/grf/admin/list_<%1%>.gif\" width=11 height=12 border=0></a>",
				'class'		=>	"td_inact",
				'td_plus'	=>	"align=center"
			},
			'9.3'	=>
			{
				'id'		=>	"forum_index",
				'code'		=>	"&nbsp;-<%1%>-&nbsp;",
				#'select'	=>	"orderby=visits",
				'class'		=>	"td_act",
				'td_plus'	=>	"nowrap align=\"center\""
			},
		}
	);

	######################################################
	# preparing WHERE clause for sql select                                     #
	######################################################

	my $where;
	if ($form{search} eq "1")
	{
		if (not $form{'title'} eq "")
		{ if ($where eq "") { $where.="WHERE title LIKE '%$form{title}%' " } else { $where.="title='%$form{title}%' " } }
		if ($form{'subtitle'})
		{ if ($where eq "") { $where.="WHERE title LIKE '%$form{subtitle}%' " } else { $where.="subtitle LIKE '%$form{subtitle}%' " } }
		if ($form{'IDauthor'})
		{ if ($where eq "") { $where.="WHERE IDauthor='$form{IDauthor}' " } else { $where.="AND IDauthor='$form{IDauthor}' " } }
		if ($form{'IDeditor'})
		{ if ($where eq "") { $where.="WHERE IDeditor='$form{IDeditor}' " } else { $where.="AND IDeditor='$form{IDeditor}' " } }
		if ($form{'IDcategory'})
		{
			my $varr;
			if ($form{'cat_allow_subs'} eq "1") { $varr="LIKE \'".$form{IDcategory}."%\'"; } else { $varr="=\'".$form{IDcategory}."\'"; }
			if ($where eq "") { $where.="WHERE IDcategory ".$varr." "; } else { $where.="AND IDcategory ".$varr." "; }
			undef $varr;
		}
		if ($form{'full'})
		{ if ($where eq "") { $where.="WHERE full LIKE '%$form{full}%'" } else { $where.="AND full LIKE '%$form{full}%' " } }
		#while ($form{wherestring}=~s|(.*?)=(.*?)&||)
		#{
		# $mdl_micro.="<div onclick=\"this.parentElement.parentElement.all['VALUE'].value='$sele{$_}';\" style=\"FONT:12px Verdana;\">&nbsp;$_</div>\n";
		#}
		#$where="WHERE

		if ($form{'archive'} eq '1') { $where.=" AND arch='Y'"; } else { $where.=" AND arch='N'"; }
	}
	else
	{
		$where="WHERE $form{whereby}='$form{where}'" if ($form{'whereby'});
		if ($form{'wherelike'})
		{ $where="WHERE $form{wherelike} LIKE '$form{where}%'" if ($form{'wherelike'} eq "IDcategory"); }
		else
		{ $where="WHERE $form{wherelike} LIKE '$form{where}%'" if ($form{'wherelike'}); }
		if ($form{'archive'} eq '1')
		{ if (($form{'whereby'}) || ($form{'wherelike'})) { $where.=" AND arch='Y'"; } else { $where.=" WHERE arch='Y'"; } }
		#else
		#{ if (($form{'whereby'}) || ($form{'wherelike'})) { $where.=" AND arch='N'"; } else { $where.=" WHERE arch='N'"; } }
	}

	######################################################
	# preparing ORDER BY clause for sql select                                 #
	######################################################

	my $orderby;
	if ($form{'orderby'}) { $orderby=$form{'orderby'}; } else { $orderby="starttime"; }

	my $db_micro = $dbh->Query("
		SELECT ID, IDlink, IDcategory, IDauthor, IDeditor, domain, title, starttime, endtime, votes, xrelated, lng, active
		FROM TOM.Ca410
		$where
		ORDER BY $orderby DESC
		LIMIT $page_from,$page_limit");

	######################################################
	# list generation                                                                       #
	######################################################

	if ($db_micro)
	{
		while (my %db_micro_line=$db_micro->FetchHash())
		{
			$thisOneIsLink=$db_micro_line{IDlink};

			while ($thisOneIsLink ne "0")
			{
				my $db_microx = $dbh->Query("
					SELECT ID, IDlink
					FROM TOM.Ca410
					WHERE ID='$thisOneIsLink'
					LIMIT 1
				");
				if ($db_microx)
				{
					if (my %db_microx_line=$db_microx->FetchHash()){$thisOneIsLink=$db_microx_line{IDlink};}
				}else {last;}
			}
			if ($thisOneIsLink ne "0"){next;}

			######################################################
			# creating activeness indicator                                                   #
			######################################################

			my $cl_active="r";
			if ($db_micro_line{'active'} eq "Y"){$cl_active="g"}

			######################################################
			# diversifying lines according to their timestamps                          #
			######################################################

			#today, yesterday, older line color
			#my $cl_color="#8FADF9";
			#if ($db_micro_line{starttime}>(time-86400)){$cl_color="#B0CFFF"}
			#if ($db_micro_line{starttime}>time){$cl_color="#E0EFFF"}
			#my $cl_class="tr1";

			my $cl_class="listing-old"; #today
			(undef,undef,undef,$mdayR1,$momR1,$yearR1,undef,undef,undef) = localtime(time);
			my $datestamp1=timelocal(0,0,0,$mdayR1,$momR1,$yearR1,0,0,0);
			my $datestamp2=$datestamp1+86400;
			if (($db_micro_line{starttime}>=$datestamp1-86400)&&($db_micro_line{starttime}<$datestamp1)){$cl_class="listing-yesterday"}
			if (($db_micro_line{starttime}>=$datestamp1)&&($db_micro_line{starttime}<$datestamp2)){$cl_class="listing-today"}
			if (($db_micro_line{starttime}>=$datestamp2)&&($db_micro_line{starttime}<$datestamp2+86400)){$cl_class="listing-tomorrow"}
			if (($db_micro_line{starttime}>=$datestamp2+86400)&&($db_micro_line{starttime}<$datestamp2+(2*86400))){$cl_class="listing-tomotomorrow"}
			if ($db_micro_line{starttime}>=$datestamp2+(2*86400)){$cl_class="listing-future"}

			my %survey_times;

			$survey_times{'starttime'}={Utils::datetime::ctodatetime($db_micro_line{'starttime'},format=>1)};
			$survey_times{'endtime'}={Utils::datetime::ctodatetime($db_micro_line{'endtime'},format=>1)};
			$survey_times{'changetime'}={Utils::datetime::ctodatetime($db_micro_line{'changetime'},format=>1)};
			#my $survey_times{'lasttime'}=TOM.ahawk::utils::datetime::ctodatetime($db_micro_line{'lasttime'},format=>1);

			######################################################
			# selecting author and editor                                                     #
			######################################################

			my $db_micro2=$dbh->Query("SELECT ID, nickname FROM $MAIN_db_a120 WHERE ID='$db_micro_line{'IDauthor'}' LIMIT 1");
			my @db_micro_line2=$db_micro2->FetchRow();
			$db_micro_line{'author_name'}=$db_micro_line2[1];

			my $db_micro2=$dbh->Query("SELECT ID, nickname FROM $MAIN_db_a120 WHERE ID='$db_micro_line{'IDeditor'}' LIMIT 1");
			my @db_micro_line2=$db_micro2->FetchRow();
			$db_micro_line{'editor_name'}=$db_micro_line2[1];

#=head1
				######################################################
				# looking for category                                                               #
				######################################################

			my $parent_cat;

			if (length($db_micro_line{IDcategory})>2)
			{
			my $where2="";
			$parent_cat=$db_micro_line{IDcategory};
			$parent_cat=~s|(^.*)..$||;
			$parent_cat=$1;
			$where2="OR ID='$parent_cat'";

			#return "SELECT ID, name FROM $MAIN_db_a410 WHERE ID='$db_micro_line{IDcategory}' $where2 LIMIT 1";
			my $db_micro2=$dbh->Query("SELECT ID, name FROM $MAIN_db_a410_category WHERE ID='$db_micro_line{'IDcategory'}' $where2 LIMIT 2");
			while (@db_micro_line2=$db_micro2->FetchRow())
			{
				$db_micro_line{'cat_name'}=$db_micro_line2[1] if ($db_micro_line2[0] eq $db_micro_line{'IDcategory'});
				$db_micro_line{'parent_cat_name'}=$db_micro_line2[1] if ($db_micro_line2[0] eq $parent_cat);
			}
			}
			else
			{
			my $db_micro2=$dbh->Query("SELECT ID, name FROM $MAIN_db_a410_category WHERE ID='$db_micro_line{'IDcategory'}' LIMIT 1");
			if (@db_micro_line2=$db_micro2->FetchRow())
			{
				$db_micro_line{'cat_name'}=$db_micro_line2[1];
			}
			}

			undef @db_micro2;
			undef @db_micro_line2;
#=cut
			######################################################
			# parsing out related items                                                        #
			######################################################

			$db_micro_line{'photo_count'}="0";
			$db_micro_line{'video_count'}="0";
			$db_micro_line{'audio_count'}="0";
			$db_micro_line{'archive_index_count'}="0";

			if ($db_micro_line{'xrelated'}=~s|<VAR id="a820" value="(.*?)" />||si)
			{$db_micro_line{'forum_id'}=$1;}
			else
			{$db_micro_line{'forum_id'}="XXX";}
			while ($db_micro_line{'xrelated'}=~s|<VAR id="a500" value="(.*?)" />||si)
			{$db_micro_line{'photo_count'}++;}
			while ($db_micro_line{'xrelated'}=~s|<VAR id="a510" value="(.*?)" />||si)
			{$db_micro_line{'video_count'}++;}
			while ($db_micro_line{'xrelated'}=~s|<VAR id="a510" value="(.*?)" />||si)
			{$db_micro_line{'audio_count'}++;}
			while ($db_micro_line{'xrelated'}=~s|<VAR id="a020" value="(.*?)" />||si)
			{$db_micro_line{'archive_index_count'}++;}

			######################################################
			# setting priority indicators                                                        #
			######################################################

			%plus={};
			my %priority_vals;
			$i=0;

			while ($db_micro_line{priority}=~s|(.)||)
			{
				if ($1 eq "2"){$priority_vals{$i}="g";}
				if ($1 eq "1"){$priority_vals{$i}="y";}
				if ($1 eq "0"){$priority_vals{$i}="r";}
				$i++;
			}
			for (my $i=0;$i<=$priority_depth;$i++)
			{if (exists $priority_vals{$i}){$plus{$i}{'1'}=$priority_vals{$i};}else{$plus{$i}{'1'}='r';}}

			######################################################
			# setting archive indicators                                                       #
			######################################################

			my $isFromArchive = "g";
			if ($db_micro_line{'arch'} eq "Y") { $isFromArchive = "g"; } else { $isFromArchive = "r"; }
			my $isFromArchive2 = "";
			if ($db_micro_line{'arch'} eq "Y") { $isFromArchive2 = "_arch"; }

			$listingArchive="";
			if ($isFromArchive eq "g") {$listingArchive="archive=1&";}

			######################################################
			# generating lines                                                                    #
			######################################################

			$table->add(
				'class'		=>	$cl_class,
				'color'		=>	$cl_color,
				'define'	=>
				{
					'A'	=>
					{
						'1'	=> "<img src=\"$tom::H_media/grf/admin/list_".$cl_active.".gif\" width=11 height=12 border=0 onclick=\"this.src='core.pl?type=set_active&db_name=TOM&table=Ca410&ID=<!--ID-->';\">"
					},
					'start'	=>
					{
						'1'=>"$survey_times{'starttime'}{mday}/$survey_times{'starttime'}{mom}/$survey_times{'starttime'}{year} $survey_times{'starttime'}{hour}:$survey_times{'starttime'}{min}"
					},
					'end'	=>
					{
						'1'=>"$survey_times{'endtime'}{mday}/$survey_times{'endtime'}{mom}/$survey_times{'endtime'}{year} $survey_times{'endtime'}{hour}:$survey_times{'endtime'}{min}"
					},
					'parent_cat'	=>
					{
						'1'=>"$listingArchive",
						'2'=>"$parent_cat",
						'3'=>"$db_micro_line{'parent_cat_name'}"
					},
					'cF'	=>
					{
						'1'=>"$listingArchive",
						'2'=>"$db_micro_line{'IDcategory'}",
					},
					'cat'	=>
					{
						'1'=>"$listingArchive",
						'2'=>"$db_micro_line{'IDcategory'}",
						'3'=>"$db_micro_line{'cat_name'}"
					},
					'title'	=>
					{
						'1'=>"$form{type}",
						'2'=>"$listingArchive",
						'3'=>"$db_micro_line{ID}",
						'4'=>"$db_micro_line{'title'}"
					},
					'author'	=>
					{
						'1'=>$listingArchive,
						'2'=>$db_micro_line{'IDauthor'},
						'3'=>$db_micro_line{'author_name'}
					},
					'editor'	=>
					{
						'1'=>$listingArchive,
						'2'=>$db_micro_line{'IDeditor'},
						'3'=>$db_micro_line{'editor_name'}
					},
					'img'	=>
					{'1'=>"$db_micro_line{'photo_count'}"},
					'votes'	=>
					{
						'1'=>"$db_micro_line{'votes'}"
					},
					%plus,
					'Vi'	=>
					{
						'1'=>"$db_micro_line{'visits'}"
					},
					'relate'	=>
					{
						'1'=>"$db_micro_line{'ID'}"
					},
					'archive'	=>
					{
						'1'	=>	$isFromArchive,
						'2'  =>   $db_micro_line{'arch'},
						'3'  =>   $db_micro_line{'ID'}
					},
					'forum_index'	=>
					{
						'1'=>"$db_micro_line{'forum_id'}"
					},
					'replace'	=>
					{
						'ID'	=>	$db_micro_line{ID}
					}
				}
			);
		}
	}
	return $info.$table->HTML;
}
1;
