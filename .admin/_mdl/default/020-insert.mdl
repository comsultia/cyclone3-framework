sub BaseModul
{
#package Tomahawk::module;
use Text::Iconv;
use Time::Local;
use Mysql;

# Character before rating score ;)
$RATING_CHAR='';
$RATING_CHAR2='\*';
$GENRE_CHAR='<G>';

# DB SETUP
my $SRV="192.168.1.20";
my $DB="markiza_sk";
my $USR="TOM";
my $PWD="kulume";

my $DBase=Mysql->Connect($SRV,$DB,$USR,$PWD);
$DBase->SelectDB($DB);

# Convert DayOfWeek 2 Number index
sub DOW2NUM
{
my $day=$_[0];
if($day=~/PON/i){return 1;}
if($day=~/UTO/i){return 2;}
if($day=~/STR/i){return 3;}
if($day=~/RTOK/i){return 4;}
if($day=~/PIAT/i){return 5;}
if($day=~/SOBO/i){return 6;}
if($day=~/NEDE/i){return 7;}
return -1;
}

# Find Station ID
sub FINDSTATIONID
{
	my $Res=$DBase->Query("SELECT * FROM a021_tv");
	while (my %Line = $Res->FetchHash)
	{
		#if (($Line{short} eq $_[0]) || ($Line{search}=~/$_[0]/) || ($Line{name}=~/^$_[0]/))
		if ($Line{short} eq $_[0])
		{
			return $Line{ID};
		}
	}
	return -1;
}

# Dump Station Data for given day :)
sub DUMPSTATION
{
	# Input
	my $DATE_STAMP=$_[0];
	my $STATION_ID=$_[1];

	# Execute
	my $Res=$DBase->Query("DELETE FROM a021_program WHERE ID_tv='$STATION_ID' AND datestamp='$DATE_STAMP'");
}

# Find ok make new category 4 ID_TV=0000 !
sub FINDMAKECAT
{
	my $CAT_NAME=PREP($_[0]);
	# Fook counts
	$CAT_NAME=~s| (.*?)/(.*?) ||g;
#	$CAT_NAME=~s| \w\w?\w? ||g;

	my $Res=$DBase->Query("SELECT * FROM a020_cat WHERE name LIKE '$CAT_NAME' OR keywords LIKE '$CAT_NAME' OR short LIKE '$CAT_NAME' LIMIT 1");
	while (my %Line = $Res->FetchHash)
	{
		return $Line{ID};
	}
	$Res=$DBase->Query("INSERT INTO a020_cat ( name, short, keywords ) VALUES ( '$CAT_NAME', '$CAT_NAME', '$CAT_NAME')");
	return $Res->insert_id;

}


# Prepare string before insert
sub PREP
{
	my $RET=$_[0];
	$RET=~s/'/\\'/g;
	$RET=~s|\s| |g;
	$RET=~s|\s$||;
	$RET=~s|^\s||;
	$RET=~s/<#NL#>/ /g;
	#$RET=~s|/|\\/|;
	return $RET;
}

# Insert new TV event
sub INSERTEVENT
{
	# Input
	my $ID_TV=$_[0];
	my $NAME=$_[1];
	my $HOUR=$_[2];
	my $MIN=$_[3];
	my $END_HOUR=$_[4];
	my $END_MIN=$_[5];
	my $DESCR=$_[6];
	my $RATING=$_[7];
	my $MIDNIGHT=$_[8];
	my $RATING=$_[9];
	my $DAY=$_[10];
	my $DATE_STAMP=$_[11];
	my $SOUND=$_[12];
	my $GENRE=$_[13];

	# Deduction
	my $ID_CAT=0;
	my $IS_THERE='N';
	if ($HOUR>$END_HOUR) { $END_HOUR+=24; }
	my $LENGTH=($END_HOUR-$HOUR)*60+($END_MIN-$MIN);
	my $START_STAMP=$DATE_STAMP+$HOUR*3600+$MIN*60;
	my $END_STAMP=$START_STAMP+$LENGTH*60;
	if ($MIDNIGHT) { $MIDNIGHT='Y'; $START_STAMP+=24*3600; $END_STAMP+=24*3600} else { $MIDNIGHT=''; }

	# Find CAT 4 markiza !
	if ($ID_TV=="0000") { $ID_CAT = FINDMAKECAT($NAME); }

	# Insert
	my $Res=$DBase->Query("INSERT INTO a021_program
				(ID_tv
				,ID_cat
				,name
				,isthere
				,sound
				,day
				,datestamp
				,start_hour
				,start_min
				,description
				,rating
				,midnight
				,start_stamp
				,end_stamp
				,length
				,genre)
				VALUES
				('$ID_TV'
				,'$ID_CAT'
				,'".PREP($NAME)."'
				,'$IS_THERE'
				,'".PREP($SOUND)."'
				,'$DAY'
				,'$DATE_STAMP'
				,'$HOUR'
				,'$MIN'
				,'".PREP($DESCR)."'
				,'$RATING'
				,'$MIDNIGHT'
				,'$START_STAMP'
				,'$END_STAMP'
				,'$LENGTH'
				,'$GENRE')");
}

 #my $id=$form{id} if ($form{id});
 #my $indexes;
 my $mdl_temp;
 if ($form{set})
 {
	#beginning of tv import routines

	# Load and convert program to utf8
	my $conv = Text::Iconv->new("UTF8", "UTF8");
	my $PRG; # <= INPUT FILE
	my $LOG; # <= ERROR LOG

	### !!!! DEBOT >>> ZMEN NA VSTUP Z ADMINU (DO PREMENNEJ $PRG
	#open (INFILE, "<tv_taker_2.txt");
	#importing form data instead of text file

	#$PRG=$form{program_data}; ???

	#while (<INFILE>)
	#{
	#	$PRG.=$_;
	#}
	$PRG=$form{program_data};


	$PRG = $conv->convert($PRG);
	### !!!! DEBOOT >>> END

#open (OUTFILE, ">tmp.txt");
#print OUTFILE $form{program_data};

#return 1;

	# Little newline hack :) (simpler regexps)
	$PRG=~s|\r||g;
	$PRG=~s/\n\n/<#BLOCK#>/g;
	$PRG=~s/\n/<#NL#>/g;

=head1
  $HTML_HEADER{BODY}{extract}="yes";

   $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
  <br><textarea rows=10 cols=50>$PRG</textarea><br><br><br><br>
  </td></tr></table>
HEADER


  my $box=&article_box_create("Vysledok konverzie",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp,);

  return $box;
=cut

	# Find TV_blocks
	# a little hack .. fsckin admin somehow fucks up the newlines .. so it returned nl.nl instead of block
	#while ($PRG=~s/(.*?)<#BLOCK#>//)

	#my $haluz="";

	while ($PRG=~s/(.*?)<#BLOCK#>//)
	{
		#$haluz.="new block found\n";

		# Have 1 station block :)
		my $STATION_BLOCK=$1;

		# get Station name
		$STATION_BLOCK=~s/(.*?)<#NL#>(.*?)<#NL#>//;
		my $STATION=$1;

		# get Station ID
		my $STATION_ID=FINDSTATIONID($STATION);
		if ($STATION_ID==-1)
		{
			$LOG.="ERROR: Unknown station \"$STATION\" : STATION SKIPPED!\n";
			next;
		}

		# get DATE to update
		my $DATE_BLOCK=$2;

		$DATE_BLOCK=~s/(.*?) //;
		my $DOW=DOW2NUM($1);
		if($DOW==-1)
		{
			$LOG.="ERROR: Urecognized DayOfWeek \"$1\" for station $STATION : STATION SKIPPED!\n";
			next;
		}

		$DATE_BLOCK=~s/\s//g;
		if(not $DATE_BLOCK=~/^(\d*?)\.(\d*?)\.(\d*?)$/)
		{
			$LOG.="ERROR: Incorrect Date format for station $STATION : STATION SKIPPED!\n";
			next;
		}

		my $DAY=$1;
		my $MON=$2;
		my $YEAR=$3;

		my $DATE_STAMP=timelocal(0,0,0,$DAY,$MON-1,$YEAR-1900);

	#print "$STATION($STATION_ID)\n$DAY.$MON.$YEAR ($DATE_STAMP)\n$DOW\n";

		# Dump previous records
		DUMPSTATION($DATE_STAMP,$STATION_ID);

	<#EVENT#>telerano<#NL#>s janom a jozom<#EVENT#>

		# Prepare & Find Events
		$STATION_BLOCK=~s/<#NL#>(\d+)\.(\d+) /<#EVENT#>\$1\.\$2/g;
		#$STATION_BLOCK=~s/<#NL#>(?=[0-9])/<#EVENT#>/g;
		$STATION_BLOCK.="<#EVENT#>";
		# After Midnight ??
		my $MIDNIGHT=0;
		my $EVENT_NO=0;
		while ($STATION_BLOCK=~s/(.*?)<#EVENT#>//)
		{

			# Event Number
			$EVENT_NO++;

			# Have 1 event block :)
			my $EVENT_BLOCK=$1;
			$EVENT_BLOCK=~s/<#EVENT#>//g;

			# Clean useless whitespace
			$EVENT_BLOCK=~s/\s/ /g;

			# Get HOUR and MIN;
			#if (not $EVENT_BLOCK=~s/^(\d*?)\.(\d*?) // )
			if (not $EVENT_BLOCK=~s/^(\d+)\.(\d+) // )
			{
				$LOG.="ERROR: Wrong event format for station $STATION event #$EVENT_NO : EVENT SKIPPED!\n";
				next;
			}
			my $HOUR=$1;
			my $MIN=$2;

			# Get Genere if present
			my $GENRE="";
			if ($EVENT_BLOCK=~s/$GENRE_CHAR(.*?)\s// )
			{
				$GENRE=$1;
			}

			# Get END_HOUR and END_MIN if present
			my $END_HOUR=$HOUR;
			my $END_MIN=$MIN;

			if ($STATION_BLOCK=~/(\d+)\.(\d+) / )
			{
				$END_HOUR=$1;
				$END_MIN=$2;
			}

			# Get DESCRIPTION if present
			my $DESCRIPTION="";
			if ($EVENT_BLOCK=~s/<#NL#>(.*?)$//)
			{
				$DESCRIPTION=$1;
			}

			# Set SOUND if present
			my $SOUND='';
			if ($EVENT_BLOCK=~s/-(..?)-//)
			{
				$SOUND=$1;
			}

			# Set RATING if present
			my $RATING=0;
			if ($EVENT_BLOCK=~s/$RATING_CHAR({6|7|8|9|12|13|15|16|18})//)
			{
				$RATING=$1;
			}
			elsif ($EVENT_BLOCK=~s/$RATING_CHAR2({6|7|8|9|12|13|15|16|18})//)
			{
				$RATING=$1;
			}


			# Get TITLE (Everything left should be the title ;)
			$TITLE=$EVENT_BLOCK;

			INSERTEVENT($STATION_ID,$TITLE,$HOUR,$MIN,$END_HOUR,$END_MIN,$DESCRIPTION,$RATING,$MIDNIGHT,$RATING,$DOW,$DATE_STAMP,$SOUND,$GENRE);

			# Event after midnight ?
			if ($HOUR>$END_HOUR) { $MIDNIGHT=1; }
		}
	}


=head1
  $HTML_HEADER{BODY}{extract}="yes";

   $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
  <br><textarea rows=10 cols=50>$haluz</textarea><br><br><br><br>
  </td></tr></table>
HEADER


  my $box=&article_box_create("Vysledok konverzie",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp,);

  return $box;
=cut


### !!!! DEBOOT >>> V $LOG SU ERRORS !
#print "ERRORS:\n$LOG";

  #	$LOG=$form{program_data};

  $HTML_HEADER{BODY}{extract}="yes";

  if($LOG eq ""){$LOG="OK";}

   $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td width=100% style="FONT:10px Verdana;COLOR:white;">
  <br>&nbsp;$LOG<BR><br><br><br><br>
  </td></tr></table>
HEADER


  my $box=&article_box_create("Vysledok konverzie",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp,);

  return $box;

 }
 else #tu je ten predel dopice tam!!!------------------------------------------------------------------------------------------------------
 {
  $HTML_HEADER{BODY}{extract}="yes";
  #$HTML_HEADER{BODY}{onunload}="parent.box_loading.style.display='block';";


########for testing purposes .. targeting into the same frame
#<form name="articleEdit\_$id" action="core.pl?type=020-insert&set=yes" method="POST" enctype="multipart/x-form-data" target="frm_micro">

  my $mdl_temp=<<"HEADER";
  <table width=100% cellspacing=0 cellpadding=0 border=0><tr><td>
  <form name="articleEdit\_$id" action="core.pl?type=020-insert&set=yes" method="POST" enctype="multipart/x-form-data" target="frm_micro">
  </td><td width=100% style="FONT:10px Verdana;COLOR:white;">
  <br>&nbsp;Sem vložte televízny program skopírovaný z MS Word:<BR>
HEADER

  $mdl_temp.=<<"HEADER";
  <TEXTAREA
	drag_resizeX='0'
	drag_resizeY='-300'
	name="program_data"
	class=input0
	style="width:445px;height:250px;FONT:12px Verdana;"></TEXTAREA><BR>
  <table height=16 width=100% cellspacing=0 cellpadding=0 border=0 background="$tom::H_media/grf/admin/win_top_0_back.gif"><tr><td width=50% align=right><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td><td><center><input type=submit drag_here value="Vložiť!" class=btn0 onclick="box_erase2();"></center></td><td align=left width=50%><img src="$tom::H_media/grf/admin/win_top_0_del.gif" border=0><BR></td></tr></table>
HEADER

  $mdl_temp.="</td><td></form></td></tr></table>";

  my $box=&article_box_create("Vloženie televizneho programu",
	'color_base0'	=>	"#0B63F1",
	'width'			=>	200,
	'height'		=>	50,
	'close'			=>	"yes",
	'html'			=>	$mdl_temp,
	'article_id'			=>	$id,);

  return $box;

  return undef;
 }
}


1;
