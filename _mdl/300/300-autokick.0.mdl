#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;
=head1 NAME
menu

=head1 HEAD_VERSION_BUILD
2.030823

=head1 DESCRIPTION
zakladne spracovanie poziadaviek USRM na pozadi
upravuje hlavne pole $main::USRM pre volne
pouzitie v TOM3 a v moduloch (nemodifikovat!!!)

=head1 XMLDESCRIPTION

<DESCRIPTION>

        <value id="preview" value="0" />
        <value id="output" value="shadow" />

	<source type="db.table" value="X.a300_online" />
	<source type="db.table" value="X.a300_users" />
	<source type="db.table" value="X.a300_users_attrs" />
	<source type="db.table" value="X.a300_users_arch" />
	<source type="db.table" value="X.a300_users_attrs_arch" />

</DESCRIPTION>


=head1 CHANGES
build 030822 - Aben
        *) uprava pre automaticke stahovanie dat z attrs
	   a hlavnej tabulky do pola %main::USRM
build 030822 - Aben
        *) FIRST MAKE

=head1 WARNINGS & BUGS
        *) nothings
=cut

sub execute
{
 #return 1;
 my %env=@_;
 $env{online}=60*20 unless $env{online};

 my $db0=$main::DBH->Query("
	SELECT *
	FROM $TOM::DB_name_USRM.a300_online
	WHERE	host='$tom::H_cookie'
		AND
		(
		reqtime<$tom::time_current-$env{online}
		OR active='N'
		)
	");
 while (my %user=$db0->fetchhash)
 {
#=head1
  Tomahawk::debug::log(1,"kick user ".$user{IDhash},0,"USRM");
  Tomahawk::debug::log(1,"reqtime ".$user{reqtime},0,"USRM");
  Tomahawk::debug::log(1,"currtime ".$tom::time_current,0,"USRM");
  my $db0=$main::DBH->Query("
	SELECT *
	FROM $TOM::DB_name_USRM.a300_users
	WHERE	IDhash='$user{IDhash}' AND host='$tom::H_cookie' LIMIT 1");
  if (my %user0=$db0->fetchhash)
  {
   Tomahawk::debug::log(2,"ok, existuje",0,"USRM");
   Tomahawk::debug::log(2,"som lognuty",0,"USRM") if ($user{logged} eq "Y");
   Tomahawk::debug::log(2,"nelognuty",0,"USRM") if ($user{logged} ne "Y");

   Tomahawk::debug::log(2,"anonymny user",0,"USRM") if (!$user0{login});
   Tomahawk::debug::log(2,"autorizovany user",0,"USRM") if ($user0{login});

   if	(
   		(($user{logged} eq "Y")&&($user0{login}))
		||(($user{logged} ne "Y")&&(!$user0{login}))
   	)
   {
    Tomahawk::debug::log(2,"prevediem zapis",0,"USRM");
    #logtime, reqtime, IPlast, cookies, rqs
    $user0{cookies}="";
    while ($user{cookies}=~s|<VAR id="(.*?)">(.*?)</VAR>||)
    {
     my $var=$1;
     my $value=$2;
     if ($var=~/^_/){$user0{cookies}.="<VAR id=\"".$var."\">".$value."</VAR>\n";next}
    }
    Tomahawk::debug::log(2,"cookies = ".$user0{cookies},0,"USRM");
    $main::DBH->Query("
	UPDATE $TOM::DB_name_USRM.a300_users
	SET	logtime	= '$user{logtime}',
		reqtime	= '$user{reqtime}',
		IPlast	= '$user{IP}',
		rqs	= rqs+$user{rqs},
		cookies	= '$user0{cookies}'
	WHERE	IDhash='$user{IDhash}' AND host='$tom::H_cookie' LIMIT 1");
    $main::DBH->Query("
	DELETE FROM $TOM::DB_name_USRM.a300_online
	WHERE host='$tom::H_cookie' AND IDhash='$user{IDhash}' LIMIT 1");
   }
   else
   {
    Tomahawk::debug::log(2,"neprevediem zapis",0,"USRM");
    $main::DBH->Query("
	DELETE FROM $TOM::DB_name_USRM.a300_online
	WHERE host='$tom::H_cookie' AND IDhash='$user{IDhash}' LIMIT 1");
   }

  }
  else
  {
   Tomahawk::debug::log(2,"ved neexistuje! ",0,"USRM");
  }
#=cut
 }

 return 1}

		#AND reqtime<$tom::current-$env{online}

1;























