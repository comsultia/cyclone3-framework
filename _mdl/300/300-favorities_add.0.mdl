#!/bin/perl
# áéíóú - USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;


sub execute
{
 my %env=@_;
 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
 Tomahawk::GetXLNG() || return undef; # NATIAHNEM XML LANGUAGE
 Tomahawk::XLNGtoXSGN(); # insert XLNG do XSGN

# if (!)
 return undef unless $env{ID};
 return undef unless $env{app};
 
 if ($main::USRM{logged} ne "Y")
 {
  if ($env{popup}){if ($env{popup}){$main::H->rh("<%ONLOAD%>","window.focus();setTimeout('window.close()',5000);");}}
  $XSGN{TMP}=$XSGN{notlogged};return 1
 }

 my $data=$main::USRM{favorities};

 if (length($data)>50000)
 {
  if ($env{popup}){if ($env{popup}){$main::H->rh("<%ONLOAD%>","window.focus();setTimeout('window.close()',5000);");}}
  $XSGN{TMP}=$XSGN{full};return 1
 }

 my $data2;
 my $count;
 while ($data=~s|<VAR (.*?)/>||)
 {
  $count++;
  my %env0=CML::VARhash($1);
  if (($env0{app} eq $env{app})&&($env0{id} eq $env{ID}))
  {$XSGN{TMP}=$XSGN{added};
   if ($env{popup}){$main::H->rh("<%ONLOAD%>","window.focus();setTimeout('window.close()',5000);");}
   return 1;
  }
  $data2.="<VAR ";foreach (sort keys %env0){$data2.=$_."=\"".$env0{$_}."\" "}$data2.="/>\n";
 }
 $data2.="<VAR app=\"".$env{app}."\" id=\"".$env{ID}."\" time=\"".$tom::time_current."\" />";
 $count++;
 $main::USRM{favorities}=$data2;

#=head1
 $main::DBH->Query("
 	UPDATE $TOM::DB_name_USRM.a300_users_attrs
	SET	favorities='$main::USRM{favorities}'
	WHERE	IDhash='$main::USRM{IDhash}'
	LIMIT 1
	");
#=cut

 $XSGN{TMP}=$XSGN{nowadded};
 my $var=(int((length($main::USRM{favorities})/1024)*100))/100;
 $XSGN{TMP}=~s|<%COUNT%>|$count|g;
 $XSGN{TMP}=~s|<%CAPACITY%>|$var|g;

 if ($env{popup}){if ($env{popup}){$main::H->rh("<%ONLOAD%>","window.focus();setTimeout('window.close()',5000);");}}

 return 1}

1;
