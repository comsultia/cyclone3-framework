#!/usr/bin/perl
# áéíóú - USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;

sub execute
{

 #Tomahawk::debug::mdllog(0,"ideme na tooo! :)");

  my %env=@_;
  my %datevars=Utils::datetime::ctodatetime($tom::time_current);
  $env{datestamp}=Time::Local::timelocal(undef,undef,undef,$datevars{mday},$datevars{mom}-1,$datevars{year}-1900,undef,undef,undef) unless ($env{datestamp});
  my %tmp=Utils::datetime::ctodatetime($env{datestamp});
  $env{tab_day}=$tmp{wday};
  undef %tmp;
  if($env{tab_day} eq "0"){$env{tab_day}=7};
  $env{max}=5 unless ($env{max});

=head1
  my %datestamps;
  my $tempstamp=$env{datestamp};
  $tempstamp-=($env{tab_day}*86400);
  my $var=0;
  while ($var <= 9)
  {
   $datestamps{$var}=$tempstamp;
   $tempstamp+=86400;
   $var++;
  }
=cut
#=head1
	my @datestamps;
	my $var=$env{tab_day};
	my $tempstamp=$env{datestamp};
	while ($var > 0)
	{
	   $datestamps[$var]=$tempstamp;
	   $env{temp_select}.=" OR datestamp='$tempstamp'";
	   $tempstamp-=86400;
	   $var--;
	}

	$datestamps[0]=$tempstamp-((7-$env{max})*86400);
	$env{temp_select}.=" OR datestamp='$datestamps[0]'";

	$tempstamp=$env{datestamp};

	$var=$env{tab_day};
	while ($var <= 9)
	{
	   $datestamps{$var}=$tempstamp;
	   $env{temp_select}.=" OR datestamp='$tempstamp'";
	   $tempstamp+=86400;
	   $var++;
	}

	#$datestamps{8}=$tempstamp+((7-$env{max})*86400);
	#$datestamps{9}=$datestamps{8}+86400;
#=cut


=head1
  while ($var < 0)
  {
   $datestamps{$var}=$tempstamp2;
   $tempstamp2-=86400;
   $var--;
  }
  $datestamps{0}=$tempstamp2-((7-$env{max})*86400);
  $tempstamp2=$env{datestamp};
  $var=$env{tab_day};
  while ($var <= $env{max})
  {
   $datestamps{$var}=$tempstamp2;
   $tempstamp2+=86400;
   $var++;
  }
  $datestamps{8}=$tempstamp2+((7-$env{max})*86400);
  $datestamps{9}=$datestamps{8}+86400;
=cut

=head1
  if ($main::IAdm){
  $XSGN{TMP}.="weekday - $env{datestamp} $env{tab_day} <BR/>\n";
  foreach (sort keys %datestamps)
  {
	next if (($_ > $env{max}) && ($_ ne 8));
	my %datevarsx=Utils::datetime::ctodatetime($datestamps{$_});
	if (my $db0=$main::DBH->Query("
		SELECT
			ID,title
		FROM $env{db_400}.a400
		WHERE
			IDcategory='$env{IDcategory}'
			AND starttime>'$datestamps{$_}'
			AND starttime<'$datestamps{$_+1}'
		LIMIT 1
		"))
	{
		if(my %db0_line=$db0->FetchHash())
		{
			$XSGN{TMP}=~s|<%TAB_$_%>||;
			$XSGN{TMP}.="--- starttime>'$datestamps{$_}' AND starttime<'$datestamps{$_+1}' ---<br>datestamp $datestamps{$_} - $_ ::::  :::: ".($datevarsx{mday}).",".$datevarsx{mom}.",".$datevarsx{year}." - found article $db0_line{ID} - $db0_line{title}!!! :o) <BR/>";
		}
		#if($_-1){$var=$XSGN{DAY_TAB_ACTIVE};}
		else
		{
		$XSGN{TMP}.="--- starttime>'$datestamps{$_}' AND starttime<'$datestamps{$_+1}' ---<br>datestamp $datestamps{$_} - $_ ::::  :::: ".($datevarsx{mday}).",".$datevarsx{mom}.",".$datevarsx{year}." - no article :o(((<BR/>\n";
		}
 	}
    #if ($env{datestamp} ne $datestamps{$_}){$env{temp_select}.=" OR datestamp='$datestamps{$_}'";}##
  }
#=head1
		if ($main::IAdm){$XSGN{TMP}.="
		SELECT
			datestamp
		FROM $env{db_021}.a021_program
		WHERE
			ID_tv='$env{default_tv}'
			AND
			(datestamp='$env{datestamp}'$env{temp_select})
		GROUP BY
			datestamp
		ORDER BY
			start_stamp
		";}
#=cut
	   }

=cut

	  my @tab_activations=("0","0","0","0","0","0","0","0","0");

	  if (my $db1=$main::DBH->Query("
		SELECT
			datestamp
		FROM $env{db_021}.a021_program
		WHERE
			ID_tv='$env{default_tv}'
			AND
			(datestamp='$env{datestamp}'$env{temp_select})
		GROUP BY
			datestamp
		ORDER BY
			start_stamp
		"))
	  {
		while(my %db1_line=$db1->FetchHash())
	  	{
			my $tempkey=(grep {$datestamps[$_] eq $db1_line{datestamp}} keys %datestamps)[0];
			$tab_activations[$tempkey]="1";
=head1
			if ($main::IAdm)
			{
				$XSGN{TMP}.="$db1_line{datestamp}<br/>";
				$XSGN{TMP}.="$tempkey<br/>";
				$XSGN{TMP}.="activations[$tempkey]=1 $tab_activations[$tempkey]------- $db1_line{datestamp} - $datestamps{$tempkey} ----<br/>";
			}
=cut
	  	}
		foreach (sort @datestamps)
		{
			my $tmp;
			if ($datestamps[$_] eq $env{datestamp})
			{if ($tab_activations[$_] eq "1") {$var=$XSGN{DAY_TAB_ACTUAL};} else {$var="";}}
			elsif ($_ eq "0")
			{if ($tab_activations[0] eq "1") {$var=$XSGN{PREV_WEEK};} else {$var="";}}
			elsif ($_ eq "8")
			{if ($tab_activations[8] eq "1") {$var=$XSGN{NEXT_WEEK};} else {$var="";}}
   			else
			{if ($tab_activations[$_] eq "1") {$var=$XSGN{DAY_TAB_ACTIVE};} else {$var=$XSGN{DAY_TAB_INACTIVE};}}
			$var=~s|<%ID%>|$_|;
			$var=~s|<%DATESTAMP%>|$datestamps[$_]|;
			my %datevarsx=Utils::datetime::ctodatetime($datestamps[$_]);
			$XSGN{TMP}=~s|<%TAB_$_%>|$var|;
		}
	  }
#=cut

  #TABBER
  Tomahawk::module(
	-type			=>	"mdl",
	-category		=>	"0",
	-name			=>	"tabber",
	-global			=>	2,
	-xsgn     		=>	$env{xsgn_fview},
	-xsgn_global		=>	2,
	-TMP			=>	"BASE-CONTENT-LEFT"
		datestamps	=>
	)

  # TELO CLANKU
=head1
  Tomahawk::module(
	-type			=>	"mdl",
	-category		=>	"400",
	-name			=>	"fview",
	-global			=>	1,
	-xsgn     		=>	$env{xsgn_fview},
	-xsgn_global		=>	$env{xsgn_global},
	-TMP			=>	$env{TMP_view},
	%caching,
	-cache_id_sub		=>	$article{_a400_ID}."-".$article{_a400_changetime},
	shift_first_img		=>	$env{shift_first_img},# vytiahnem prvu premennu obrazku
	show_catname		=>	$env{show_catname},
	show_catname_full	=>	$env{show_catname_full},
	db_500			=>	$env{db_500},
	format_500		=>	$env{format_500},
	first_format_500	=>	$env{first_format_500},
	page			=>	$main::FORM{page}, # nefunkcne, len posielam linku
	a900_inline		=>	$env{a900_inline},
	%article,
	) if (exists $env{TMP_view});
=cut



 return 1;
}
1;
