#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
our $authors = 'nemsak@webcom.sk';
use strict;

sub execute
{
	my %env=@_;
	
	Tomahawk::GetXSGN(-convertvars=>1) || return undef; # load design file
	
	if (($env{xt_xlng}) || ($env{xlng}))
	{
		main::_log("using xlng transformation");
		if ($env{xlng}) { main::_log("WARNING! using deprecated parameter 'xlng'! please, use 'xt_xlng';"); }
		Tomahawk::GetXLNG() || return undef; # retrieve language xml
		Tomahawk::XLNGtoXSGN(); # implement XLNG into XSGN
	}
	
	my $lngstring="";
	$lngstring = "AND lng='$env{db_lng}'" if$env{db_lng};
	
	if((!$env{db_ID}) || (!$env{db_private}))
	{
		$XSGN{TMP}=$XSGN{RESULT_failure_no_input};
		if(!$env{db_private}) {$XSGN{TMP}=~s|<%missing_parameter%>|db_private|;}
		if(!$env{db_ID}) {$XSGN{TMP}=~s|<%missing_parameter%>|db_ID|;}
	}
	else
	{
		$env{db_400}=Tomahawk::Getmdlvar("400","db") unless $env{db_400};
		$env{db_400}=$TOM::DB{main}{name} unless $env{db_400};
		
		my $success;
		my $db;
		my %db_line;
		
		#TODO: nemsak - dorobit kontrolu ci sme dostali viac riadkov alebo len jeden - zavisi od toho vystup - napriklad:
		# chceme nastavit private na "Y", a neposleme lng - mame tri mutacie, z ktorych jedna je D, druha Y, a tretia N
		# musime odignorovat tuto kontrolu, pretoze netusime, ktoru z mutacii mame skontrolovat proti "Y"
		
		$db=$main::DB{main}->Query("
			SELECT
				ID,private
			FROM
				$env{db_400}.a400
			WHERE
				ID='$env{db_ID}'
				$lngstring
		");
		if($db)
		{
			if(%db_line=$db->FetchHash())
			{
				$success=1;
			}
		}
		
		if($success)
		{
			if($db_line{private} eq $env{db_private})
			{
				$XSGN{TMP}=$XSGN{RESULT_failure_equal};
			}
			else
			{
				$db=$main::DB{main}->Query("
					UPDATE
						$env{db_400}.a400
					SET
						private='$env{db_private}'
					WHERE
						ID='$env{db_ID}'
						$lngstring
				");
				if($db)
				{
					$XSGN{TMP}=$XSGN{RESULT_success};
				}
				else
				{
					$XSGN{TMP}=$XSGN{RESULT_failure_set};
				}
			}
		}
		else
		{
			$XSGN{TMP}=$XSGN{RESULT_failure_no_data};
		}
	}
	
	$XSGN{TMP}=~s|<%IDapp%>|a400|g;
	$XSGN{TMP}=~s|<%ID%>|$env{db_ID}|g;
	$XSGN{TMP}=~s|<%private%>|$env{db_private}|g;
	$XSGN{TMP}=~s|<%lng%>|$env{db_lng}|g;
	
	return 1;
}

1;