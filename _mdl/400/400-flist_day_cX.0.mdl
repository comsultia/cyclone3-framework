#!/bin/perl
# áéíóú - USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;
#use Tomahawk::Apps::500;
#use Tomahawk::addon::DBH;
#use Tomahawk::Apps;
#getApps;

sub execute
{
 my %env=@_;
 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
 #Tomahawk::GetXLNG() || return undef; # NATIAHNEM XML LANGUAGE

 $env{db_400}=Tomahawk::Getmdlvar("400","db") unless $env{db_400};
 $env{db_400}=$TOM::DB_name unless $env{db_400};
 
 $env{URL}="?|?" unless $env{URL};

 $env{max}=10 unless $env{max};
 $env{page_by}=10 unless $env{page_by};
 $env{page}=$main::FORM{a400_listpage};$env{page}=0 unless $env{page};
 $env{page}=0 unless $env{paging}; # pejdzovanie musi byt zapnute z typecka!!!
 $env{page_from}=$env{page}*$env{max};
 $env{page_to}=$env{max}+1; 
 
 
 # zistim skutocny pocet vylistovatelnych clankov (pokial posielam napr. max="1,5")
 #$env{max_real}=$env{max};if ($env{max}=~/,/){(undef,$env{max_real})=split(',',$env{max})}

 # IN CATEGORY
 if ($env{IDcategory})
 {if ($env{allow_subs}){$env{sel}="IDcategory LIKE '$env{IDcategory}%' AND"}
 else{$env{sel}="IDcategory='$env{IDcategory}' AND"}}

 # WHERE
 if (($env{where})&&(not $env{where}=~/and$/i)){$env{where}.=" AND"}

 # ORDER BY
 $env{orderby}="starttime DESC";

 # SELECT NA ZISTENIE STRANOK (neprijemne, ale bohuzial...)
 if ((!$main::FORM{a400_listpages})&&($env{paging}))
 {
  my $db0=$main::DBH->Query("
	(SELECT COUNT(*)
	FROM $env{db_400}.a400
	WHERE	$env{sel}
			$env{where}
			starttime<$tom::time_current
			AND (endtime>$tom::time_current OR endtime=0)
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	)
	UNION ALL
	(SELECT COUNT(*)
	FROM $env{db_400}.a400_arch
	WHERE	$env{sel}
			$env{where}
			starttime<$tom::time_current
			AND (endtime>$tom::time_current OR endtime=0)
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	)");
  while (my @db0_line=$db0->FetchRow()){$main::FORM{a400_listpages}+=$db0_line[0];}
  main::_log("in this time selected $main::FORM{a400_listpages} articles");
  
  if ($main::FORM{a400_listpages}/$env{max} ne int($main::FORM{a400_listpages}/$env{max}))
  {$main::FORM{a400_listpages}=int($main::FORM{a400_listpages}/$env{max})+1;}
  else {$main::FORM{a400_listpages}=int($main::FORM{a400_listpages}/$env{max});}
 } 
 
 
 # VYTVARAM SELECT
 my $var="
	SELECT ID,title,subtitle,tiny,xrelated,link,IDcategory,starttime,visits
	FROM $env{db_400}.a400
	WHERE	$env{sel}
			$env{where}
			starttime<$tom::time_current
			AND (endtime>$tom::time_current OR endtime=0)
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	ORDER BY $env{orderby}
	LIMIT $env{page_from},$env{page_to}";

 # VYKONAM QUERY
 my $db0=$main::DBH->Query($var);
 
 # zistim pocet riadkov
 $env{to}=$db0->NumRows;
 main::_log("selected articles limit($env{page_from},$env{page_to}) $env{to}");
 # ak je ich menej...
 if ($env{to}<$env{max})
 {
  main::_log("selecting with UNION");
  $var="(SELECT *
	FROM $env{db_400}.a400
	WHERE	$env{sel}
			$env{where}
			starttime<$tom::time_current
			AND (endtime>$tom::time_current OR endtime=0)
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	)
	UNION ALL
	(SELECT *
	FROM $env{db_400}.a400_arch
	WHERE	$env{sel}
			$env{where}
			starttime<$tom::time_current
			AND (endtime>$tom::time_current OR endtime=0)
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	)
	ORDER BY $env{orderby}
	LIMIT $env{page_from},$env{page_to}";
  #Tomahawk::debug::log(4,$var);
  $db0=$main::DBH->Query($var);
  $env{to}=$db0->NumRows;
  main::_log("selected articles limit($env{page_from},$env{page_to}) $env{to}");
 }
 
 
 #while (my %db0_line=$db0->FetchHash())
 $env{views}=0;
 while ((my %db0_line=$db0->FetchHash())&&($env{views}<$env{max}))
 {
  my $var=$db0_line{ID};
  $env{views}++;
  
  # HLADANIE LINIEK
  if ($db0_line{link})
  {
    my %links; # hash linkov v cykle hladania originalneho clanku    
    links:    
    $links{$var}++;
    if ($links{$var}>1) # ak hladam original a znova prechadzam cez nejaky clanok znova, ide o nekonecny cyklus a ja koncim.
    {$tom::ERR="cycle links in article $var";return undef;}    
    my $db1=$main::DBH->Query("
	(SELECT ID,title,subtitle,tiny,xrelated,link,IDcategory,starttime,visits
	FROM $env{db_400}.a400
	WHERE	ID='$var'
			AND starttime<$tom::time_current
			AND ((endtime>$tom::time_current) OR (endtime='0'))
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	LIMIT 1)
	UNION ALL
	(SELECT ID,title,subtitle,tiny,xrelated,link,IDcategory,starttime,visits
	FROM $env{db_400}.a400_arch
	WHERE	ID='$var'
			AND starttime<$tom::time_current
			AND ((endtime>$tom::time_current) OR (endtime='0'))
			AND active='Y'
			AND (lng='$env{lng}' OR lng='')
	LIMIT 1)
	ORDER BY changetime DESC LIMIT 1");  
	if (%db0_line=$db1->fetchhash())
	{
         $var=$db0_line{ID};
	 Tomahawk::debug::log(9,"link $var=$db0_line{ID}");
	 goto links if $db0_line{link};
	}
        else 
	{
	 $tom::ERR="in article $var bad link";return undef;
	}
  }
 
  main::_log("article $db0_line{ID}");
  

       
  # VYTVORENIE LINE
  $XSGN{NULL}=$XSGN{LINE};
  
  
  # DATE & TIME
  if ($env{show_datetime})
  {
   #$db0_line{starttime}=4294967295-(2*365*86400);
   #$db0_line{starttime}=2147483647;
   #                               1076845200
   my %env0=Utils::datetime::ctodatetime($db0_line{starttime},format=>1);
   if ($env{show_datetime} eq "1")
   {$XSGN{NULL}=~s|<%DATETIME%>|$env0{mday}.$env0{mom}.$env0{year} $env0{hour}:$env0{min}|g;}
   else
   {
    $XSGN{NULL}=~s|<%DAY%>|$env0{mday}|g;
    $XSGN{NULL}=~s|<%MONTH%>|$env0{mom}|g;
    $XSGN{NULL}=~s|<%YEAR%>|$env0{year}|g;
    $XSGN{NULL}=~s|<%HOUR%>|$env0{hour}|g;
    $XSGN{NULL}=~s|<%MINUTE%>|$env0{min}|g;
   }
   if ($env{lasttime} ne "$env0{year}-$env0{mom}-$env0{mday}")
   {
    $XSGN{NULL0}=$XSGN{DAY};
    $XSGN{NULL0}=~s|<%DAY%>|$env0{mday}|g;
    $XSGN{NULL0}=~s|<%MONTH%>|$env0{mom}|g;
    $XSGN{NULL0}=~s|<%YEAR%>|$env0{year}|g;
    
#    $XSGN{TMP}=~s|<#LINE#>|$XSGN{NULL0}<#LINE#>|; 
    $XSGN{TMP}=~s|<#LINE#>||g; 
    $XSGN{TMP}=~s|<#DAY#>|$XSGN{NULL0}<#DAY#>|; 
    
   }
   $env{lasttime}="$env0{year}-$env0{mom}-$env0{mday}";
  }  
  
  
  $XSGN{NULL}=~s|<%ID%>|$db0_line{ID}|g;
  $XSGN{NULL}=~s|<%VISITS%>|$db0_line{visits}|g;
 
  if (($env{title_cut})&&(length($db0_line{title})>$env{title_cut}))
  {$db0_line{title}=substr($db0_line{title}, 0, $env{title_cut});$db0_line{title}=~s|(.*) .*?$|$1 ...|;}
  $XSGN{NULL}=~s|<%TITLE%>|$db0_line{title}|g;

  if (($env{tiny_cut})&&(length($db0_line{tiny})>$env{tiny_cut}))
  {$db0_line{tiny}=substr($db0_line{tiny}, 0, $env{tiny_cut});$db0_line{tiny}=~s|(.*) .*?$|$1 ...|;}
  $XSGN{NULL}=~s|<%TINY%>|$db0_line{tiny}|g;

  if (($env{subtitle_cut})&&(length($db0_line{subtitle})>$env{subtitle_cut}))
  {$db0_line{subtitle}=substr($db0_line{subtitle}, 0, $env{subtitle_cut});$db0_line{subtitle}=~s|(.*) .*?$|$1 ...|;}
  $XSGN{NULL}=~s|<%SUBTITLE%>|$db0_line{subtitle}|g;  
  
  
  
 # LUBOVOLNE PRIDANIE RELATED
  if ($env{xrelated})
  {while ($db0_line{xrelated}=~s|<VAR id="(.*?)" value="(.*?)" />||si)
  {#next unless $1;next unless $2;
   my ($var,$null)=($1,$2);
   next unless $XSGN{$var};
   $XSGN{NULL0}=$XSGN{$var};
   $XSGN{NULL0}=~s|<%ID%>|$null|;
   $XSGN{NULL}=~s|<#$var#>|$XSGN{NULL0}|;
    
   main::_log("xrelated app \"$var\" with \"$null\"");

   $var=~/^a820$/ && do
   {
    next unless $XSGN{NULL}=~/<%MESSAGES%>/;
    $env{db_820}=Tomahawk::Getmdlvar("820","db") unless $env{db_820};
    $env{db_820}=$TOM::DB_name unless $env{db_820};
    my $db1=$main::DBH->Query("
	SELECT messages FROM $env{db_820}.a820
	WHERE	ID='$null'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
    if (my %db1_line=$db1->fetchhash)
    {
     main::_log("messages $db1_line{messages}");
     $XSGN{NULL}=~s|<%MESSAGES%>|$db1_line{messages}|g;
    }
   next};
     
   $var=~/^a500$/ && do
   {
    next unless $XSGN{'a500'};
    $env{db_500}=Tomahawk::Getmdlvar("500","db") unless $env{db_500};
    $env{db_500}=$TOM::DB_name unless $env{db_500};
    $env{xrelated_a500_format}='t' unless $env{xrelated_a500_format};
    $env{$env{xrelated_a500_format}.'_hash'}=Tomahawk::Getmdlvar("500",$env{xrelated_a500_format}.'_hash',db=>$env{db_500});     
    my $zeroid=sprintf('%07d',$null);     
    my $var;if ($zeroid=~/^(....)/i){$var=$1};
          
    if (($env{$env{xrelated_a500_format}.'_hash'})&&($zeroid ne "0000000"))
    {
     my $db0=$main::DBH->Query("
	SELECT hash FROM $env{db_500}.a500
	WHERE	ID='$zeroid'
		AND format='$env{xrelated_a500_format}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
     if (my @db0_line=$db0->fetchrow)
     {
      $zeroid=$db0_line[0];
      main::_log("hash $var/$zeroid-$env{xrelated_a500_format}.jpg");
     }
     else {main::_log("not hash $var/$zeroid-$env{xrelated_a500_format}.jpg");}
    }
    $XSGN{NULL}=~s|<%IMG%>|$tom::H_500/$var/$zeroid-$env{xrelated_a500_format}.jpg|g;          
   next};     
          
   # clanky m0
   $var=/^a400$/ && do
   {
   next};
   
   
     
  }
  }
  
  
  
  
  
  
  
  
  
  

  
  
  # VYTRHNUTIE PEVNYCH LINIEK NA PODPORTALY
  if ($env{URL_IDcat})
  {my $var;foreach (sort keys %env)
  {$_=~/^URL_IDcat_(.*)/ && do {my $null=$1;$var=$env{'URL_IDcat_'.$null} if $db0_line{IDcategory}=~/^$null/;};}
  $XSGN{NULL}=~s|<%URL%>|$var|g if $var;}

  
  # ZAPISANIE LINE DO DESIGNU
  $XSGN{TMP}=~s|<#LINE#>|$XSGN{NULL}<#LINE#>|; 
 } 
 
 
 
 # VYSPELE PEJDZOVANIE :))))
 if ($env{paging})
 {
  $env{page_from}=$env{page}-$env{page_by};
  $env{page_from}=0 if $env{page_from} < 0;
  $env{page_to}=$env{page}+$env{page_by};
  $env{page_to}=$main::FORM{a400_listpages} if $env{page_to} > $main::FORM{a400_listpages};

  if ($main::FORM{a400_listpages})
  {
   $XSGN{TMP}=~s|<#PAGING#>|$XSGN{PAGING}|g;
  }

  for ($env{page_from}..$env{page_to}-1)
  {
   $XSGN{NULL}=$XSGN{NUM};
   #$XSGN{NULL}=~s|<%url%>|a400_listpage=$_&a400_listpages=$main::FORM{a400_listpages}&s_mday=$main::FORM{s_mday}&s_yweek=$main::FORM{s_yweek}&s_wday=$main::FORM{s_wday}&v_year=$main::FORM{v_year}&v_mom=$main::FORM{v_mom}|g;
   $XSGN{NULL}=~s|<%url%>|a400_listpage=$_&a400_listpages=$main::FORM{a400_listpages}|g;
   
   $XSGN{NULL}=~s|<%NUM%>|$_+1|eg;
   $XSGN{TMP}=~s|<#NUM#>|$XSGN{NULL}<#NUM#>|g;
  }
 
  if ($env{page_to}<$main::FORM{a400_listpages})
  {
   my $nextpage=$main::FORM{a400_listpages}-1;
   $XSGN{NULL}=$XSGN{NUM_END};
   #$XSGN{NULL}=~s|<%url%>|a400_listpage=$nextpage&a400_listpages=$main::FORM{a400_listpages}&s_mday=$main::FORM{s_mday}&s_yweek=$main::FORM{s_yweek}&s_wday=$main::FORM{s_wday}&v_year=$main::FORM{v_year}&v_mom=$main::FORM{v_mom}|g;
   $XSGN{NULL}=~s|<%url%>|a400_listpage=$nextpage&a400_listpages=$main::FORM{a400_listpages}|g;
   
   $XSGN{NULL}=~s|<%NUM%>|$nextpage+1|eg;
   $XSGN{TMP}=~s|<#NUM_END#>|$XSGN{NULL}|;
  }
 
  if ($env{page_from}>0)
  {
   $XSGN{NULL}=$XSGN{NUM_BEGIN};
   #$XSGN{NULL}=~s|<%url%>|a400_listpage=0&a400_listpages=$main::FORM{a400_listpages}&s_mday=$main::FORM{s_mday}&s_yweek=$main::FORM{s_yweek}&s_wday=$main::FORM{s_wday}&v_year=$main::FORM{v_year}&v_mom=$main::FORM{v_mom}|g;   
   $XSGN{NULL}=~s|<%url%>|a400_listpage=0&a400_listpages=$main::FORM{a400_listpages}|g;
   
   $XSGN{NULL}=~s|<%NUM%>|1|eg;
   $XSGN{TMP}=~s|<#NUM_BEGIN#>|$XSGN{NULL}|;
  }
 
  if ($env{views}<$env{to})
  {
   my $nextpage=$env{page}+1;
	$XSGN{NULL}=$XSGN{NEXT};
	#$XSGN{NULL}=~s|<%url%>|a400_listpage=$nextpage&a400_listpages=$main::FORM{a400_listpages}&s_mday=$main::FORM{s_mday}&s_yweek=$main::FORM{s_yweek}&s_wday=$main::FORM{s_wday}&v_year=$main::FORM{v_year}&v_mom=$main::FORM{v_mom}|g;
	$XSGN{NULL}=~s|<%url%>|a400_listpage=$nextpage&a400_listpages=$main::FORM{a400_listpages}|g;
 	$XSGN{TMP}=~s|<#NEXT#>|$XSGN{NULL}|;
	$XSGN{TMP}=~s|<%PAGE%>|$env{page}|g;	
  }

  if ($env{page}>0)
  {
   my $prevpage=$env{page}-1;
	$XSGN{NULL}=$XSGN{PREV};
	#$XSGN{NULL}=~s|<%url%>|a400_listpage=$prevpage&a400_listpages=$main::FORM{a400_listpages}&s_mday=$main::FORM{s_mday}&s_yweek=$main::FORM{s_yweek}&s_wday=$main::FORM{s_wday}&v_year=$main::FORM{v_year}&v_mom=$main::FORM{v_mom}|g;
	$XSGN{NULL}=~s|<%url%>|a400_listpage=$prevpage&a400_listpages=$main::FORM{a400_listpages}|g;
 	$XSGN{TMP}=~s|<#PREV#>|$XSGN{NULL}|;
	$XSGN{TMP}=~s|<%PAGE%>|$env{page}|g;
  }
 }
 
 
 
 
 
 $XSGN{TMP}=~s|<%URL%>|$env{URL}|g;

 
 return 1;
 
 
 
=head1 
 
  my $zeroid;

  #Tomahawk::debug::log(9,"hash $env{format_500}_hash=".$env{$env{format_500}.'_hash'});
  if ($db0_line{xrelated}=~/<VAR id="a500" value="(.*?)" \/>/)
  {$zeroid=sprintf('%07d',$1);} else {$zeroid=sprintf('%07d',0);}
  my $var;if ($zeroid=~/^(....)/i){$var=$1};

  #Tomahawk::debug::log(0," $db0_line{xrelated}");
  #Tomahawk::debug::log(0," obrazok $zeroid");

  if (($env{$env{format_500}.'_hash'})&&($zeroid ne "0000000"))
  {
   my $db0=$main::DBH->Query("
   	SELECT hash FROM $env{db_500}.a500
   	WHERE	ID='$zeroid'
		AND format='$env{format_500}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
   if (my @db0_line=$db0->fetchrow)
   {
    $zeroid=$db0_line[0];
    main::_log("hash $var/$zeroid-$env{format_500}.jpg");
   }
   else {main::_log("not hash $var/$zeroid-$env{format_500}.jpg");}
  }

  $XSGN{NULL}=~s|<%IMG%>|$tom::H_500/$var/$zeroid-$env{format_500}.jpg|g;




  # NAME OF CATEGORY
 if ($env{show_catname_all})
 {
  main::_log("show category $db0_line{IDcategory}");
  my $db0=$main::DBH->Query("
	SELECT name FROM $env{db_400}.a400_category
	WHERE	ID='$db0_line{IDcategory}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
  if (my @db0_line=$db0->fetchrow)
  {
   $XSGN{NULL}=~s|<%CATNAME%>|$db0_line[0]|g;
   main::_log("found category $db0_line{IDcategory}");
  }
  else
  {
   main::_log("not found category $db0_line{IDcategory}");
  }
 }
 else
 {
#  main::_log("not show category $db0_line{IDcategory}");
 }





 # LUBOVOLNE PRIDANIE RELATED
 
 
  if ($env{xrelated}){while ($db0_line{xrelated}=~s|<VAR id="(.*?)" value="(.*?)" />||si)
  {#next unless $1;next unless $2;
   my ($var,$null)=($1,$2);
   if ($XSGN{$var})
   {$XSGN{NULL0}=$XSGN{$var};
    $XSGN{NULL0}=~s|<%ID%>|$null|;
    $XSGN{NULL}=~s|<#$var#>|$XSGN{NULL0}|;
    next unless $env{'xrelated_'.$var.'_info'};
    
    main::_log("xrelated app \"$var\" with \"$null\"");
    
    # forum m0
    $var=~/^a820$/ && do
    {
     $env{db_820}=Tomahawk::Getmdlvar("820","db") unless $env{db_820};
     $env{db_820}=$TOM::DB_name unless $env{db_820};
     my $db1=$main::DBH->Query("
	SELECT messages FROM $env{db_820}.a820
	WHERE	ID='$null'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
     if (my %db1_line=$db1->fetchhash)
     {
      main::_log("messages $db1_line{messages}");
      $XSGN{NULL}=~s|<%MESSAGES%>|$db1_line{messages}|g;
     }
     next};
     
    # clanky m0
    $var=/^a400$/ && do
    {

     next};
     
  }}}

  
  

 }



  # NAME OF CATEGORY
 if ($env{show_catname})
 {
  main::_log("show category $env{IDcategory}");
  my $db0=$main::DBH->Query("
	SELECT name FROM $env{db_400}.a400_category
	WHERE	ID='$env{IDcategory}'
		AND (lng='$env{lng}' OR lng='')
		AND active='Y'
	LIMIT 1");
  if (my @db0_line=$db0->fetchrow)
  {
   $XSGN{TMP}=~s|<%CATNAME%>|$db0_line[0]|g;
   main::_log("found category $env{IDcategory}");
  }
  else
  {
   main::_log("not found category $env{IDcategory}");
  }
 }
 else
 {
  main::_log("not show category $env{IDcategory}");
 }

=cut 
 
 
 return 1}

1;
