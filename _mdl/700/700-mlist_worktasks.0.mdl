#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use App::300;
use strict;


sub execute
{
 my %env=@_;
 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
 Tomahawk::GetXLNG() || return undef; # NATIAHNEM XML LANGUAGE
 Tomahawk::XLNGtoXSGN(); # insert XLNG do XSGN

 $env{charindex}=3 unless $env{charindex};
 return 1 if $main::USRM{logged} ne "Y";

 $env{type_in}="'T'" unless $env{type_in};
 $env{progress_}=1 unless $env{progress_};

 my @groups=App::300::GetGroups($main::USRM{IDhash});
 my $groups=join(',',@groups);$groups="'0'" unless $groups;

 #$XSGN{TMP}.="i am in groups $groups<BR><BR>";
 #$XSGN{TMP}.="<BR>";
 #$XSGN{TMP}.="<a href=\"?|?TID=$main::FORM{TID}&work=0\">stop work!</a><BR>";

 #foreach (keys %main::FORM){$XSGN{TMP}.="$_=$main::FORM{$_}\n<BR>";}

=head1
 if (exists $main::FORM{work})
 {
  $XSGN{TMP}.="stopping work\n<BR>";
  my $db0=$main::DBH->Query("
		UPDATE TOM.Ca700_task_activity
		SET	endtime='$tom::time_current'
		WHERE	IDuser='$main::USRM{IDhash}'
			AND endtime IS NULL");
 }
=cut

=head1
 my $working; # pracujem?
 # ZISTIM NA COM PRACUJEM :)
 my $db0=$main::DBH->Query("
	SELECT *
	FROM TOM.Ca700_task_activity
	WHERE	IDuser='$main::USRM{IDhash}'
		AND endtime IS NULL
	LIMIT 1");
 if (my %db0_line=$db0->fetchrow)
 {
  $working=$db0_line{IDtask};
 }
=cut

 my $db0=$main::DBH->Query("
	SELECT	task.*,
		rights_group.IDgroup AS rights_group_ID,
		rights_group.perm_view AS rights_group_view,
		rights_group.perm_del AS rights_group_del,
		rights_group.perm_progress AS rights_group_progress,
		rights_group.perm_work AS rights_group_work,
		rights_group.perm_finish AS rights_group_finish,
		rights_group.perm_edit AS rights_group_edit,
		rights_user.IDuser AS rights_user_ID,
		rights_user.perm_view AS rights_user_view,
		rights_user.perm_del AS rights_user_del,
		rights_user.perm_progress AS rights_user_progress,
		rights_user.perm_work AS rights_user_work,
		rights_user.perm_finish AS rights_user_finish,
		rights_user.perm_edit AS rights_user_edit,
		status.endtime AS status_endtime
	FROM TOM.Ca700_task AS task
	LEFT JOIN TOM.Ca700_task_status AS status ON (task.multiowning = 'Y'AND status.IDuser='$main::USRM{IDhash}')
	LEFT JOIN TOM.Ca700_task_groups AS rights_group
		ON (
			task.owning IN ('P','D')
			AND task.IDowner != '$main::USRM{IDhash}'
			AND (task.IDgroup IS NULL OR task.IDgroup NOT IN ($groups))
			AND rights_group.IDtask=task.ID
			AND rights_group.IDgroup IN ($groups)
			AND rights_group.starttime<=$tom::time_current
			AND (rights_group.endtime>=$tom::time_current OR rights_group.endtime IS NULL)
		   )
	LEFT JOIN TOM.Ca700_task_users AS rights_user
		ON (
			task.owning IN ('P','D')
			AND task.IDowner != '$main::USRM{IDhash}'
			AND (task.IDgroup IS NULL OR task.IDgroup NOT IN ($groups))
			AND rights_user.IDtask=task.ID
			AND rights_user.IDuser='$main::USRM{IDhash}'
			AND rights_user.starttime<=$tom::time_current
			AND (rights_user.endtime>=$tom::time_current OR rights_user.endtime IS NULL)
		   )
	WHERE
		(task.domain='$tom::H_cookie' OR task.domain IS NULL)
		AND task.type IN($env{type_in})
		AND task.IDlink IS NULL
		AND task.startplantime<=($tom::time_current+3600)
		AND task.endtime IS NULL
		AND status.endtime IS NULL
		AND (task.lng='sk' OR task.lng='')
		AND task.active='Y'
		AND
		(
		 task.IDowner='$main::USRM{IDhash}'
		 OR task.IDgroup IN ($groups)
		 OR (task.owning='P'
			AND
			(
			 rights_user.perm_view='Y'
			 OR
			 (
			  rights_user.perm_view IS NULL
			  AND (rights_group.perm_view IS NULL OR rights_group.perm_view='Y')
			 )
			)
		    )
		 OR (task.owning='D'
			AND
			(
			 rights_user.perm_view='Y'
			 OR
			 (
			  rights_group.perm_view='Y'
			  AND (rights_user.perm_view='Y' OR rights_user.perm_view IS NULL)
			 )
			)
		    )
		)
	ORDER BY	priority DESC,
			task.endplantime,
			task.starttime DESC
	");

=head1
			AND
			(
			 (
			  rights_group.perm_view NOT LIKE 'N'
			  AND rights_user.perm_view='Y'
			 )
			 OR rights_user.perm_view='Y'
			)
=cut


 my %tasks_h;
 my @tasks_a;
 while (my %db0_line=$db0->fetchhash)
 {

  # zistim ci som jeden z majitelov
  my $owner;
  $owner=1 if $db0_line{IDowner} eq $main::USRM{IDhash};
  if (!$owner){foreach (@groups){if ($_ eq $db0_line{IDgroup}){$owner=1;last}}}

  if ($owner)
  {
   $db0_line{rights_user_del}="Y";
   $db0_line{rights_user_progress}="Y";
   $db0_line{rights_user_work}="Y";
   $db0_line{rights_user_finish}="Y";
   $db0_line{rights_user_edit}="Y";
   push @tasks_a, $db0_line{ID} if not exists $tasks_h{$db0_line{ID}};
   %{$tasks_h{$db0_line{ID}}}=%db0_line;
  }
  else
  {
   if (not exists $tasks_h{$db0_line{ID}})
   {
    push @tasks_a, $db0_line{ID};
    %{$tasks_h{$db0_line{ID}}}=%db0_line;
   }

   #$XSGN{TMP}.="-$db0_line{ID}<BR>\n";
   #foreach (sort keys %db0_line){if (not $_=~/^rights/){next}$XSGN{TMP}.="&nbsp;+$_ = $db0_line{$_}<BR>\n";}

   if (($tasks_h{$db0_line{ID}}{rights_group_del} ne "Y")&&($db0_line{rights_group_del}))
   {$tasks_h{$db0_line{ID}}{rights_group_del}=$db0_line{rights_group_del};}
   if (($tasks_h{$db0_line{ID}}{rights_group_progress} ne "Y")&&($db0_line{rights_group_progress}))
   {$tasks_h{$db0_line{ID}}{rights_group_progress}=$db0_line{rights_group_progress};}
   if (($tasks_h{$db0_line{ID}}{rights_group_work} ne "Y")&&($db0_line{rights_group_work}))
   {$tasks_h{$db0_line{ID}}{rights_group_work}=$db0_line{rights_group_work};}
   if (($tasks_h{$db0_line{ID}}{rights_group_finish} ne "Y")&&($db0_line{rights_group_finish}))
   {$tasks_h{$db0_line{ID}}{rights_group_finish}=$db0_line{rights_group_finish};}
   if (($tasks_h{$db0_line{ID}}{rights_group_edit} ne "Y")&&($db0_line{rights_group_edit}))
   {$tasks_h{$db0_line{ID}}{rights_group_edit}=$db0_line{rights_group_edit};}

   if (($tasks_h{$db0_line{ID}}{rights_rule_del} ne "Y")&&($db0_line{rights_rule_del}))
   {$tasks_h{$db0_line{ID}}{rights_rule_del}=$db0_line{rights_rule_del};}
   if (($tasks_h{$db0_line{ID}}{rights_rule_progress} ne "Y")&&($db0_line{rights_rule_progress}))
   {$tasks_h{$db0_line{ID}}{rights_rule_progress}=$db0_line{rights_rule_progress};}
   if (($tasks_h{$db0_line{ID}}{rights_rule_work} ne "Y")&&($db0_line{rights_rule_work}))
   {$tasks_h{$db0_line{ID}}{rights_rule_work}=$db0_line{rights_rule_work};}
   if (($tasks_h{$db0_line{ID}}{rights_rule_finish} ne "Y")&&($db0_line{rights_rule_finish}))
   {$tasks_h{$db0_line{ID}}{rights_rule_finish}=$db0_line{rights_rule_finish};}
   if (($tasks_h{$db0_line{ID}}{rights_rule_edit} ne "Y")&&($db0_line{rights_rule_edit}))
   {$tasks_h{$db0_line{ID}}{rights_rule_edit}=$db0_line{rights_rule_edit};}


  }



#  my %db0_line=$db0->fetchhash;

  # zobrazenie lajnu
#  $XSGN{TMP}.="<div style=\"FONT:10px Arial;\">[$db0_line{owning}\{$db0_line{domain}} - $db0_line{type}] $db0_line{ID}($db0_line{IDcharindex}) $db0_line{subject}</div>\n";

  # spracovanie pametovej casti

#  if ($lasthash{ID} ne $db0_line{ID})
#  {
#   $XSGN{TMP}.="<div style=\"FONT:12px Arial;\">&nbsp;&nbsp;&nbsp;[$lasthash{owning}\{$lasthash{domain}} - $lasthash{type}] $lasthash{ID}($lasthash{IDcharindex}) $lasthash{subject}</div>\n";
#  }

#  %lasthash=%db0_line if ($lasthash{ID} ne $db0_line{ID});

=head1
  $XSGN{TMP}.="<div style=\"FONT:13px Arial;\">[$db0_line{owning}\{$db0_line{domain}} - $db0_line{type}] $db0_line{ID}($db0_line{IDcharindex}) $db0_line{subject}</div>\n";
  $XSGN{TMP}.="<div style=\"FONT:12px Arial;\">+ $db0_line{rights_user_ID} view:$db0_line{rights_user_view} del:$db0_line{rights_user_del} progress:$db0_line{rights_user_progress} work:$db0_line{rights_user_work}</div>\n";
  $XSGN{TMP}.="<div style=\"FONT:12px Arial;\">+ $db0_line{rights_group_ID} gview:$db0_line{rights_group_view} gdel:$db0_line{rights_group_del} gprogress:$db0_line{rights_group_progress} gwork:$db0_line{rights_group_work}</div>\n";





  # zistim ci som jeden z majitelov
  my $owner;
  $owner=1 if $db0_line{IDowner} eq $main::USRM{IDhash};
  if (!$owner)
  {
   foreach (@groups)
   {
    if ($_ eq $db0_line{IDgroup}){$owner=1;last}
   }
  }




  if ($owner)
  {
   $XSGN{TMP}.="<div style=\"FONT:12px Arial;\">+you are owner</div>\n";
  }
  else
  {
  }



  %lasthash=%db0_line;
  $XSGN{TMP}.="<BR>\n";
=cut
 }

foreach my $task(@tasks_a)
{
 $XSGN{NULL}=$XSGN{TASK};
 $XSGN{NULL}=$XSGN{'TASK-owning-'.$tasks_h{$task}{owning}} if exists $XSGN{'TASK-owning-'.$tasks_h{$task}{owning}};
 $XSGN{NULL}=$XSGN{'TASK-type-'.$tasks_h{$task}{type}} if exists $XSGN{'TASK-type-'.$tasks_h{$task}{type}};


 #$XSGN{TMP}.="+$task ".$tasks_h{$task}{subject}."<BR>\n";
#
# $XSGN{TMP}.="&nbsp;&nbsp;+ g_del:$tasks_h{$task}{rights_group_del}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ g_progress:$tasks_h{$task}{rights_group_progress}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ g_work:".$tasks_h{$task}{rights_group_work}."<BR>\n";
#
# $XSGN{TMP}.="&nbsp;&nbsp;+ r_del:$tasks_h{$task}{rights_rule_del}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ r_progress:$tasks_h{$task}{rights_rule_progress}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ r_work:".$tasks_h{$task}{rights_rule_work}."<BR>\n";
#
# $XSGN{TMP}.="&nbsp;&nbsp;+ u_del:$tasks_h{$task}{rights_user_del}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ u_progress:$tasks_h{$task}{rights_user_progress}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ u_work:".$tasks_h{$task}{rights_user_work}."<BR>\n";

 my @druhy=("del","progress","work","finish","edit");
 foreach my $druh(@druhy)
 {
  $tasks_h{$task}{'perm_'.$druh}=$tasks_h{$task}{'rights_group_'.$druh} if $tasks_h{$task}{'rights_group_'.$druh};
  $tasks_h{$task}{'perm_'.$druh}=$tasks_h{$task}{'rights_role_'.$druh} if $tasks_h{$task}{'rights_role_'.$druh};
  $tasks_h{$task}{'perm_'.$druh}=$tasks_h{$task}{'rights_user_'.$druh} if $tasks_h{$task}{'rights_user_'.$druh};
 }

 $tasks_h{$task}{'perm_work'}="N" if $tasks_h{$task}{'type'}=~/^[nt]$/;
 $tasks_h{$task}{'perm_progress'}="N" if $tasks_h{$task}{'type'}=~/^[nt]$/;

# $XSGN{TMP}.="&nbsp;&nbsp;+ f_del:$tasks_h{$task}{perm_del}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ f_progress:$tasks_h{$task}{perm_progress}\n";
# $XSGN{TMP}.="&nbsp;&nbsp;+ f_work:".$tasks_h{$task}{perm_work}."<BR>\n";

 my $working;
 my $db0=$main::DBH->Query("
	SELECT	task.*,user.login
	FROM	TOM.Ca700_task_activity AS task
	LEFT JOIN markiza_sk.a300_users AS user
		ON
		(
		 task.IDuser = user.IDhash
		)
	WHERE	task.IDtask='$task'
		AND task.endtime IS NULL
	");
 while (my %db0_line=$db0->fetchhash())
 {
  $working=1 unless $working;
  $XSGN{NULL}=~s|<%WORKERS%>|$db0_line{login}<BR><%WORKERS%>|g;
  if ($db0_line{IDuser} eq $main::USRM{IDhash})
  {$working=2;$tasks_h{$task}{perm_work}="N";}
 }

 if (!$working)
 {$XSGN{NULL}=~s|<#ACTIVITY#>|$XSGN{'activity-default'}|g;}
 elsif ($working==1)
 {$XSGN{NULL}=~s|<#ACTIVITY#>|$XSGN{'activity-working'}|g;}
 elsif ($working==2)
 {$XSGN{NULL}=~s|<#ACTIVITY#>|$XSGN{'activity-mywork'}|g;}

 my $type=$tasks_h{$task}{type};
 if ($type eq "T"){$type="Task"}
 elsif ($type eq "t"){$type="To-do"}
 elsif ($type eq "E"){$type="Event"}
 elsif ($type eq "r"){$type="Report"}
 elsif ($type eq "n"){$type="Notes"}

 my $owning=$tasks_h{$task}{owning};
 if ($owning eq "P"){$owning="Public"}
 elsif ($owning eq "D"){$owning="Defined"}
 elsif ($owning eq "S"){$owning="Secure"}


 $XSGN{NULL}=~s/<%PROGRESS_%>/$tasks_h{$task}{progress}*$env{progress_}/eg;


 if ($tasks_h{$task}{perm_work} eq "Y")
 {
  $XSGN{NULL}=~s|<#WORK#>|$XSGN{'action-work'}|g;
 }

 if ($tasks_h{$task}{perm_finish} eq "Y")
 {
  $XSGN{NULL}=~s|<#FINISH#>|$XSGN{'action-finish'}|g;
 }

 if ($tasks_h{$task}{perm_progress} eq "Y")
 {
  $XSGN{NULL}=~s|<#PROGRESS#>|$XSGN{'action-progress'}|g;
 }

 if ($tasks_h{$task}{perm_edit} eq "Y")
 {
  $XSGN{NULL}=~s|<#EDIT#>|$XSGN{'action-edit'}|g;
 }

 if ($tasks_h{$task}{perm_del} eq "Y")
 {
  $XSGN{NULL}=~s|<#DEL#>|$XSGN{'action-del'}|g;
 }

 $XSGN{NULL}=~s|<#VIEW#>|$XSGN{'action-view'}|g;

 $XSGN{NULL}=~s|<%ID%>|$task|g;
 $XSGN{NULL}=~s|<%TYPE_%>|$type|g;
 $XSGN{NULL}=~s|<%OWNING_%>|$owning|g;
 $XSGN{NULL}=~s|<%IDcharindex%>|$tasks_h{$task}{IDcharindex}|g;
 $XSGN{NULL}=~s|<%PRIORITY%>|$tasks_h{$task}{priority}|g;
 $XSGN{NULL}=~s|<%SUBJECT%>|$tasks_h{$task}{subject}|g;


 #if ($working == 2)
 #{

  if (($working == 2)&&($XSGN{TMP}=~/<#TASK_my#>/)){$XSGN{TMP}=~s|<#TASK_my#>|$XSGN{NULL}|g;}
  else
  {
   $XSGN{TMP}=~s|(<#TASK#>)|$XSGN{NULL}\1|g;
   my $var;
   $var=1 if $XSGN{TMP}=~s|(<#TASK-owning-$tasks_h{$task}{owning}#>)|$XSGN{NULL}\1|g;
   $var=1 if $XSGN{TMP}=~s|(<#TASK-type-$tasks_h{$task}{type}#>)|$XSGN{NULL}\1|g;
   $XSGN{TMP}=~s|(<#TASK_#>)|$XSGN{NULL}\1|g unless $var;
  }

 #}
 #else
 #{
 # $var=1 if $XSGN{TMP}=~s|(<#TASK-owning-$tasks_h{$task}{owning}#>)|\1$XSGN{NULL}|g;
 # $var=1 if $XSGN{TMP}=~s|(<#TASK-type-$tasks_h{$task}{type}#>)|\1$XSGN{NULL}|g;
 # $XSGN{TMP}=~s|(<#TASK_#>)|\1$XSGN{NULL}|g unless $var;
 #}


}


#$XSGN{TMP}.="<BR><BR>\n";







=head1

 $XSGN{TMP}.="i am in groups: <B>$groups</B><BR><BR>\n";

 $XSGN{TMP}.="<a href=\"?|?stopwork=1\">stop work</a><BR>\n";

 if ($main::FORM{stopwork})
 {
    my $db0=$main::DBH->Query("
    		UPDATE TOM.Ca700_task_worktimes
		SET	endtime='$tom::time_current'
		WHERE	IDuser='$main::USRM{IDhash}'
			AND endtime IS NULL");
 }
 elsif ($main::FORM{workon})
 {
  $XSGN{TMP}.="work on $main::FORM{workon}<BR>\n";
  my $db1=$main::DBH->Query("
		SELECT ID
		FROM TOM.Ca700_task
		WHERE ID='$main::FORM{workon}' LIMIT 1");
  if (my @db1_line=$db1->fetchrow)
  {
   my $db2=$main::DBH->Query("
		SELECT dep.IDdependency, task.*
		FROM TOM.Ca700_task_dependencies AS dep
		LEFT JOIN TOM.Ca700_task AS task ON
			(
			 task.ID=dep.IDdependency
			 AND task.endtime IS NULL
			)
		WHERE dep.IDtask='$main::FORM{workon}' AND task.endtime IS NULL
		LIMIT 1");
   if (my %db2_line=$db2->fetchhash)
   {
    $XSGN{TMP}.="tuto ulohu nemozete plnit, este nebola splnena uloha $db2_line{ID} ($db2_line{subject}) <BR>\n";
   }
   else
   {
    my $db0=$main::DBH->Query("
    		UPDATE TOM.Ca700_task_worktimes
		SET	endtime='$tom::time_current'
		WHERE	IDuser='$main::USRM{IDhash}'
			AND endtime IS NULL");
    $main::DBH->Query("
		INSERT INTO TOM.Ca700_task_worktimes
		(IDtask,IDuser,starttime,active)
		VALUES
		('$main::FORM{workon}','$main::USRM{IDhash}','$tom::time_current','Y')");
   }
  }
 }



#=head1
 my $db0=$main::DBH->Query("
	SELECT	task.*
	FROM TOM.Ca700_task AS task
	WHERE
		(task.domain='$tom::H_cookie' OR task.domain IS NULL)
		AND (task.type='T' OR task.type='E')
		AND task.IDlink IS NULL
		AND task.startplantime<=($tom::time_current+3600)
		AND task.endtime IS NULL
		AND (task.lng='sk' OR task.lng='')
		AND task.active='Y'
		AND
		(
		 task.IDowner='$main::USRM{IDhash}'
		 OR task.IDgroup IN ($groups)
		 OR (task.owning='P')
		 OR (task.owning='D')
		)
	ORDER BY	priority DESC,
			task.endplantime,
			task.starttime DESC
	");


 my $lastid;
 while (my %db0_line=$db0->fetchhash)
 {
   $XSGN{TMP}.="<div style=\"FONT:12px Arial;\">[$db0_line{owning}\{$db0_line{domain}} - $db0_line{type}] $db0_line{ID}($db0_line{IDcharindex}) $db0_line{subject}</div>\n";

   if ($db0_line{IDowner} ne $main::USRM{IDhash})
   {
   }


 }
#=cut

 $XSGN{TMP}.="<BR><BR>\n";

=cut

 return 1}
1;










