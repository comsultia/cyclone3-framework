#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use DateTime;
use strict;

sub execute
{
	my %env=@_;
	Tomahawk::GetXSGN(-convertvars=>1) || return undef;

	my $today = DateTime->now();
	my @wdays = ( 'Nedeľa', 'Pondelok', 'Utorok', 'Streda', 'Štvrtok', 'Piatok', 'Sobota', 'Nedeľa' );
	my $today_day = $wdays[$today->wday];
	my $today_date = $today->strftime('%d. %m. %Y');
	
	$XSGN{TMP} =~ s|<%today_day%>|$today_day|g;
	$XSGN{TMP} =~ s|<%today_date%>|$today_date|g;

	# Clanky
	my $sql = "
	SELECT
		a400.*,
		a120.nickname,
		from_unixtime(a400.changetime, '\%d.\%m.\%Y / \%H:\%i') as changetime_sk
	FROM
		a400 left join
		a120 on a400.IDeditor=a120.ID
	ORDER BY
		a400.changetime DESC
	LIMIT
		5
	";
	my $db0 = $main::DB{main}->Query( $sql );

	while ( my %db0_line = $db0->fetchhash )
	{
		my $line = $XSGN{LINE_article};
		while ( my ($k,$v) = each %db0_line ) { $line =~ s|<%$k%>|$v|g; }

		$XSGN{TMP} =~ s|<#LINE_article#>|$line|;
	}

	# Obrazky
	my $sql = "
	SELECT
		a500.*,
		a500_attrs.*,
		a120.nickname,
		from_unixtime(a500.changetime, '\%d.\%m.\%Y / \%H:\%i') as changetime_sk
	FROM
		a500 left join
		a500_attrs on a500.IDattrs=a500_attrs.IDattrs left join
		a120 on a500.IDeditor=a120.ID
	WHERE
		a500.format='t'
	ORDER BY
		a500.changetime DESC
	LIMIT
		3
	";
	my $db0 = $main::DB{main}->Query( $sql );

	while ( my %db0_line = $db0->fetchhash )
	{
		my $line = $XSGN{LINE_image};
		while ( my ($k,$v) = each %db0_line ) { $line =~ s|<%$k%>|$v|g; }

		$XSGN{TMP} =~ s|<#LINE_image#>|$line|;
	}

	return 1;
}
1;
