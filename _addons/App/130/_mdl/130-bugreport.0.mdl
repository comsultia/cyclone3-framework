#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;
use Digest::MD5  qw(md5 md5_hex md5_base64);
=head1 NAME
login

=head1 HEAD_VERSION_BUILD
1.030722

=head1 DESCRIPTION
login, user menu a user-setup menu

=head1 XMLDESCRIPTION

<DESCRIPTION>

<value id="preview" value="1" />
<value id="output" value="xsgn" />

</DESCRIPTION>


=head1 CHANGES
build 030722 - Deboot
*) FIRST MAKE

=head1 WARNINGS & BUGS

=cut

sub execute
{
 my %env=@_;
 #return undef unless $env{ID};

 # osetrim blbe znaky kvoli zobrazovaniu a aj vkladaniu
 $main::FORM{text}=~s|[<>]||g;
 $main::FORM{text}=~s|\r||g;
 $main::FORM{text}=~s|\n\n||g;

 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
 #Tomahawk::GetXLNG() || return undef; # NATIAHNEM XML LANGUAGE
 #Tomahawk::XLNGtoXSGN(); # insert XLNG do XSGN

 $env{db_130}=Tomahawk::Getmdlvar("130","db") unless $env{db_130};
 $env{db_130}=$TOM::DB_name_TOM unless $env{db_130};

 $env{mailtable}="a130_send";
 #$env{mailtable}="a130_send" if ($env{db_130} eq $TOM::DB_name_TOM);

 $XSGN{TMP}=$XSGN{FORM};

 return 1 unless $main::FORM{text};
 #foreach (keys %main::USRM){$XSGN{TMP}.="$_=$main::USRM{$_}<BR>";}

#=head1
   # vkladam prispevok
   # tieto znaky osetrujem len kvoli zapisu
	$main::FORM{email}=~s|"|\\"|g;
	$main::FORM{email}=~s|'|\\'|g;
	$main::FORM{text}=~s|"|\\"|g;
	$main::FORM{text}=~s|'|\\'|g;

	 $XSGN{NULL}=$XSGN{EMAIL};
	 $XSGN{NULL}=~s|<%DATE%>|$Utils::datetime::DAYS{en}[$tom::Twday], $tom::Tmday $Utils::datetime::MONTHS{en}[$tom::Tmom-1] $tom::Fyear $tom::Fhour:$tom::Fmin:$tom::Fsec +-200|g;
	 $XSGN{NULL}=~s|<%BODY%>|$main::FORM{text}|g;
	 $XSGN{NULL}=~s|<%FROM%>|"$TOM::core_uname_n($tom::H)" <TOM3\@$tom::H>|g;
	 $XSGN{NULL}=~s|<%FROM2%>|$main::FORM{email}|g;
	 #$XSGN{NULL}=~s|<%EMAIL%>|$main::FORM{text}|g;

	$env{to_email}=$TOM::contact_admin.";".$TOM::contact_operator.";".$TOM::contact_bugreport;
	my %env0;
	foreach (split(';',$env{to_email})){$env0{$_}++;}
	$env{to_email}="";foreach (sort keys %env0){$env{to_email}.=$_.";";}$env{to_email}=~s|;$||;
	$env{to_email_parse}=$env{to_email};$env{to_email_parse}=~s|;|>,<|g;$env{to_email_parse}="<".$env{to_email_parse}.">";
	$XSGN{NULL}=~s|<%TO%>|"bugreport_contacts" $env{to_email_parse}|g;


	 $main::DBH->Query("
	 INSERT INTO $env{db_130}.$env{mailtable}
	 (
	  sendtime,
	  priority,
	  from_name,
	  from_email,
	  from_host,
	  from_service,
	  to_name,
	  to_email,
	  body)
	 VALUES	(
	  '$tom::time_current',
	  '5',
	  'TOM3',
	  'TOM3\@$tom::H',
	  '$tom::H',
	  'a130',
	  'bugreport',
	  '$env{to_email}',
	  '$XSGN{NULL}'
	 )");

$XSGN{TMP}=$XSGN{SENDED};
#=cut

 return 1}


1;











