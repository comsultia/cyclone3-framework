#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
use strict;

use App::020::_init;

=head1 NAME

501-image_reorder.0.mdl

=cut

=head1 DESCRIPTION

Reorder images in category

=cut


sub execute
{
	my %env=@_;
	Tomahawk::GetXSGN('-convertvars'=>1) || return undef;
	
	if (!$env{'ID'})
	{
		$XSGN{'TMP'}=$XSGN{'RESULT_failure_no_input'};
		$XSGN{'TMP'}=~s|<%missing_parameter%>|ID|g;
		return 1;
	}
	
	if (!$env{'ID_category'})
	{
		$XSGN{'TMP'}=$XSGN{'RESULT_failure_no_input'};
		$XSGN{'TMP'}=~s|<%missing_parameter%>|ID_category|g;
		return 1;
	}
	
	if (!$env{'before_ID'})
	{
		$XSGN{'TMP'}=$XSGN{'RESULT_failure_no_input'};
		$XSGN{'TMP'}=~s|<%missing_parameter%>|before_ID|g;
		return 1;
	}
	
#	$env{'ID_category'}=58;
#	$env{'ID'}=41605;
#	$env{'before_ID'}=42339;
	
	# get info about $env{'ID'}
	my $sql=qq{
		SELECT
			*
		FROM
			`$App::501::db_name`.a501_image_view
		WHERE
			ID_category=$env{'ID_category'} AND
			ID_format=$App::501::image_format_original_ID AND
			ID_image=$env{'ID'} AND
			status IN ('Y','N','L')
		LIMIT 1
	};
	my %sth0=TOM::Database::SQL::execute($sql);
	my %db0_line=$sth0{'sth'}->fetchhash();
	$env{'ID_attrs'}=$db0_line{'ID_attrs'};
	
	my %image_attrs;
	
	my @order;
	
	my $order_id;
	my $sql=qq{
		SELECT
			*
		FROM
			`$App::501::db_name`.a501_image_view
		WHERE
			ID_category=$env{'ID_category'} AND
			ID_format=$App::501::image_format_original_ID AND
			status IN ('Y','N','L')
		ORDER BY
			order_id ASC, datetime_create DESC
		LIMIT 500
	};
	my $last_ID;
	my %sth0=TOM::Database::SQL::execute($sql);
	
	if ($sth0{'rows'} == 500)
	{
		# you are crazy? :)
		return 1;
	}
	
	while (my %db0_line=$sth0{'sth'}->fetchhash())
	{
		
		main::_log("ID=$env{'ID'} ID_image=$db0_line{'ID_image'} ID_attrs=$db0_line{'ID_attrs'} order_id='$db0_line{'order_id'}'");
		
		$image_attrs{$db0_line{'ID_attrs'}}=$db0_line{'order_id'};
		
		next if $db0_line{'ID_image'} eq $env{'ID'};
		
		if ($db0_line{'ID_image'} eq $env{'before_ID'})
		{
			# move to this position
			main::_log("(before) setup ID_attrs=$env{'ID_attrs'} order_id=$order_id");
			
			push @order, $env{'ID_attrs'};
		}
		
		push @order, $db0_line{'ID_attrs'};
	}
	
	my $tr=new TOM::Database::SQL::transaction('db_h'=>"main");
	my $order_id;
	foreach my $ID_attrs(@order)
	{
		$order_id++;
		main::_log("ID_attrs=$ID_attrs -> $order_id (old=$image_attrs{$ID_attrs})");
		if ($order_id ne $image_attrs{$ID_attrs})
		{
			TOM::Database::SQL::execute(qq{
				UPDATE
					`$App::501::db_name`.a501_image_attrs
				SET
					order_id=$order_id
				WHERE
					ID=$ID_attrs
				LIMIT 1
			},'quiet'=>1);
		}
	}
	$tr->close();
	
	$XSGN{'TMP'}=$XSGN{'RESULT_success'};
	
	return 1;
}


our $authors='open@comsultia.com';

=head1 AUTHORS

Comsultia, Ltd. (open@comsultia.com)

=cut

1;
