#!/usr/bin/perl
# USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use Encode;
use encoding 'utf8';
use utf8;
use strict;
use Digest::MD5  qw(md5 md5_hex md5_base64);

use App::301::_init;

sub execute
{
	my %env=@_;
	Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN
	
	$env{'login'}=$env{'login'} || $main::FORM{'login'} || $main::RPC->{'login'};
	$env{'pass'}=$env{'pass'} || $main::FORM{'pass'} || $main::RPC->{'pass'};
	
	if ((!$env{'login'})||(!$env{'pass'}))
	{
		$XSGN{'TMP'}=$XSGN{'ERR_no-credentials'};
		return 1
	}
	
	# cookies are dissabled
	if ((keys %main::COOKIES_save) == 0)
	{
		$XSGN{'TMP'}=$XSGN{'ERR_cookies'};
		return 1;
	}
	
	my $var;
	
	main::_log("ID_user='$main::USRM{ID_user}' ID_session='$main::USRM{ID_session}' IP='$main::ENV{REMOTE_ADDR}' AGENT='$main::ENV{HTTP_USER_AGENT}'");
	
	
	my $sql=qq{
		SELECT
			*
		FROM
			TOM.a301_user
		WHERE
			login='$env{'login'}' AND
			hostname='$tom::H_cookie' AND
			status='Y'
		LIMIT 1
	};
	my %sth0=TOM::Database::SQL::execute($sql,'quiet'=>1);
	my %user=$sth0{'sth'}->fetchhash();
	if ($user{'login'})
	{
		main::_log("user with login '$env{'login'}' exists");
		my $pass=$user{'pass'};
		if ($pass=~/^MD5:/)
		{
			$env{'pass'}='MD5:'.md5_hex(Encode::encode_utf8($env{'pass'}));
			main::_log("pass='$env{'pass'}'");
		}
		
		if ($pass eq $env{'pass'})
		{
			%main::USRM=%user;
			$var=1;
		}
	}
	else
	{
		main::_log("user with login '$env{'login'}' does not exist");
		$XSGN{'TMP'}=$XSGN{'ERR_no-user'};
		return 1;
	}
	
	
	
	if ($var)
	{
		main::_log("login and password equals");
		
		my %sth0=TOM::Database::SQL::execute(qq{
			SELECT
				*
			FROM
				TOM.a301_user_online_view
			WHERE
				ID_user='$main::USRM{'ID_user'}'
			LIMIT 1
		});
		if (my %user=$sth0{'sth'}->fetchhash())
		{
			main::_log("I'm already online");
			if ($user{'logged'} eq "Y")
			{
				main::_log("I'm online, and logged in, also reset session");
				main::_log("I'm already logged (ID_user='$main::USRM{'ID_user'}')",undef,2);
				
				$main::USRM{'logged'}="Y";
				# just empty
				foreach (keys %main::COOKIES){next if $_ eq "key";$main::COOKIES{$_}=""}; 
				$main::USRM{'ID_session'}=$main::COOKIES{'_ID_session'}=TOM::Utils::vars::genhash(32);
				$main::COOKIES{'_ID_user'}=$main::USRM{'ID_user'};
				
				$main::USRM{'cookies'}=$main::USRM{'saved_cookies'};
				$main::USRM{'session'}=$main::USRM{'saved_session'};
				
				main::_log("login and pass equals, logging again",undef,2);
				
				TOM::Database::SQL::execute(qq{
					UPDATE
						TOM.a301_user_online
					SET
						ID_session='$main::USRM{'ID_session'}',
						domain='$tom::H',
						logged='Y',
						datetime_request=FROM_UNIXTIME($main::time_current),
						IP='$main::ENV{'REMOTE_ADDR'}',
						user_agent='$main::ENV{'HTTP_USER_AGENT'}',
						cookies='$main::USRM{'saved_cookies'}',
						session='$main::USRM{'saved_session'}',
						status='Y'
					WHERE
						ID_user='$main::COOKIES{'_ID_user'}'
					LIMIT 1
				},'quiet'=>1);
				
				$XSGN{'TMP'}=$XSGN{'logged-on'};
				$main::USRM_flag="L";
			}
			else
			{
				main::_log("I'm online, but not logged in");
				
				TOM::Database::SQL::execute(qq{
					UPDATE
						TOM.a301_user_online
					SET
						status='N'
					WHERE
						ID_user='$main::COOKIES{'_ID_user'}'
					LIMIT 1
				},'quiet'=>1);
				$main::USRM{'logged'}="Y";
				foreach (keys %main::COOKIES){$main::COOKIES{$_}=""};
				$main::USRM{'ID_session'}=$main::COOKIES{'_ID_session'}=TOM::Utils::vars::genhash(32);
				$main::COOKIES{'_ID_user'}=$main::USRM{'ID_user'};
				
				$main::USRM{'cookies'}=$main::USRM{'saved_cookies'};
				$main::USRM{'session'}=$main::USRM{'saved_session'};
				
#				my %hash;foreach (sort keys %main::COOKIES){$_=~/^_/ && do {$hash{$_}=$main::COOKIES{$_};next}};
#				$main::USRM{'cookies'}=CVML::structure::serialize(%hash);
				
				TOM::Database::SQL::execute(qq{
					UPDATE
						TOM.a301_user_online
					SET
						ID_session='$main::USRM{'ID_session'}',
						domain='$tom::H',
						logged='Y',
						datetime_login=FROM_UNIXTIME($main::time_current),
						datetime_request=FROM_UNIXTIME($main::time_current),
						IP='$main::ENV{'REMOTE_ADDR'}',
						user_agent='$main::ENV{'HTTP_USER_AGENT'}',
						cookies='$main::USRM{'saved_cookies'}',
						session='$main::USRM{'saved_session'}',
						status='Y'
					WHERE
						ID_user='$main::COOKIES{'_ID_user'}'
					LIMIT 1
				},'quiet'=>1);
				
			}
			
		}
		else # niesom este online (malo pravdepodobny pripad :)))
		# prisiel som k cudziemu pocitacu a logujem sa tam
		{
			main::_log("I'm not online");
			TOM::Database::SQL::execute(qq{
				UPDATE
					TOM.a301_user_online
				SET
					status='N'
				WHERE
					ID_user='$main::COOKIES{'_ID_user'}'
				LIMIT 1
			},'quiet'=>1);
			$main::USRM{'logged'}="Y";
			foreach (keys %main::COOKIES){$main::COOKIES{$_}=""};
			my $cvml=new CVML(data=>$main::USRM{'cookies'});
			%main::COOKIES=%{$cvml->{'hash'}};
			$main::COOKIES{'_ID_session'}=$main::USRM{'ID_session'}=TOM::Utils::vars::genhash(32);
			$main::COOKIES{'_ID_user'}=$main::USRM{'ID_user'};
			
			$main::USRM{'cookies'}=$main::USRM{'saved_cookies'};
			$main::USRM{'session'}=$main::USRM{'saved_session'};
			
#			my %hash;foreach (sort keys %main::COOKIES){$_=~/^_/ && do {$hash{$_}=$main::COOKIES{$_};next}};
#			$main::USRM{'cookies'}=CVML::structure::serialize(%hash);
			
			main::_log("insert user into online table");
			
			TOM::Database::SQL::execute(qq{
				INSERT INTO TOM.a301_user_online
				(
					ID_user,
					ID_session,
					domain,
					logged,
					datetime_login,
					datetime_request,
					requests,
					IP,
					user_agent,
					cookies,
					session
				)
				VALUES
				(
					'$main::COOKIES{_ID_user}',
					'$main::COOKIES{_ID_session}',
					'$tom::H',
					'$main::USRM{logged}',
					FROM_UNIXTIME($main::time_current),
					FROM_UNIXTIME($main::time_current),
					'1',
					'$main::ENV{'REMOTE_ADDR'}',
					'$main::ENV{'HTTP_USER_AGENT'}',
					'$main::USRM{'saved_cookies'}',
					'$main::USRM{'saved_session'}'
				)
			},'quiet'=>1);
			
		}
		
		$XSGN{'TMP'}=$XSGN{'logged-on'};
		$main::USRM_flag="L";
		TOM::Database::SQL::execute(qq{
			UPDATE
				TOM.a301_user
			SET
				datetime_last_login = FROM_UNIXTIME($main::time_current),
				autolog = 'N'
			WHERE
				ID_user='$main::USRM{'ID_user'}'
			LIMIT 1
		},'quiet'=>1);
		
	}
	else
	{
		main::_log("incorrect login/password combination");
		$XSGN{'TMP'}=$XSGN{'ERR_user-pass'};
	}
	
	foreach my $key(keys %main::USRM)
	{
		$XSGN{'TMP'}=~s|<%$key%>|$main::USRM{$key}|g;
	}
	
	main::_log("Logged on='".$main::USRM{'logged'}."'");
	
	if ($main::USRM{'logged'} eq "Y" && $env{'url'})
	{
		$main::location=$env{'url'};
	}
	
	return 1
}


1;
