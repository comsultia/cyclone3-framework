#!/bin/perl
#áéíóú USE UTF-8 !!!
package Tomahawk::module;
use open ':utf8', ':std';
use encoding 'utf8';
use utf8;
$authors="fordinal\@webcom.sk";
use App::24;
use CVML;
use strict;

#our $authors="fordinal\@webcom.sk";

sub execute
{
 my %env=@_;
 Tomahawk::GetXSGN(-convertvars=>1) || return undef; # NATIAHNEM XML DESIGN

 $env{cvml_file}="menu.cvml" unless $env{cvml_file};
 
 open (HNDI,"<".$tom::P."/_data/".$env{'cvml_file'});my $menu;while (my $line=<HNDI>){$menu.=$line};close (HNDI);
 
 # object!!!!!!!
 my $cvml=CVML->new(data=>$menu);
 
 $env{closing}=1;
 $env{opened_parent}="Ringier Slovensko" unless $env{opened_parent};
 
 
# my @arr=App::024::parse_menu(%{$cvml->{hash}});
 
 my $lastlevel;
 my $parent;
 $XSGN{TMP}=~s|<#MENU#>|$XSGN{'LEVEL-PRE-FIRST'}<#MENU#>|;
 foreach my $arr0(App::24::parse_menu(%{$cvml->{hash}}))
 {
	main::_log("mam level:$$arr0{level} name:$$arr0{name}");
	#print "=$arr0\n";
	$parent=$$arr0{name} if $$arr0{level} == 1;
	
	next if (($parent ne $env{opened_parent}) && ($env{closing}) && ($$arr0{level}>1));
	
	main::_log("vykreslujem");
	
	$XSGN{NULL}=$XSGN{LEVEL};
	$XSGN{NULL}=$XSGN{'LEVEL-'.$$arr0{level}} if $XSGN{'LEVEL-'.$$arr0{level}};
	
	if (($lastlevel<$$arr0{level})&&($lastlevel))
	{
		$XSGN{TMP}=~s|<#MENU#>|$XSGN{'LEVEL-PRE'}<#MENU#>|;
	}
	if ($lastlevel>$$arr0{level})
	{
		$XSGN{TMP}=~s|<#MENU#>|$XSGN{'LEVEL-POST'}<#MENU#>|;
	}
#	$XSGN{NULL}=~s|<#SUBMENU#>||g;
	
	foreach (keys %{$arr0})
	{
		$XSGN{NULL}=~s|<%$_%>|$$arr0{$_}|g;
	}
		
	$XSGN{TMP}=~s|<#MENU#>|$XSGN{NULL}<#MENU#>|;
	
	
	$lastlevel=$$arr0{level};
 }
 
 for (1..$lastlevel-1)
 {
 	$XSGN{TMP}=~s|<#MENU#>|$XSGN{'LEVEL-POST'}<#MENU#>|;
 }
 $XSGN{TMP}=~s|<#MENU#>|$XSGN{'LEVEL-POST-LAST'}<#MENU#>|;
 
 
 
 
 
 
 
 
 return 1}

1;
